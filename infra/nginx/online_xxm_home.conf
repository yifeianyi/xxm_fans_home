# HTTP 重定向：统一到 HTTPS + www 域名
server {
	listen 80;
	server_name  admin.xxm8777.cn xxm8777.cn www.xxm8777.cn;

	# Admin 子域名重定向到 HTTPS
	if ($host = "admin.xxm8777.cn") {
		return 301 https://admin.xxm8777.cn$request_uri;
	}

	# 其他域名统一重定向到 https://www.xxm8777.cn
	return 301 https://www.xxm8777.cn$request_uri;
}

# HTTPS 重定向：xxm8777.cn 到 www.xxm8777.cn
server {
	listen 443 ssl;
	server_name xxm8777.cn;

	# SSL 配置
	ssl_certificate /etc/letsencrypt/live/xxm8777.cn-0001/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/xxm8777.cn-0001/privkey.pem;
	ssl_session_cache shared:SSL:10m;
	ssl_session_timeout 10m;

	# 重定向到 www 域名，避免 CDN 缓存不一致
	return 301 https://www.xxm8777.cn$request_uri;
}

# 管理页面 - Admin 后台
server {
	listen 443 ssl;
	server_name admin.xxm8777.cn;

	client_max_body_size 10M;

	# SSL 配置 - 使用 Let's Encrypt 证书
	ssl_certificate /etc/letsencrypt/live/admin.xxm8777.cn/fullchain.pem; # managed by Certbot
	ssl_certificate_key /etc/letsencrypt/live/admin.xxm8777.cn/privkey.pem; # managed by Certbot
	ssl_session_cache shared:SSL:10m;
	ssl_session_timeout 10m;

	# 安全头
	add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
	add_header X-Content-Type-Options nosniff always;
	add_header X-Frame-Options "SAMEORIGIN" always;
	add_header X-XSS-Protection "1; mode=block" always;

	# Django Admin 和 API
	location / {
		proxy_pass http://127.0.0.1:8000;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		# Cookie 和 Session 支持
		proxy_cookie_path / /;
		proxy_redirect off;

		# 超时配置
		proxy_connect_timeout 60s;
		proxy_send_timeout 60s;
		proxy_read_timeout 120s;
	}

	# 静态文件
	location /static/ {
		alias /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/staticfiles/;
		expires 30d;
		add_header Cache-Control "public, immutable";
		access_log off;
	}

	# 封面图片
	location /covers/ {
		alias /home/yifeianyi/Desktop/xxm_fans_home/media/covers/;
		autoindex off;
		expires 30d;
		add_header Cache-Control "public, immutable";
	}

	# 二创图片资源
	location /footprint/ {
		alias /home/yifeianyi/Desktop/xxm_fans_home/media/footprint/;
		autoindex off;
		expires 30d;
		add_header Cache-Control "public, immutable";
	}

	# 图集图片（使用 /media/gallery/ 路径，与前端路由 /gallery/ 完全分离）
	location /media/gallery/ {
		alias /home/yifeianyi/Desktop/xxm_fans_home/media/gallery/;
		autoindex off;
		expires 30d;
		add_header Cache-Control "public, immutable";
	}
	# /gallery/ 完全由前端路由处理（通过主 location 的 try_files）

	# 媒体文件
	location /media/ {
		alias /home/yifeianyi/Desktop/xxm_fans_home/media/;
		expires 30d;
		add_header Cache-Control "public, immutable";
	}
}

# 主 HTTPS 服务器 - 前端网站（仅 www 域名）
server {
	listen 443 ssl;
	server_name www.xxm8777.cn;

	# SSL 配置 - 使用 Let's Encrypt 证书
	ssl_certificate /etc/letsencrypt/live/xxm8777.cn-0001/fullchain.pem; # managed by Certbot
	ssl_certificate_key /etc/letsencrypt/live/xxm8777.cn-0001/privkey.pem; # managed by Certbot
	ssl_session_cache shared:SSL:10m;
	ssl_session_timeout 10m;

	# 安全头
	add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
	add_header X-Content-Type-Options nosniff always;
	add_header X-Frame-Options "SAMEORIGIN" always;
	add_header X-XSS-Protection "1; mode=block" always;

	root /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_frontend/dist;
	index index.html;
	client_max_body_size 3M;

	# 前端静态文件（支持 React Router）
	location / {
		try_files $uri $uri/ /index.html;
		expires 1h;
		add_header Cache-Control "public, must-revalidate";
	}

	# SEO 文件 - 动态生成，转发到 Django
	location = /sitemap.xml {
		proxy_pass http://127.0.0.1:8000;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		# Cookie 和 Session 支持
		proxy_cookie_path / /;
		proxy_redirect off;

		# 超时配置
		proxy_connect_timeout 60s;
		proxy_send_timeout 60s;
		proxy_read_timeout 120s;
	}
	location = /robots.txt {
		proxy_pass http://127.0.0.1:8000;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		# Cookie 和 Session 支持
		proxy_cookie_path / /;
		proxy_redirect off;

		# 超时配置
		proxy_connect_timeout 60s;
		proxy_send_timeout 60s;
		proxy_read_timeout 120s;
	}

	# Django API
	location /api/ {
		proxy_pass http://127.0.0.1:8000;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		# Cookie 和 Session 支持
		proxy_cookie_path / /;
		proxy_redirect off;

		# 超时配置
		proxy_connect_timeout 60s;
		proxy_send_timeout 60s;
		proxy_read_timeout 120s;
	}

	# Admin 访问限制（主站禁止访问 Admin）
	location /admin/ {
		return 403;
	}

	# 静态文件
	location /static/ {
		alias /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/staticfiles/;
		expires 30d;
		add_header Cache-Control "public, immutable";
		access_log off;
	}

	# 封面图片
	location /covers/ {
		alias /home/yifeianyi/Desktop/xxm_fans_home/media/covers/;
		autoindex off;
		expires 30d;
		add_header Cache-Control "public, immutable";
	}

	# 二创图片资源
	location /footprint/ {
		alias /home/yifeianyi/Desktop/xxm_fans_home/media/footprint/;
		autoindex off;
		expires 30d;
		add_header Cache-Control "public, immutable";
	}

	# 媒体文件
	location /media/ {
		alias /home/yifeianyi/Desktop/xxm_fans_home/media/;
		expires 30d;
		add_header Cache-Control "public, immutable";
	}
}






