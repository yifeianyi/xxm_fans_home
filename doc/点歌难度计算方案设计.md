# 小满虫之家点歌难度计算方案设计 v2.0

## 一、方案概述

为咻咻满（小满虫之家）歌单系统设计实时点歌难度参考值，帮助粉丝评估点歌成功概率，优化点歌策略。

### 1.1 难度等级体系

采用六档分级制，每档对应不同的点歌策略：

| 等级 | 颜色标识 | 难度描述 | 点歌建议 | 预估成功率 |
|------|----------|----------|----------|------------|
| **C** | 🟢 翠绿 | 极易 | 随时可点，放心大胆的冲 | 90-100% |
| **B** | 🟢 青绿 | 容易 | 正常点歌，大概率成功 | 70-89% |
| **A** | 🔵 蔚蓝 | 中等 | 选择合适时机，成功率看缘分 | 50-69% |
| **S** | 🟠 橙黄 | 困难 | 需要特定条件或满子状态好 | 30-49% |
| **SS** | 🔴 深红 | 极难 | 罕见演唱，需要运气加成 | 10-29% |
| **SSS** | 🟣 紫晶 | 传说 | 几乎不唱，点了就是信仰 | 0-9% |

### 1.2 核心设计理念

1. **动态平衡**: 难度值不是固定的，会根据演唱历史实时变化
2. **多因子加权**: 综合考虑歌曲本身特性和演唱历史
3. **可解释性**: 每个难度值都能拆解说明原因
4. **人工干预**: 管理员可以微调算法参数或直接覆盖结果

---

## 二、影响因子详解

### 2.1 歌曲基础难度 (Base Difficulty)

**权重: 25%**

描述歌曲本身的客观演唱难度，包括音域、技巧、情感表达等。

#### 评级标准

| 等级 | 分值 | 音域要求 | 技巧复杂度 | 情感深度 | 示例参考 |
|------|------|----------|------------|----------|----------|
| 1 | 20 | 中音区为主 | 基础技巧 | 轻松欢快 | 《小幸运》《告白气球》 |
| 2 | 40 | 少量高音 | 真假音切换 | 温暖治愈 | 《后来》《遇见》 |
| 3 | 60 | 较高音域 | 气息控制 | 情感投入 | 《如愿》《大鱼》 |
| 4 | 80 | 宽音域 | 高难度技巧 | 情感爆发 | 《九儿》《左手指月》 |
| 5 | 100 | 极限音域 | 多种技巧组合 | 深刻演绎 | 《歌剧2》《第五元素》 |

#### 评分细则

- **音域跨度**: 每超过一个八度 +10分
- **持续高音**: 持续C5以上 +15分
- **真假音切换**: 频繁切换 +10分
- **气息难度**: 长句无换气点 +10分
- **情感难度**: 需要特定情绪状态 +10分

#### 基础分计算
```
base_score = difficulty_level × 20
```

---

### 2.2 近期演唱频次 (Recent Frequency)

**权重: 30%**

统计最近 30 天内演唱次数，反映歌曲的"疲劳度"和"新鲜感"。

#### 疲劳度系数表

| 30天内次数 | 疲劳等级 | 系数 | 心理模型 |
|------------|----------|------|----------|
| 0 | 新鲜感 | 0.6 | "好久没唱，可以唱了" |
| 1 | 正常 | 0.8 | "正常发挥" |
| 2 | 略频繁 | 1.0 | "刚唱过，还行" |
| 3-4 | 较频繁 | 1.3 | "唱得有点多了" |
| 5-7 | 频繁 | 1.6 | "最近经常唱，有点腻" |
| 8-10 | 高频 | 2.0 | "唱太多次了，换一首吧" |
| >10 | 超频 | 2.5 | "真不想唱了" |

#### 频次分计算
```
frequency_score = 50 × fatigue_factor
```

#### 特殊处理

- **新入歌曲**（首次演唱<30天）：系数按1.2计算
- **长期未唱**（上次演唱>90天）：系数额外-0.1，最低0.5
- **近期热门**：如果这首歌在全网/粉丝圈很火，系数-0.2

---

### 2.3 历史演唱总次数 (Total Performance)

**权重: 15%**

历史累计演唱次数，反映歌曲的"稀有度"和"熟练度"。

#### 稀有度系数表

| 总次数 | 稀有等级 | 系数 | 说明 |
|--------|----------|------|------|
| 0 | 未解锁 | 3.0 | 从未唱过，充满未知 |
| 1-3 | 传说级 | 2.5 | 只唱过极少数次 |
| 4-10 | 稀有 | 2.0 | 很少唱，难得一见 |
| 11-25 | 珍贵 | 1.5 | 偶尔唱，比较珍贵 |
| 26-50 | 常见 | 1.2 | 正常范围 |
| 51-100 | 熟练 | 1.0 | 经常唱，驾轻就熟 |
| >100 | 招牌 | 0.8 | 招牌曲目，随时可点 |

#### 熟练度加成

当演唱次数达到熟练级别后，会产生熟练度加成：
- 51-75次：难度-5%
- 76-100次：难度-10%
- >100次：难度-15%

#### 稀有度分计算
```
rarity_score = 30 × rarity_factor × (1 - proficiency_bonus)
```

---

### 2.4 距离上次演唱时间 (Recency)

**权重: 20%**

计算距离上次演唱的天数，反映歌曲的"冷却状态"。

#### 冷却系数表

| 天数 | 冷却状态 | 系数 | 满子心理 |
|------|----------|------|----------|
| 0-1 | 热乎 | 2.2 | "昨天刚唱，今天真不想唱" |
| 2-3 | 温热 | 1.8 | "前几天唱过，还差点意思" |
| 4-7 | 微凉 | 1.4 | "上周唱过，可以回味一下" |
| 8-14 | 常温 | 1.1 | "半个月了，差不多可以了" |
| 15-30 | 冷却 | 0.9 | "一个月没唱，手痒了" |
| 31-60 | 冷藏 | 0.7 | "好久不唱，挺想唱的" |
| 61-90 | 冷冻 | 0.6 | "都快忘了这歌怎么唱了" |
| >90 | 冰封 | 0.5 | "这是什么歌？没听过" |
| 从未 | 未知 | 2.8 | "不知道会不会唱" |

#### 连续演唱惩罚

如果检测到连续多天演唱同一首歌：
- 连续2天：系数额外+0.3
- 连续3天及以上：系数额外+0.6

#### 冷却分计算
```
recency_score = 40 × cooldown_factor + consecutive_penalty
```

---

### 2.5 满子喜爱度 (Preference)

**权重: 10%**

反映满子本人对这首歌曲的主观喜爱程度。

#### 喜爱度等级

| 等级 | 分值 | 系数 | 典型表现 |
|------|------|------|----------|
| 5 | 非常喜欢 | 0.7 | "好爱这首歌，想唱！" |
| 4 | 比较喜欢 | 0.85 | "这歌不错，可以考虑" |
| 3 | 一般 | 1.0 | "还行吧，看情况" |
| 2 | 不太喜欢 | 1.3 | "不太想唱这歌" |
| 1 | 不喜欢 | 1.5 | "真的不想唱这个" |

#### 喜爱度判定依据

1. **主动演唱频率**：主动点的次数占比
2. **演唱投入度**：演唱时的情感投入、技巧发挥
3. **粉丝反馈**：粉丝评价中满子的回应态度
4. **公开场合提及**：是否在直播/动态中表达过喜好

#### 喜爱度分计算
```
preference_score = 20 × preference_factor
```

---

### 2.6 魔法期特殊状态 (Magic Period)

**动态全局系数: 1.0-2.0**

特殊时期（如满子状态不佳、有特殊安排等）的整体难度调整。

#### 魔法期类型

| 类型 | 系数 | 说明 |
|------|------|------|
| 正常状态 | 1.0 | 常规难度计算 |
| 轻度魔法期 | 1.3 | 嗓子略疲劳，高音困难 |
| 中度魔法期 | 1.6 | 身体不适，只唱简单的 |
| 重度魔法期 | 2.0 | 几乎不唱，点歌需谨慎 |

#### 魔法期叠加规则

- 基础魔法期系数 × 歌曲难度系数的乘积
- 如果歌曲本身难度高（>=4），额外+0.2
- 如果歌曲需要高音，额外+0.3

---

## 三、综合计算模型

### 3.1 基础难度公式

```
D_base = (B × 0.25) + (F × 0.30) + (R × 0.15) + (C × 0.20) + (P × 0.10)

其中:
B = base_score (基础难度分, 0-100)
F = frequency_score (频次分, 0-125)
R = rarity_score (稀有度分, 0-90)
C = recency_score (冷却分, 0-100)
P = preference_score (喜爱度分, 0-30)
```

### 3.2 实时难度公式

```
D_realtime = D_base × M × S

其中:
M = magic_period_multiplier (魔法期系数, 1.0-2.0)
S = seasonal_factor (季节/时段系数, 0.8-1.2)
```

### 3.3 难度等级映射

```
if D_realtime ≤ 20:      Level = C   (极易)
elif D_realtime ≤ 35:    Level = B   (容易)
elif D_realtime ≤ 55:    Level = A   (中等)
elif D_realtime ≤ 75:    Level = S   (困难)
elif D_realtime ≤ 100:   Level = SS  (极难)
else:                    Level = SSS (传说)
```

### 3.4 计算示例

**示例1：热门常唱歌曲《如愿》**
- 基础难度: 4级 = 80分
- 近30天唱过: 3次 → 疲劳系数1.3 → 频次分65
- 历史共唱: 25次 → 稀有系数1.5 → 稀有度分45
- 上次演唱: 5天前 → 冷却系数1.4 → 冷却分56
- 喜爱度: 4级 → 系数0.85 → 喜爱度分17
- 魔法期: 否 → 系数1.0

计算：
```
D_base = 80×0.25 + 65×0.30 + 45×0.15 + 56×0.20 + 17×0.10
       = 20 + 19.5 + 6.75 + 11.2 + 1.7
       = 59.15

D_realtime = 59.15 × 1.0 = 59.15 → Level A (中等)
```

**示例2：冷门高难度歌曲《左手指月》**
- 基础难度: 5级 = 100分
- 近30天唱过: 0次 → 疲劳系数0.6 → 频次分30
- 历史共唱: 2次 → 稀有系数2.5 → 稀有度分75
- 上次演唱: 45天前 → 冷却系数0.7 → 冷却分28
- 喜爱度: 3级 → 系数1.0 → 喜爱度分20
- 魔法期: 轻度 → 系数1.3

计算：
```
D_base = 100×0.25 + 30×0.30 + 75×0.15 + 28×0.20 + 20×0.10
       = 25 + 9 + 11.25 + 5.6 + 2
       = 52.85

D_realtime = 52.85 × 1.3 = 68.7 → Level A (中等)
```

**示例3：超高难度从未演唱歌曲**
- 基础难度: 5级 = 100分
- 近30天唱过: 0次 → 频次分30
- 历史共唱: 0次 → 稀有系数3.0 → 稀有度分90
- 上次演唱: 从未 → 冷却系数2.8 → 冷却分100
- 喜爱度: 2级 → 系数1.3 → 喜爱度分26
- 魔法期: 重度 → 系数2.0

计算：
```
D_base = 100×0.25 + 30×0.30 + 90×0.15 + 100×0.20 + 26×0.10
       = 25 + 9 + 13.5 + 20 + 2.6
       = 70.1

D_realtime = 70.1 × 2.0 = 140.2 → Level SSS (传说)
```

---

## 四、动态调整机制

### 4.1 时间衰减因子

某些因子的影响会随时间衰减：

```
衰减因子 = e^(-λ × Δt)

其中:
λ = 衰减速率 (默认 0.05/天)
Δt = 距离上次更新的天数
```

### 4.2 演唱事件触发更新

每次演唱后，相关歌曲的难度值实时重算：

1. **演唱的歌曲**: 
   - 频次分上升（疲劳度增加）
   - 冷却分归零（重新开始冷却）
   - 总次数+1（可能触发熟练度加成）

2. **同类型歌曲**:
   - 同曲风歌曲频次分轻微上升 (+5%)
   - 同难度歌曲稀有度分轻微调整

3. **其他歌曲**:
   - 冷却分按时间衰减

### 4.3 节假日特殊规则

| 场景 | 调整规则 |
|------|----------|
| 满子生日 | 所有歌曲难度-20%，喜爱度+1级 |
| 重大节日 | 喜庆歌曲难度-15% |
| 粉丝团活动 | 指定歌曲难度-30% |
| 满子emo时 | 伤感歌曲难度-20%，快歌难度+20% |

### 4.4 点歌反馈学习

收集点歌结果反馈，优化算法：

```
如果 点了某歌且唱了:
    该歌难度分 × 0.95 (降低难度预估)
如果 点了某歌但没唱:
    该歌难度分 × 1.05 (提高难度预估)
```

学习系数每首歌独立计算，上限±20%。

---

## 五、特殊情况处理

### 5.1 新歌曲处理

对于新增到歌单的歌曲：

```
初始难度 = 基础难度 × 1.5

前3次演唱后，根据实际演唱情况调整:
- 如果3次都唱了: 难度降低至正常计算值
- 如果1-2次唱了: 保持当前难度
- 如果都没唱: 难度提升20%
```

### 5.2 回归歌曲处理

对于很久没唱突然回归的歌曲：

```
回归加成 = min(30, 回归天数/10)%

难度 = 正常计算值 × (1 - 回归加成)
```

### 5.3 粉丝点歌密度

统计单位时间内粉丝点歌请求：

```
如果 点歌密度 > 阈值:
    所有歌曲难度 × 1.1 (满子选择困难)
    
如果 某歌被点次数 > 3次/小时:
    该歌难度 × 1.2 (被点太多，逆反心理)
```

### 5.4 连唱惩罚

如果满子已经连续唱了很多首歌：

```
连唱惩罚 = min(50%, 已唱歌曲数 × 5%)

所有歌曲难度 × (1 + 连唱惩罚)
```

---

## 六、算法参数配置

### 6.1 可配置参数表

| 参数名 | 默认值 | 范围 | 说明 |
|--------|--------|------|------|
| WEIGHT_BASE | 0.25 | 0.1-0.5 | 基础难度权重 |
| WEIGHT_FREQUENCY | 0.30 | 0.1-0.5 | 频次权重 |
| WEIGHT_RARITY | 0.15 | 0.1-0.3 | 稀有度权重 |
| WEIGHT_RECENCY | 0.20 | 0.1-0.4 | 冷却度权重 |
| WEIGHT_PREFERENCE | 0.10 | 0.05-0.2 | 喜爱度权重 |
| MAGIC_MULTIPLIER | 1.5 | 1.0-3.0 | 魔法期倍数 |
| FRESH_PERIOD | 30 | 7-90 | 新鲜度统计天数 |
| COOLDOWN_DECAY | 0.05 | 0.01-0.1 | 冷却衰减速率 |

### 6.2 参数调整建议

| 场景 | 调整建议 |
|------|----------|
| 想降低历史影响 | 降低 WEIGHT_RARITY，提高 WEIGHT_RECENCY |
| 想更关注满子状态 | 提高 WEIGHT_PREFERENCE |
| 频繁演唱时 | 降低 WEIGHT_FREQUENCY |
| 长期规划 | 提高 FRESH_PERIOD |

---

## 七、输出结果说明

### 7.1 难度值输出

```json
{
  "difficulty": {
    "level": "A",
    "score": 58.5,
    "max_score": 100,
    "success_rate": "55-65%",
    "suggestion": "选择合适时机，成功率中等"
  }
}
```

### 7.2 因子分解输出

```json
{
  "breakdown": {
    "base": {"score": 20, "contribution": "25.0%"},
    "frequency": {"score": 19.5, "contribution": "24.8%"},
    "rarity": {"score": 6.75, "contribution": "8.6%"},
    "recency": {"score": 11.2, "contribution": "14.2%"},
    "preference": {"score": 1.7, "contribution": "2.2%"},
    "magic": {"multiplier": 1.0, "contribution": "0%"}
  }
}
```

### 7.3 点歌建议生成

基于各因子生成智能建议：

| 因子状态 | 建议内容 |
|----------|----------|
| 频次过高 | "这首歌最近唱得有点多，可以缓缓" |
| 冷却足够 | "好久不唱，点这首成功率不错" |
| 难度过高+魔法期 | "高难度+魔法期，建议换一首" |
| 喜爱度高 | "满子挺喜欢这首，可以试试" |
| 从未演唱 | "从未唱过，点歌需谨慎" |

---

## 八、实施检查清单

### 8.1 数据准备
- [ ] 为每首歌设置基础难度等级
- [ ] 为每首歌设置喜爱度等级
- [ ] 配置魔法期开关和系数
- [ ] 导入历史演唱记录数据

### 8.2 算法验证
- [ ] 验证热门歌曲计算结果合理
- [ ] 验证冷门歌曲计算结果合理
- [ ] 验证新歌曲初始难度适中
- [ ] 测试魔法期调整效果

### 8.3 反馈收集
- [ ] 收集粉丝对难度等级的反馈
- [ ] 收集点歌成功率数据
- [ ] 定期校准算法参数

---

## 九、附录：参考算法

### 9.1 完整计算流程图

```
输入: 歌曲ID
  │
  ▼
获取歌曲基础信息
  │
  ├─► 基础难度 (B)
  │
  ▼
获取演唱历史数据
  │
  ├─► 近30天次数 → 频次分 (F)
  ├─► 总次数 → 稀有度分 (R)
  └─► 上次演唱时间 → 冷却分 (C)
  │
  ▼
获取喜爱度配置 → 喜爱度分 (P)
  │
  ▼
获取全局状态
  │
  ├─► 魔法期系数 (M)
  └─► 时段系数 (S)
  │
  ▼
计算: D = (B×0.25 + F×0.30 + R×0.15 + C×0.20 + P×0.10) × M × S
  │
  ▼
映射到等级 (C/B/A/S/SS/SSS)
  │
  ▼
生成建议和解释
  │
  ▼
输出: 难度等级、分数、建议
```

### 9.2 系数速查表

| 输入值 | 疲劳系数 | 稀有系数 | 冷却系数 | 喜爱系数 |
|--------|----------|----------|----------|----------|
| 0/从未 | - | 3.0 | 2.8(从未)/0.5(90天+) | - |
| 1 | - | 2.5 | 2.2 | 1.5 |
| 2 | 1.0 | 2.0 | 1.8 | 1.3 |
| 3 | 1.3 | 1.5 | 1.4 | 1.0 |
| 4 | 1.3 | 1.5 | 1.1 | - |
| 5 | 1.6 | 1.2 | 0.9 | 0.85 |
| 6-7 | 1.6 | 1.2 | 0.7 | - |
| 8-10 | 2.0 | 1.0 | 0.6 | - |
| >10 | 2.5 | 0.8 | - | 0.7 |
