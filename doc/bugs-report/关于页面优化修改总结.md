# 关于页面优化修改总结

## 修改日期
2026-01-25

## 修改概述
本次修改主要针对"关于"页面进行了多项优化，包括字段重命名、显示逻辑修复、图片上传功能修复以及新增社交媒体平台。

---

## 一、修改内容详情

### 1. Admin 表单优化 - 爱好改为职业

#### 修改文件
- `repo/xxm_fans_backend/site_settings/models/settings.py`
- `repo/xxm_fans_backend/site_settings/admin.py`

#### 修改内容
- 将 `artist_hobbies` 字段重命名为 `artist_profession`
- `verbose_name` 从"爱好"改为"职业"
- Admin 表单字段更新，支持逗号分隔的文本输入（无需 JSON 格式）
- 默认值从"唱歌、集星、发呆"改为"歌手、音乐主播、唱见"

#### 数据库迁移
- 迁移文件：`site_settings/migrations/0004_alter_milestone_options_and_more.py`
- 删除旧的 `artist_hobbies` 字段
- 添加新的 `artist_profession` 字段

---

### 2. 图片上传功能修复

#### 问题分析
- 图片上传功能本身正常，但路径配置不一致
- 实际文件保存在 `repo/xxm_fans_backend/media/`
- 但 Django 配置的 `MEDIA_ROOT` 指向该目录
- 项目设计应使用根目录的 `media/` 作为统一存储位置

#### 解决方案
创建软链接，将 `repo/xxm_fans_backend/media` 指向项目根目录的 `media`：

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
rm -rf media
ln -s ../../media media
```

#### 验证
```bash
ls -la /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/ | grep media
# 输出: lrwxrwxrwx  1 yifeianyi yifeianyi    11 Jan 25 22:07 media -> ../../media
```

---

### 3. 前端声线特色显示修复

#### 问题
声线特色所有 feature 显示在一个卡片中，而不是每个 feature 一个独立卡片

#### 修改文件
- `repo/xxm_fans_frontend/presentation/pages/AboutPage.tsx`

#### 修改内容
- 移除硬编码的描述文本
- 根据后端返回的实际 `artist_voice_features` 数组动态生成卡片
- 定义6种颜色配置，循环使用
- 支持任意数量的声线特点，不再限制为4个

#### 修改前代码
```typescript
const voiceColors = [
    { name: voiceFeatures[0] || '戏韵', desc: '惊艳全场的戏腔，丝滑转换', color: 'bg-red-50 text-red-500' },
    { name: voiceFeatures[1] || '治愈', desc: '温柔如水的低语，抚平焦虑', color: 'bg-green-50 text-green-600' },
    { name: voiceFeatures[2] || '张力', desc: '爆发力十足的摇滚与情感', color: 'bg-orange-50 text-orange-500' },
    { name: voiceFeatures[3] || '灵动', desc: '俏皮可爱的萝莉与少年感', color: 'bg-blue-50 text-blue-500' },
];
```

#### 修改后代码
```typescript
const colorConfigs = [
    { color: 'bg-red-50 text-red-500', bg: 'bg-red-50', text: 'text-red-500' },
    { color: 'bg-green-50 text-green-600', bg: 'bg-green-50', text: 'text-green-600' },
    { color: 'bg-orange-50 text-orange-500', bg: 'bg-orange-50', text: 'text-orange-500' },
    { color: 'bg-blue-50 text-blue-500', bg: 'bg-blue-50', text: 'text-blue-500' },
    { color: 'bg-purple-50 text-purple-500', bg: 'bg-purple-50', text: 'text-purple-500' },
    { color: 'bg-pink-50 text-pink-500', bg: 'bg-pink-50', text: 'text-pink-500' },
];

const voiceCards = voiceFeatures.map((feature, index) => {
    const colorConfig = colorConfigs[index % colorConfigs.length];
    return {
        name: feature,
        color: colorConfig.color,
    };
});
```

---

### 4. Admin 配置修复

#### 问题
1. 没有添加按钮（`has_add_permission` 限制了只能创建一个网站设置）
2. 编辑时显示错误（数据格式问题和表单初始化问题）

#### 修改文件
- `repo/xxm_fans_backend/site_settings/admin.py`

#### 修改内容
- 移除 `has_add_permission` 方法，允许正常添加
- 修复表单 `__init__` 方法，正确处理空列表情况
- 使用 `is not None` 而不是依赖真值检查

#### 修改前代码
```python
def __init__(self, *args, **kwargs):
    super().__init__(*args, **kwargs)
    if self.instance and self.instance.pk:
        if self.instance.artist_profession:
            self.fields['artist_profession'].initial = ', '.join(self.instance.artist_profession)
        if self.instance.artist_voice_features:
            self.fields['artist_voice_features'].initial = ', '.join(self.instance.artist_voice_features)
```

#### 修改后代码
```python
def __init__(self, *args, **kwargs):
    super().__init__(*args, **kwargs)
    if self.instance and self.instance.pk:
        if self.instance.artist_profession is not None:
            self.fields['artist_profession'].initial = ', '.join(self.instance.artist_profession) if self.instance.artist_profession else ''
        if self.instance.artist_voice_features is not None:
            self.fields['artist_voice_features'].initial = ', '.join(self.instance.artist_voice_features) if self.instance.artist_voice_features else ''
```

---

### 5. Serializer 字段修复

#### 问题
`SiteSettingsSerializer` 的 `fields` 列表中仍包含旧的 `artist_hobbies` 字段，导致序列化时出错

#### 修改文件
- `repo/xxm_fans_backend/site_settings/api/serializers.py`

#### 修改内容
将 `artist_hobbies` 改为 `artist_profession`

---

### 6. 新增社交媒体平台

#### 修改文件
- `repo/xxm_fans_backend/site_settings/models/settings.py`
- `repo/xxm_fans_backend/site_settings/admin.py`
- `repo/xxm_fans_backend/site_settings/api/serializers.py`
- `repo/xxm_fans_frontend/infrastructure/api/RealSiteSettingsService.ts`
- `repo/xxm_fans_frontend/presentation/pages/AboutPage.tsx`

#### 新增平台
1. **YouTube** - `youtube_url`
2. **QQ音乐** - `qq_music_url`
3. **小红书** - `xiaohongshu_url`

#### 前端显示配置
- YouTube: 红色背景 (`bg-[#ff0000]`)，使用 ExternalLink 图标
- QQ音乐: 绿色背景 (`bg-[#31c27c]`)，使用 Music 图标
- 小红书: 红色背景 (`bg-[#ff2442]`)，使用 Heart 图标

#### 数据库迁移
- 迁移文件：`site_settings/migrations/0005_sitesettings_qq_music_url_and_more.py`
- 添加三个新字段到 `SiteSettings` 模型

---

## 二、前端类型定义更新

### 修改文件
- `repo/xxm_fans_frontend/infrastructure/api/RealSiteSettingsService.ts`

### 修改内容
```typescript
export interface SiteSettings {
  id: number;
  favicon?: string;
  favicon_url?: string;
  artist_name?: string;
  artist_avatar?: string;
  artist_avatar_url?: string;
  artist_birthday?: string;
  artist_constellation?: string;
  artist_location?: string;
  artist_profession?: string[];  // 从 artist_hobbies 改为 artist_profession
  artist_voice_features?: string[];
  bilibili_url?: string;
  weibo_url?: string;
  netease_music_url?: string;
  youtube_url?: string;         // 新增
  qq_music_url?: string;        // 新增
  xiaohongshu_url?: string;     // 新增
  created_at: string;
  updated_at: string;
}
```

---

## 三、前端页面更新

### 修改文件
- `repo/xxm_fans_frontend/presentation/pages/AboutPage.tsx`

### 主要修改
1. 基础信息中"爱好"改为"职业"
2. 声线特色动态生成卡片
3. 新增三个社交媒体平台

### 社交媒体平台列表
```typescript
{[
    { name: 'Bilibili', color: 'bg-[#00aeec]', icon: <Waves size={20} />, url: siteSettings?.bilibili_url || 'https://space.bilibili.com/343272' },
    { name: '新浪微博', color: 'bg-[#e6162d]', icon: <Camera size={20} />, url: siteSettings?.weibo_url || '#' },
    { name: '网易云音乐', color: 'bg-[#ff1d12]', icon: <Music size={20} />, url: siteSettings?.netease_music_url || '#' },
    { name: 'YouTube', color: 'bg-[#ff0000]', icon: <ExternalLink size={20} />, url: siteSettings?.youtube_url || '#' },
    { name: 'QQ音乐', color: 'bg-[#31c27c]', icon: <Music size={20} />, url: siteSettings?.qq_music_url || '#' },
    { name: '小红书', color: 'bg-[#ff2442]', icon: <Heart size={20} />, url: siteSettings?.xiaohongshu_url || '#' },
].map((s, i) => (
    // 渲染逻辑
))}
```

---

## 四、数据修复

### 问题
数据库中 `artist_voice_features` 字段存储了错误的数据格式 `['[]']`

### 修复命令
```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
python3 manage.py shell -c "from site_settings.models import SiteSettings; settings = SiteSettings.objects.first(); settings.artist_profession = []; settings.artist_voice_features = []; settings.save(); print('Fixed!')"
```

---

## 五、重新部署到环境的步骤

### 1. 停止服务

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/scripts
./dev_stop_services.sh
```

### 2. 拉取最新代码

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home
git pull origin main
```

### 3. 更新子模块

```bash
git submodule update --init --recursive
```

### 4. 创建软链接（如果不存在）

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/scripts
./create_symlinks.sh
```

### 5. 创建 media 软链接

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
# 检查是否已存在软链接
if [ -L media ]; then
    echo "media 软链接已存在"
else
    rm -rf media
    ln -s ../../media media
    echo "media 软链接已创建"
fi
```

### 6. 应用数据库迁移

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
python3 manage.py migrate
```

### 7. 收集静态文件（生产环境）

```bash
python3 manage.py collectstatic --noinput
```

### 8. 重新构建前端（生产环境）

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_frontend
npm install
npm run build
```

### 9. 启动服务

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/scripts
./dev_start_services.sh
```

### 10. 验证部署

访问以下地址验证功能是否正常：
- 前端：http://localhost:8080/
- 后端 API：http://localhost:8080/api/
- Admin：http://localhost:8080/admin/

检查项：
- [ ] 关于页面正常显示
- [ ] "职业"字段正确显示
- [ ] 声线特色每个 feature 独立显示
- [ ] 6个社交媒体平台正常显示
- [ ] Admin 可以正常编辑网站设置
- [ ] 图片上传功能正常

---

## 六、注意事项

### 1. 软链接配置
确保以下软链接正确创建：
- `repo/xxm_fans_backend/.env -> env/backend.env`
- `repo/xxm_fans_frontend/.env -> env/frontend.env`
- `repo/xxm_fans_backend/media -> ../../media`

### 2. 数据迁移
本次修改包含两个数据库迁移：
- `0004_alter_milestone_options_and_more.py` - 字段重命名
- `0005_sitesettings_qq_music_url_and_more.py` - 新增社交媒体字段

### 3. 环境变量
确保 `.env` 文件配置正确，特别是数据库连接信息。

### 4. 权限问题
如果使用生产环境部署脚本，可能需要 root 权限创建基础设施软链接：
```bash
sudo ./create_infra_symlinks.sh
```

### 5. 数据备份
在应用数据库迁移前，建议先备份数据库：
```bash
cp /home/yifeianyi/Desktop/xxm_fans_home/data/db.sqlite3 /home/yifeianyi/Desktop/xxm_fans_home/backup/db.sqlite3.backup
```

---

## 七、回滚方案

如果部署后出现问题，可以按以下步骤回滚：

### 1. 停止服务
```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/scripts
./dev_stop_services.sh
```

### 2. 回滚代码
```bash
cd /home/yifeianyi/Desktop/xxm_fans_home
git reset --hard HEAD~1
```

### 3. 回滚数据库迁移
```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
python3 manage.py migrate site_settings 0003
```

### 4. 恢复数据库备份（如果有）
```bash
cp /home/yifeianyi/Desktop/xxm_fans_home/backup/db.sqlite3.backup /home/yifeianyi/Desktop/xxm_fans_home/data/db.sqlite3
```

### 5. 重新构建前端
```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_frontend
npm run build
```

### 6. 启动服务
```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/scripts
./dev_start_services.sh
```

---

## 八、技术栈信息

### 后端
- Django 5.2.3
- Django REST Framework 3.15.2
- Python 3.10.12

### 前端
- React 19.2.3
- TypeScript 5.8.2
- Vite 6.2.0
- Tailwind CSS

### 数据库
- SQLite (开发环境)

---

## 九、联系人

如有问题，请联系开发团队。

---

## 十、文档版本

- 版本：v1.0
- 创建日期：2026-01-25
- 最后更新：2026-01-25