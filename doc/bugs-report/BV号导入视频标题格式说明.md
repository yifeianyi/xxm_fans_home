# BV号导入视频标题格式说明

## 📋 概述

本系统支持通过B站BV号批量导入演唱记录，系统会自动解析视频分P标题，提取歌曲名称和演出日期信息。

## 🎯 支持的视频标题格式

### 标准格式（推荐）

```
歌曲名称-YYYY年M月D日
```

**示例**：
- `小幸运-2025年6月12日`
- `晴天-2024年12月25日`
- `告白气球-2023年1月1日`

### 格式说明

1. **歌曲名称**：位于标题开头，可以是任意字符
2. **分隔符**：使用 `-` (连字符) 分隔歌曲名称和日期
3. **日期格式**：`YYYY年M月D日`
   - `YYYY`：4位年份（如：2025）
   - `M`：1-2位月份（如：6、12）
   - `D`：1-2位日期（如：12、25）

## 🔍 解析规则

### 日期提取

系统使用正则表达式提取日期：

```python
match = re.search(r"(\d{4})年(\d{1,2})月(\d{1,2})日", title)
```

**匹配示例**：
- `2025年6月12日` ✅
- `2024年12月25日` ✅
- `2023年1月1日` ✅
- `2025年06月12日` ✅（支持补零）
- `25年6月12日` ❌（年份必须是4位）
- `2025/6/12` ❌（格式不正确）

### 歌曲名称提取

日期提取后，系统会从标题中移除日期部分，提取歌曲名称：

```python
song_name = re.sub(r"\d{4}年\d{1,2}月\d{1,2}日", "", title).strip("- ").strip()
song_name = song_name.split("-")[0].strip()
```

**处理流程**：
1. 移除日期部分（如：`2025年6月12日`）
2. 移除前后的连字符和空格
3. 以第一个连字符为界，取左侧部分作为歌曲名称

**示例**：
- `小幸运-2025年6月12日` → `小幸运`
- `晴天-2024年12月25日` → `晴天`
- `告白气球-2023年1月1日` → `告白气球`
- `小幸运-Live版-2025年6月12日` → `小幸运-Live版`
- `小幸运 - 2025年6月12日` → `小幸运`

## ⚙️ 如何修改标题格式

### 修改日期正则表达式

如果需要支持其他日期格式，修改 `tools/bilibili_importer.py` 文件中的正则表达式：

**当前代码位置**：`tools/bilibili_importer.py` 第127行

```python
# 当前格式
match = re.search(r"(\d{4})年(\d{1,2})月(\d{1,2})日", title)
```

**可选格式**：

1. **支持斜杠格式**：`2025/6/12`
   ```python
   match = re.search(r"(\d{4})/(\d{1,2})/(\d{1,2})", title)
   ```

2. **支持短横格式**：`2025-6-12`
   ```python
   match = re.search(r"(\d{4})-(\d{1,2})-(\d{1,2})", title)
   ```

3. **支持点号格式**：`2025.6.12`
   ```python
   match = re.search(r"(\d{4})\.(\d{1,2})\.(\d{1,2})", title)
   ```

4. **支持多种格式（使用或运算）**：
   ```python
   match = re.search(r"(\d{4})[年/-](\d{1,2})[月/-](\d{1,2})[日/]", title)
   ```

### 修改歌曲名称提取逻辑

如果需要调整歌曲名称的提取方式，修改第128-129行：

```python
# 当前逻辑
song_name = re.sub(r"\d{4}年\d{1,2}月\d{1,2}日", "", title).strip("- ").strip()
song_name = song_name.split("-")[0].strip()
```

**可选逻辑**：

1. **保留所有内容（包括连字符）**：
   ```python
   song_name = re.sub(r"\d{4}年\d{1,2}月\d{1,2}日", "", title).strip()
   ```

2. **以最后一个连字符为界**：
   ```python
   song_name = re.sub(r"\d{4}年\d{1,2}月\d{1,2}日", "", title).strip("- ").strip()
   song_name = song_name.rsplit("-", 1)[0].strip()
   ```

3. **移除所有连字符**：
   ```python
   song_name = re.sub(r"\d{4}年\d{1,2}月\d{1,2}日", "", title).strip().replace("-", " ")
   ```

## 📝 完整示例

### 修改为支持多种日期格式

```python
# tools/bilibili_importer.py

# 修改第127行
# 原始代码
# match = re.search(r"(\d{4})年(\d{1,2})月(\d{1,2})日", title)

# 修改为支持多种格式
match = re.search(r"(\d{4})[年/-](\d{1,2})[月/-](\d{1,2})[日/]", title)

# 修改第128-129行
# 原始代码
# song_name = re.sub(r"\d{4}年\d{1,2}月\d{1,2}日", "", title).strip("- ").strip()
# song_name = song_name.split("-")[0].strip()

# 修改为移除所有日期格式
song_name = re.sub(r"\d{4}[年/-]\d{1,2}[月/-]\d{1,2}[日/]", "", title).strip("- ").strip()
song_name = song_name.split("-")[0].strip()
```

### 修改后的支持格式

修改后，系统将支持以下格式：

- `小幸运-2025年6月12日` ✅
- `晴天-2024/12/25` ✅
- `告白气球-2023-1-1` ✅
- `小幸运-2025.6.12` ✅

## ⚠️ 注意事项

1. **日期格式必须唯一**：确保标题中只包含一个符合格式的日期，避免解析错误
2. **歌曲名称处理**：系统会以第一个连字符为界提取歌曲名称，确保歌曲名称中不包含连字符（或根据需要调整提取逻辑）
3. **测试验证**：修改格式后，建议先使用测试BV号验证解析结果是否正确
4. **兼容性**：修改格式可能会影响已有数据的导入，建议在非生产环境测试

## 🔧 测试方法

### 使用测试脚本

项目提供了测试脚本用于验证BV号导入功能：

```bash
cd repo/xxm_fans_backend
python tools/bilibili_importer.py
```

### 手动测试

1. 在B站创建测试视频，分P标题使用标准格式
2. 在Admin后台使用"导入BV号"功能
3. 观察解析结果是否正确

## 📚 相关文档

- `tools/bilibili_importer.py` - BV号导入核心逻辑
- `song_management/admin.py` - Admin后台导入功能
- `test_bv_and_cover_report.md` - BV号导入功能测试报告
- `DEPLOYMENT_SYMLINKS.md` - 部署配置说明

## 💡 最佳实践

1. **使用标准格式**：推荐使用 `歌曲名称-YYYY年M月D日` 格式
2. **保持一致性**：所有分P标题使用相同的格式
3. **提前规划**：在创建视频前确定标题格式，避免后期修改
4. **定期备份**：修改导入逻辑前备份原始代码
5. **充分测试**：在生产环境应用前进行充分测试