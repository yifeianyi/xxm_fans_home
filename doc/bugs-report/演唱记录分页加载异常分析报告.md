# æ¼”å”±è®°å½•åˆ†é¡µåŠ è½½å¼‚å¸¸åˆ†æžæŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2026-01-24
**é—®é¢˜ç±»åž‹**: æ¼”å”±è®°å½•åˆ†é¡µåŠ è½½ä¸å®Œæ•´
**å½±å“èŒƒå›´**: è¶…è¿‡20æ¡è®°å½•çš„æ­Œæ›²

---

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šé¡¹ç›®ä¸Šçº¿åŽï¼Œç‚¹å¼€æ¼”å”±è®°å½•æ—¶ï¼Œå¯¹äºŽè¶…è¿‡20ä¸ªè®°å½•çš„æ­Œæ›²ï¼Œæœ‰æ—¶å€™åªæ˜¾ç¤ºå‰20é¦–ï¼Œå°±è¯´åŠ è½½å®Œæˆäº†ï¼Œæœ‰æ—¶å€™ä¸ä¼šã€‚è¿™æ˜¯ä¸€ä¸ªé—´æ­‡æ€§å‡ºçŽ°çš„é—®é¢˜ã€‚

---

## é—®é¢˜åˆ†æž

### 1. åŽç«¯APIå®žçŽ°åˆ†æž

#### 1.1 ç¼“å­˜æœºåˆ¶é—®é¢˜

**æ–‡ä»¶**: `repo/xxm_fans_backend/song_management/api/views.py:176-221`

åŽç«¯æ¼”å”±è®°å½•APIä½¿ç”¨äº†Redisç¼“å­˜æœºåˆ¶ï¼š

```python
cache_key = f"song_records:{song_id}:{page_num}:{page_size}"

# å°è¯•ä»Žç¼“å­˜èŽ·å–æ•°æ®
try:
    records = cache.get(cache_key)
    if records is not None:
        return success_response(data=records, message="èŽ·å–æ¼”å”±è®°å½•æˆåŠŸ")
except Exception as e:
    logger.warning(f"Cache get failed for song records: {e}")
```

**é—®é¢˜ç‚¹1**: ç¼“å­˜åªå­˜å‚¨äº†å½“å‰é¡µçš„æ•°æ®ï¼Œæ²¡æœ‰å­˜å‚¨åˆ†é¡µå…ƒæ•°æ®ï¼ˆtotalã€pageã€page_sizeï¼‰

å½“ä»Žç¼“å­˜è¯»å–æ•°æ®æ—¶ï¼Œç›´æŽ¥è¿”å›žäº†ç¼“å­˜çš„resultsï¼Œä½†æ²¡æœ‰åŒ…å«åˆ†é¡µä¿¡æ¯ï¼š

```python
if records is not None:
    return success_response(data=records, message="èŽ·å–æ¼”å”±è®°å½•æˆåŠŸ")
```

è¿™å¯¼è‡´å‰ç«¯æ— æ³•çŸ¥é“æ€»å…±æœ‰å¤šå°‘æ¡è®°å½•ï¼Œä»Žè€Œæ— æ³•åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®ã€‚

#### 1.2 ç¼“å­˜è®¾ç½®é—®é¢˜

**æ–‡ä»¶**: `repo/xxm_fans_backend/xxm_fans_home/settings.py:168-175`

```python
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/0',
        'TIMEOUT': 300,
        'KEY_PREFIX': 'xxm_fans_home',
    }
}
```

**é—®é¢˜ç‚¹2**: Redisé…ç½®äº†5åˆ†é’Ÿï¼ˆ300ç§’ï¼‰çš„ç¼“å­˜è¶…æ—¶æ—¶é—´

å¦‚æžœRedisæœåŠ¡ä¸ç¨³å®šæˆ–é‡å¯ï¼Œç¼“å­˜ä¼šä¸¢å¤±ï¼Œå¯¼è‡´è¡Œä¸ºä¸ä¸€è‡´ã€‚

#### 1.3 åˆ†é¡µé€»è¾‘åˆ†æž

åŽç«¯åˆ†é¡µé€»è¾‘æœ¬èº«æ˜¯æ­£ç¡®çš„ï¼š

```python
paginator = Paginator(queryset, page_size)
page = paginator.get_page(page_num)

return paginated_response(
    data=results,
    total=paginator.count,
    page=page.number,
    page_size=page_size,
    message="èŽ·å–æ¼”å”±è®°å½•æˆåŠŸ"
)
```

**å…³é”®é—®é¢˜**: å½“ç¼“å­˜å‘½ä¸­æ—¶ï¼Œè¿”å›žçš„æ•°æ®æ ¼å¼ä¸ä¸€è‡´ï¼š
- ç¼“å­˜å‘½ä¸­ï¼š`{ data: [records], message: "..." }` (ç¼ºå°‘åˆ†é¡µä¿¡æ¯)
- ç¼“å­˜æœªå‘½ä¸­ï¼š`{ data: { results: [...], total: N, page: 1, page_size: 20 }, message: "..." }`

### 2. å‰ç«¯å®žçŽ°åˆ†æž

#### 2.1 å‰ç«¯å…¼å®¹æ€§å¤„ç†

**æ–‡ä»¶**: `repo/xxm_fans_frontend/infrastructure/api/RealSongService.ts:96-135`

å‰ç«¯åšäº†å…¼å®¹æ€§å¤„ç†ï¼š

```typescript
if (Array.isArray(result.data)) {
  // åŽç«¯ç›´æŽ¥è¿”å›žæ•°ç»„
  recordsArray = result.data;
  totalCount = result.data.length;
} else if (result.data.results && Array.isArray(result.data.results)) {
  // æ ‡å‡†åˆ†é¡µæ ¼å¼
  recordsArray = result.data.results;
  totalCount = result.data.total || result.data.results.length;
}
```

**é—®é¢˜ç‚¹3**: å½“åŽç«¯è¿”å›žæ•°ç»„æ—¶ï¼Œ`totalCount = result.data.length`

è¿™æ„å‘³ç€ï¼š
- ç¬¬1é¡µè¿”å›ž20æ¡ï¼Œ`totalCount = 20`
- å‰ç«¯ä¼šè®¤ä¸ºæ€»è®°å½•æ•°å°±æ˜¯20ï¼Œä¸ä¼šå†è¯·æ±‚ç¬¬2é¡µ

#### 2.2 å‰ç«¯hasMoreåˆ¤æ–­é€»è¾‘

**æ–‡ä»¶**: `repo/xxm_fans_frontend/presentation/components/features/RecordList.tsx:47-74`

```typescript
if (result.data) {
  const { results, total } = result.data;
  console.log(`âœ… èŽ·å–æ¼”å”±è®°å½•æˆåŠŸ: ç¬¬ ${pageNum} é¡µ, è¿”å›ž ${results.length} æ¡, æ€»è®¡ ${total} æ¡`);

  if (isLoadMore) {
    setRecords(prev => {
      const newRecords = [...prev, ...results];
      setHasMore(newRecords.length < total);
      return newRecords;
    });
  } else {
    setRecords(results);
    setHasMore(results.length < total);
  }
  setTotalRecords(total);
}
```

**é—®é¢˜ç‚¹4**: å½“`total`=20æ—¶ï¼Œ`hasMore`ä¼šè¢«è®¾ç½®ä¸º`false`

å³ä½¿å®žé™…æœ‰æ›´å¤šè®°å½•ï¼Œå‰ç«¯ä¹Ÿä¼šè®¤ä¸ºåŠ è½½å®Œæˆã€‚

### 3. RedisæœåŠ¡çŠ¶æ€æ£€æŸ¥

é€šè¿‡æ£€æŸ¥å‘çŽ°ï¼š

```bash
$ redis-cli ping
Redis not running or not accessible
```

**å…³é”®å‘çŽ°**: RedisæœåŠ¡å¯èƒ½æœªè¿è¡Œæˆ–ä¸å¯è®¿é—®

è¿™æ„å‘³ç€ï¼š
1. ç¼“å­˜getæ“ä½œä¼šå¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
2. ä»£ç æ•èŽ·å¼‚å¸¸åŽï¼Œä¼šç»§ç»­æ‰§è¡Œæ­£å¸¸çš„æ•°æ®åº“æŸ¥è¯¢
3. ä½†å¦‚æžœRedisä¹‹å‰è¿è¡Œè¿‡ï¼Œç¼“å­˜ä¸­å¯èƒ½æœ‰è¿‡æœŸæˆ–ä¸å®Œæ•´çš„æ•°æ®
4. å½“Redisé‡å¯åŽï¼Œç¼“å­˜æ¸…ç©ºï¼Œè¡Œä¸ºæ¢å¤æ­£å¸¸

### 4. é—®é¢˜æ ¹å› æ€»ç»“

| é—®é¢˜ç‚¹ | ä¸¥é‡ç¨‹åº¦ | è¯´æ˜Ž |
|--------|----------|------|
| ç¼“å­˜æ•°æ®æ ¼å¼ä¸ä¸€è‡´ | ðŸ”´ é«˜ | ç¼“å­˜å‘½ä¸­æ—¶ç¼ºå°‘åˆ†é¡µå…ƒæ•°æ® |
| RedisæœåŠ¡ä¸ç¨³å®š | ðŸ”´ é«˜ | Redisæœªè¿è¡Œå¯¼è‡´ç¼“å­˜å¤±æ•ˆ |
| å‰ç«¯å…¼å®¹æ€§å¤„ç†ç¼ºé™· | ðŸŸ¡ ä¸­ | å°†æ•°ç»„é•¿åº¦å½“ä½œæ€»æ•° |
| ç¼“å­˜keyè®¾è®¡é—®é¢˜ | ðŸŸ¡ ä¸­ | åªç¼“å­˜resultsï¼Œä¸ç¼“å­˜å…ƒæ•°æ® |

---

## é—®é¢˜å¤çŽ°è·¯å¾„

### åœºæ™¯1ï¼šRedisè¿è¡Œä¸”æœ‰ç¼“å­˜

1. ç”¨æˆ·é¦–æ¬¡è®¿é—®æ­Œæ›²Aï¼ˆæœ‰30æ¡è®°å½•ï¼‰
2. åŽç«¯ä»Žæ•°æ®åº“æŸ¥è¯¢ç¬¬1é¡µï¼Œè¿”å›ž20æ¡ï¼Œtotal=30
3. åŽç«¯å°†resultsç¼“å­˜åˆ°Redisï¼ˆkey: `song_records:A:1:20`ï¼‰
4. å‰ç«¯æ˜¾ç¤º20æ¡ï¼ŒhasMore=true

5. ç”¨æˆ·æ»šåŠ¨ï¼Œè¯·æ±‚ç¬¬2é¡µ
6. åŽç«¯ä»Žæ•°æ®åº“æŸ¥è¯¢ç¬¬2é¡µï¼Œè¿”å›ž10æ¡ï¼Œtotal=30
7. åŽç«¯å°†resultsç¼“å­˜åˆ°Redisï¼ˆkey: `song_records:A:2:20`ï¼‰
8. å‰ç«¯æ˜¾ç¤º30æ¡ï¼ŒhasMore=false

**æ­£å¸¸æƒ…å†µ** âœ…

### åœºæ™¯2ï¼šRedisé‡å¯åŽ

1. Redisé‡å¯ï¼Œæ‰€æœ‰ç¼“å­˜æ¸…ç©º
2. ç”¨æˆ·è®¿é—®æ­Œæ›²A
3. åŽç«¯ä»Žæ•°æ®åº“æŸ¥è¯¢ç¬¬1é¡µï¼Œè¿”å›ž20æ¡ï¼Œtotal=30
4. å‰ç«¯æ˜¾ç¤º20æ¡ï¼ŒhasMore=true

**æ­£å¸¸æƒ…å†µ** âœ…

### åœºæ™¯3ï¼šRedisè¿è¡Œä½†ç¼“å­˜æ•°æ®æ ¼å¼é”™è¯¯ï¼ˆé—®é¢˜åœºæ™¯ï¼‰

1. ç”¨æˆ·é¦–æ¬¡è®¿é—®æ­Œæ›²Aï¼ˆæœ‰30æ¡è®°å½•ï¼‰
2. åŽç«¯ä»Žæ•°æ®åº“æŸ¥è¯¢ç¬¬1é¡µï¼Œè¿”å›ž20æ¡ï¼Œtotal=30
3. **åŽç«¯å°†resultsæ•°ç»„ç¼“å­˜åˆ°Redis**ï¼ˆæ³¨æ„ï¼šåªç¼“å­˜äº†æ•°ç»„ï¼Œä¸æ˜¯å®Œæ•´çš„åˆ†é¡µå¯¹è±¡ï¼‰
4. ç¼“å­˜å†…å®¹ï¼š`[record1, record2, ..., record20]`

5. ç”¨æˆ·åˆ·æ–°é¡µé¢ï¼Œå†æ¬¡è®¿é—®æ­Œæ›²A
6. åŽç«¯ä»ŽRedisèŽ·å–ç¼“å­˜ï¼Œå¾—åˆ°æ•°ç»„ï¼š`[record1, record2, ..., record20]`
7. **åŽç«¯ç›´æŽ¥è¿”å›žæ•°ç»„**ï¼š`success_response(data=[records])`
8. å‰ç«¯æ”¶åˆ°æ•°ç»„ï¼Œæ‰§è¡Œå…¼å®¹æ€§å¤„ç†ï¼š
   ```typescript
   totalCount = result.data.length; // = 20
   ```
9. å‰ç«¯è®¤ä¸ºtotal=20ï¼Œè®¾ç½®hasMore=false
10. ç”¨æˆ·çœ‹åˆ°20æ¡è®°å½•ï¼Œæ˜¾ç¤º"å·²åŠ è½½å…¨éƒ¨è®°å½•"

**é—®é¢˜æƒ…å†µ** âŒ

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤ç¼“å­˜é€»è¾‘ï¼ˆæŽ¨èï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `repo/xxm_fans_backend/song_management/api/views.py:176-221`

```python
# ä¿®æ”¹ç¼“å­˜é€»è¾‘ï¼Œç¼“å­˜å®Œæ•´çš„åˆ†é¡µå“åº”
cache_key = f"song_records:{song_id}:{page_num}:{page_size}"

try:
    cached_data = cache.get(cache_key)
    if cached_data is not None:
        # ç¼“å­˜ä¸­å­˜å‚¨å®Œæ•´çš„åˆ†é¡µå¯¹è±¡
        return success_response(data=cached_data, message="èŽ·å–æ¼”å”±è®°å½•æˆåŠŸï¼ˆç¼“å­˜ï¼‰")
except Exception as e:
    logger.warning(f"Cache get failed for song records: {e}")

# è°ƒç”¨çˆ¶ç±»æ–¹æ³•èŽ·å–æ•°æ®
try:
    queryset = self.get_queryset()
    paginator = Paginator(queryset, page_size)
    page = paginator.get_page(page_num)

    serializer = self.get_serializer(page, many=True)

    # å¤„ç†å°é¢URL
    results = []
    for record in serializer.data:
        performed_at = record.get('performed_at')
        if performed_at:
            date = datetime.strptime(performed_at, "%Y-%m-%d").date()
            date_str = date.strftime("%Y-%m-%d")
            year = date.strftime("%Y")
            month = date.strftime("%m")
            record["cover_url"] = record.get("cover_url") or f"/covers/{year}/{month}/{date_str}.jpg"
        else:
            record["cover_url"] = "/covers/default.jpg"
        results.append(record)

    # æž„å»ºå®Œæ•´çš„åˆ†é¡µå“åº”å¯¹è±¡
    paginated_data = {
        'results': results,
        'total': paginator.count,
        'page': page.number,
        'page_size': page_size
    }

    # ç¼“å­˜å®Œæ•´çš„åˆ†é¡µå¯¹è±¡
    try:
        cache.set(cache_key, paginated_data, 600)
    except Exception as e:
        logger.warning(f"Cache set failed for song records: {e}")

    return success_response(data=paginated_data, message="èŽ·å–æ¼”å”±è®°å½•æˆåŠŸ")
except Song.DoesNotExist:
    raise SongNotFoundException(f"æ­Œæ›²ä¸å­˜åœ¨: {song_id}")
```

### æ–¹æ¡ˆ2ï¼šç¦ç”¨ç¼“å­˜ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

å¦‚æžœRedisæœåŠ¡ä¸ç¨³å®šï¼Œå¯ä»¥ä¸´æ—¶ç¦ç”¨ç¼“å­˜ï¼š

**ä¿®æ”¹æ–‡ä»¶**: `repo/xxm_fans_backend/song_management/api/views.py`

æ³¨é‡ŠæŽ‰ç¼“å­˜ç›¸å…³ä»£ç ï¼Œç›´æŽ¥æŸ¥è¯¢æ•°æ®åº“ã€‚

### æ–¹æ¡ˆ3ï¼šç¡®ä¿RedisæœåŠ¡ç¨³å®šè¿è¡Œ

1. æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€ï¼š
   ```bash
   sudo systemctl status redis
   sudo systemctl start redis
   sudo systemctl enable redis
   ```

2. ç›‘æŽ§RedisæœåŠ¡ï¼š
   ```bash
   # æ·»åŠ ç›‘æŽ§è„šæœ¬
   redis-cli ping
   ```

3. é…ç½®RedisæŒä¹…åŒ–ï¼š
   ```bash
   # ç¼–è¾‘ redis.conf
   save 900 1
   save 300 10
   save 60 10000
   ```

---

## éªŒè¯æ­¥éª¤

### 1. éªŒè¯RedisæœåŠ¡

```bash
# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
redis-cli ping

# æ£€æŸ¥Redisä¸­çš„ç¼“å­˜
redis-cli keys "song_records:*"

# æ¸…é™¤ç‰¹å®šç¼“å­˜
redis-cli del "song_records:1:1:20"
```

### 2. éªŒè¯APIå“åº”

```bash
# æµ‹è¯•ç¬¬1é¡µ
curl "http://localhost:8080/api/songs/1/records/?page=1&page_size=20"

# æµ‹è¯•ç¬¬2é¡µ
curl "http://localhost:8080/api/songs/1/records/?page=2&page_size=20"
```

### 3. éªŒè¯å‰ç«¯è¡Œä¸º

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ°Networkæ ‡ç­¾
3. è®¿é—®ä¸€ä¸ªæœ‰è¶…è¿‡20æ¡è®°å½•çš„æ­Œæ›²
4. æŸ¥çœ‹APIå“åº”ï¼š
   - æ£€æŸ¥å“åº”æ ¼å¼æ˜¯å¦åŒ…å«`total`å­—æ®µ
   - æ£€æŸ¥`total`å€¼æ˜¯å¦æ­£ç¡®
5. æ»šåŠ¨åŠ è½½æ›´å¤šè®°å½•
6. è§‚å¯Ÿæ˜¯å¦æ­£ç¡®åŠ è½½æ‰€æœ‰è®°å½•

### 4. éªŒè¯ç¼“å­˜ä¸€è‡´æ€§

```bash
# æ¸…ç©ºRedisç¼“å­˜
redis-cli flushall

# é‡æ–°è®¿é—®æ­Œæ›²ï¼Œè§‚å¯Ÿè¡Œä¸º
# ç„¶åŽåˆ·æ–°é¡µé¢ï¼Œè§‚å¯Ÿç¼“å­˜æ˜¯å¦æ­£ç¡®å·¥ä½œ
```

---

## å»ºè®®çš„ä¿®å¤ä¼˜å…ˆçº§

1. **ç«‹å³ä¿®å¤**ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ï¼š
   - ä¿®å¤ç¼“å­˜é€»è¾‘ï¼Œç¼“å­˜å®Œæ•´çš„åˆ†é¡µå¯¹è±¡
   - ç¡®ä¿RedisæœåŠ¡ç¨³å®šè¿è¡Œ

2. **çŸ­æœŸä¼˜åŒ–**ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰ï¼š
   - æ·»åŠ ç¼“å­˜å¤±æ•ˆç­–ç•¥
   - æ·»åŠ ç¼“å­˜ç›‘æŽ§å’Œå‘Šè­¦

3. **é•¿æœŸæ”¹è¿›**ï¼ˆä½Žä¼˜å…ˆçº§ï¼‰ï¼š
   - è€ƒè™‘ä½¿ç”¨æ›´å¯é çš„ç¼“å­˜æ–¹æ¡ˆ
   - æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–ç¼“å­˜é€»è¾‘

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜Ž |
|----------|------|
| `repo/xxm_fans_backend/song_management/api/views.py:176-221` | æ¼”å”±è®°å½•APIå®žçŽ° |
| `repo/xxm_fans_backend/xxm_fans_home/settings.py:168-175` | Redisç¼“å­˜é…ç½® |
| `repo/xxm_fans_frontend/infrastructure/api/RealSongService.ts:96-135` | å‰ç«¯APIè°ƒç”¨ |
| `repo/xxm_fans_frontend/presentation/components/features/RecordList.tsx:47-74` | å‰ç«¯åˆ†é¡µç»„ä»¶ |

### B. ç¼“å­˜Keyæ ¼å¼

```
song_records:{song_id}:{page_num}:{page_size}
```

ç¤ºä¾‹ï¼š
- `song_records:1:1:20` - æ­Œæ›²1çš„ç¬¬1é¡µï¼Œæ¯é¡µ20æ¡
- `song_records:1:2:20` - æ­Œæ›²1çš„ç¬¬2é¡µï¼Œæ¯é¡µ20æ¡

### C. åˆ†é¡µå“åº”æ ¼å¼

**æ­£ç¡®æ ¼å¼**ï¼š
```json
{
  "code": 200,
  "message": "èŽ·å–æ¼”å”±è®°å½•æˆåŠŸ",
  "data": {
    "results": [...],
    "total": 30,
    "page": 1,
    "page_size": 20
  }
}
```

**é”™è¯¯æ ¼å¼ï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰**ï¼š
```json
{
  "code": 200,
  "message": "èŽ·å–æ¼”å”±è®°å½•æˆåŠŸ",
  "data": [...]
}
```

---

## ç»“è®º

é—®é¢˜æ ¹å› æ˜¯**åŽç«¯ç¼“å­˜é€»è¾‘è®¾è®¡ç¼ºé™·**ï¼šç¼“å­˜åªå­˜å‚¨äº†resultsæ•°ç»„ï¼Œæ²¡æœ‰å­˜å‚¨å®Œæ•´çš„åˆ†é¡µå¯¹è±¡ï¼ˆåŒ…å«totalã€pageã€page_sizeï¼‰ã€‚å½“ç¼“å­˜å‘½ä¸­æ—¶ï¼Œè¿”å›žçš„æ•°æ®æ ¼å¼ä¸Žç¼“å­˜æœªå‘½ä¸­æ—¶ä¸ä¸€è‡´ï¼Œå¯¼è‡´å‰ç«¯æ— æ³•æ­£ç¡®åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®ã€‚

**å»ºè®®ç«‹å³é‡‡ç”¨æ–¹æ¡ˆ1ä¿®å¤ç¼“å­˜é€»è¾‘**ï¼Œå¹¶ç¡®ä¿RedisæœåŠ¡ç¨³å®šè¿è¡Œã€‚