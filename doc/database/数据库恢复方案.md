# 数据库恢复方案

## 背景

由于后端代码目录 `repo/xxm_fans_backend/` 被意外清空，需要根据现有的数据库文件和后端数据模型重新适配数据库配置。

## 当前情况分析

### 数据库状态
- **主数据库**：`data/db.sqlite3` (3.2MB) - 包含完整的表结构和数据
- **数据分析数据库**：`data/view_data.sqlite3` (151KB) - 数据分析相关数据
- **数据库表**：包含以下主要表
  - Django 系统表：`django_migrations`, `django_admin_log`, `django_content_type`, `django_session` 等
  - 认证表：`auth_user`, `auth_group`, `auth_permission` 等
  - 业务表：
    - `main_songs`, `main_songrecord` - 歌曲和演唱记录
    - `main_style`, `main_tag` - 曲风和标签
    - `main_recommendation` - 推荐语
    - `main_sitesettings` - 网站设置
    - `footprint_collection`, `footprint_work` - 二创作品（旧版）
    - `fansDIY_collection`, `fansDIY_work` - 二创作品（新版）
    - `youyou_SongList_you_*`, `bingjie_SongList_bingjie_*` - 模板化歌单

### 后端代码状态
- **目录状态**：`repo/xxm_fans_backend/` 为空目录
- **Git 子模块**：后端代码存储在独立的 Git 仓库 `git@github.com:yifeianyi/xxm_fans_backend.git`
- **子模块配置**：已在 `.gitmodules` 中配置

### 后端应用结构（根据 IFLOW.md）
根据项目文档，后端应包含以下应用：
- `song_management` - 歌曲管理应用
- `fansDIY` - 粉丝二创作品管理应用
- `site_settings` - 网站设置应用
- `data_analytics` - 数据分析应用
- `songlist` - 模板化歌单应用
- `core` - 核心共享模块

## 执行步骤

### 步骤 1：恢复 Git 子模块

初始化并更新 Git 子模块，从远程仓库恢复后端代码：

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home
git submodule update --init --recursive
```

**预期结果**：
- `repo/xxm_fans_backend/` 目录包含完整的后端代码
- `repo/xxm_fans_frontend/` 目录包含完整的前端代码

### 步骤 2：验证后端代码结构

检查后端目录是否包含预期文件和目录：

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
ls -la
```

**预期文件结构**：
```
xxm_fans_backend/
├── manage.py                    # Django 管理脚本
├── requirements.txt             # Python 依赖
├── xxm_fans_home/               # Django 项目配置
│   ├── settings.py             # 项目配置文件
│   ├── urls.py                 # URL 路由配置
│   └── wsgi.py                 # WSGI 配置
├── song_management/            # 歌曲管理应用
│   ├── models.py               # 歌曲模型
│   ├── views.py                # 视图
│   ├── urls.py                 # URL 配置
│   └── admin.py                # Admin 配置
├── fansDIY/                    # 粉丝二创应用
│   ├── models.py               # 二创作品模型
│   ├── views.py                # 视图
│   └── admin.py                # Admin 配置
├── site_settings/              # 网站设置应用
│   ├── models.py               # 网站设置模型
│   └── admin.py                # Admin 配置
├── data_analytics/             # 数据分析应用
│   ├── models.py               # 数据分析模型
│   └── admin.py                # Admin 配置
├── songlist/                   # 模板化歌单应用
│   ├── models.py               # 歌单模型
│   └── admin.py                # Admin 配置
└── core/                       # 核心共享模块
    ├── cache.py                # 缓存工具
    ├── exceptions.py           # 异常定义
    └── responses.py            # 响应格式
```

### 步骤 3：分析数据库结构

使用 Python 查看现有数据库的表结构，确认与后端模型的对应关系：

```python
import sqlite3

# 连接主数据库
conn = sqlite3.connect('/home/yifeianyi/Desktop/xxm_fans_home/data/db.sqlite3')
cursor = conn.cursor()

# 获取所有表
cursor.execute("SELECT name FROM sqlite_master WHERE type='table'")
tables = cursor.fetchall()
print("数据库表列表：")
for table in tables:
    print(f"  - {table[0]}")

# 获取每个表的 schema
for table in tables:
    table_name = table[0]
    cursor.execute(f"PRAGMA table_info({table_name})")
    columns = cursor.fetchall()
    print(f"\n表 {table_name} 结构：")
    for col in columns:
        print(f"  {col[1]} {col[2]}")

conn.close()
```

### 步骤 4：配置数据库路径

在 `xxm_fans_home/settings.py` 中配置数据库路径，指向项目根目录下的 `data/` 目录：

```python
import os
from pathlib import Path

# 项目根目录
BASE_DIR = Path(__file__).resolve().parent.parent

# 数据库目录
DATA_DIR = BASE_DIR.parent.parent / 'data'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': DATA_DIR / 'db.sqlite3',
    },
    'view_data_db': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': DATA_DIR / 'view_data.sqlite3',
    },
    'songlist_db': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': DATA_DIR / 'songlist.sqlite3',
    }
}

# 数据库路由
DATABASE_ROUTERS = [
    'song_management.routers.SongManagementRouter',
    'data_analytics.routers.DataAnalyticsRouter',
    'songlist.routers.SonglistRouter',
]
```

**注意事项**：
- 确保 `DATA_DIR` 路径正确指向 `/home/yifeianyi/Desktop/xxm_fans_home/data/`
- 如果 `songlist.sqlite3` 不存在，可以暂时移除该数据库配置

### 步骤 5：验证数据库迁移

运行 Django 迁移命令，验证数据库状态：

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend

# 检查迁移状态
python manage.py showmigrations

# 标记迁移为已应用（不修改数据库结构）
python manage.py migrate --fake-initial

# 检查所有应用的迁移状态
python manage.py showmigrations song_management
python manage.py showmigrations fansDIY
python manage.py showmigrations site_settings
python manage.py showmigrations data_analytics
python manage.py showmigrations songlist
```

**预期结果**：
- 所有迁移显示为 `[X]`（已应用）
- 不应该有任何 `[ ]`（未应用）的迁移
- 如果有未应用的迁移，需要检查是否与数据库表结构匹配

### 步骤 6：验证 Django 配置

运行 Django 检查命令，验证配置是否正确：

```bash
# 检查 Django 配置
python manage.py check

# 检查数据库连接
python manage.py dbshell
# 在 sqlite 提示符中输入：
# .tables
# .quit
```

**预期结果**：
- `python manage.py check` 应该返回 0（无错误）
- 数据库连接正常，能够查看表列表

### 步骤 7：测试管理后台

启动开发服务器，测试管理后台是否可以正常访问：

```bash
# 启动开发服务器
python manage.py runserver 0.0.0.0:8000
```

在浏览器中访问：
- `http://127.0.0.1:8000/admin/` - 管理后台

**测试内容**：
- 使用超级用户账号登录
- 查看歌曲列表（`/admin/song_management/song/`）
- 查看二创作品（`/admin/fansDIY/work/`）
- 查看网站设置（`/admin/site_settings/sitesettings/`）

### 步骤 8：测试 API 接口

测试关键 API 接口是否正常工作：

```bash
# 测试歌曲列表 API
curl http://127.0.0.1:8000/api/songs/

# 测试二创合集 API
curl http://127.0.0.1:8000/api/fansDIY/collections/

# 测试曲风列表 API
curl http://127.0.0.1:8000/api/styles/

# 测试标签列表 API
curl http://127.0.0.1:8000/api/tags/
```

**预期结果**：
- 所有 API 返回正确的 JSON 响应
- HTTP 状态码为 200
- 数据格式符合前端期望

## 预期结果

执行完成后，应该达到以下状态：

- ✅ 后端代码从 Git 子模块成功恢复
- ✅ 数据库路径正确配置，指向 `data/` 目录
- ✅ Django 模型与数据库表结构完全匹配
- ✅ 所有迁移状态正确，无需修改数据库结构
- ✅ 管理后台可以正常访问和使用
- ✅ 所有 API 接口正常工作
- ✅ 前端可以正常调用后端 API

## 风险评估

### 低风险
- **数据库文件已存在**：`data/db.sqlite3` 包含完整的表结构和数据
- **Git 子模块恢复**：后端代码可以从远程仓库完整恢复
- **无需数据迁移**：数据库表结构已经存在，不需要运行 `makemigrations`

### 中风险
- **数据库路由配置**：可能需要调整数据库路由配置，确保应用使用正确的数据库
- **环境变量配置**：需要确保 `.env` 文件配置正确
- **依赖安装**：可能需要安装 Python 依赖包

### 高风险
- **数据库结构不匹配**：如果数据库表结构与 Django 模型不匹配，可能需要手动调整
- **迁移冲突**：如果 Git 子模块中的迁移与数据库状态不一致，可能导致问题

## 注意事项

### ⚠️ 重要警告

1. **不要运行 `makemigrations`**
   - 数据库表结构已经存在
   - 运行 `makemigrations` 可能会创建新的迁移文件
   - 可能导致数据库结构与代码不一致

2. **不要运行 `migrate --run-syncdb`**
   - 这个命令会尝试同步数据库结构
   - 可能会破坏现有数据

3. **备份现有数据库**
   ```bash
   cp data/db.sqlite3 data/db.sqlite3.backup
   cp data/view_data.sqlite3 data/view_data.sqlite3.backup
   ```

4. **使用 `--fake` 选项**
   - 如果需要标记迁移为已应用，使用 `--fake` 选项
   - 不会修改数据库结构

### 故障排除

#### 问题 1：Git 子模块更新失败

**症状**：
```
fatal: repository 'git@github.com:yifeianyi/xxm_fans_backend.git' not found
```

**解决方案**：
- 检查 SSH 密钥是否已配置
- 确保有访问 GitHub 仓库的权限
- 使用 HTTPS URL 替代 SSH URL

#### 问题 2：数据库路径错误

**症状**：
```
django.db.utils.OperationalError: unable to open database file
```

**解决方案**：
- 检查 `settings.py` 中的 `BASE_DIR` 和 `DATA_DIR` 路径
- 确保数据库文件存在
- 检查文件权限

#### 问题 3：迁移状态不匹配

**症状**：
```
django.db.migrations.exceptions.InconsistentMigrationHistory
```

**解决方案**：
- 使用 `--fake` 标记迁移为已应用
- 检查 `django_migrations` 表中的记录
- 手动调整迁移状态

#### 问题 4：API 返回 404

**症状**：
```
{"detail":"Not found"}
```

**解决方案**：
- 检查 `urls.py` 配置
- 确认 API 路径正确
- 检查 CORS 配置

## 后续优化建议

1. **环境变量管理**
   - 使用 `env/backend.env` 统一管理环境变量
   - 通过软链接到后端项目的 `.env` 文件

2. **数据库备份**
   - 定期备份数据库文件
   - 设置自动备份脚本

3. **文档更新**
   - 更新 IFLOW.md 中的数据库配置说明
   - 更新部署文档

4. **测试验证**
   - 运行集成测试脚本 `scripts/test_integration.sh`
   - 验证前后端联调正常

## 相关文档

- `IFLOW.md` - 项目主文档
- `repo/xxm_fans_backend/doc/API文档.md` - 后端 API 文档
- `repo/xxm_fans_backend/doc/ADMIN功能文档.md` - 管理后台文档
- `scripts/test_integration.sh` - 集成测试脚本
- `INTEGRATION_TEST_REPORT.md` - 集成测试报告

## 执行时间估算

- 步骤 1：恢复 Git 子模块 - 5-10 分钟
- 步骤 2：验证后端代码结构 - 2 分钟
- 步骤 3：分析数据库结构 - 5 分钟
- 步骤 4：配置数据库路径 - 5 分钟
- 步骤 5：验证数据库迁移 - 5 分钟
- 步骤 6：验证 Django 配置 - 3 分钟
- 步骤 7：测试管理后台 - 10 分钟
- 步骤 8：测试 API 接口 - 10 分钟

**总计**：约 45-50 分钟

---

**文档版本**：1.0
**创建日期**：2026-01-15
**最后更新**：2026-01-15
**维护者**：iFlow CLI