# å°æ»¡è™«ä¹‹å®¶æºç æŒæ¡è·¯çº¿

> ä¸“ä¸ºå·²é€šè¿‡ AI å¼€å‘æœ¬é¡¹ç›®ã€ä½†éœ€è¦æ·±å…¥æŒæ¡æºç çš„å·¥ç¨‹å¸ˆè®¾è®¡

---

## å‰è¨€ï¼šä½ çš„ç°çŠ¶ä¸å­¦ä¹ ç­–ç•¥

### ä½ ç°åœ¨çš„çŠ¶æ€
```
âœ… èƒ½ç”¨ AI ç”Ÿæˆä»£ç å®Œæˆéœ€æ±‚
âœ… çŸ¥é“é¡¹ç›®å¤§è‡´ç»“æ„
âœ… èƒ½è·‘é€šå¼€å‘ç¯å¢ƒå’Œéƒ¨ç½²
âŒ ä¸çœ‹ AI ç”Ÿæˆçš„ä»£ç å°±å¿ƒé‡Œæ²¡åº•
âŒ æŠ¥é”™æ—¶ä¸çŸ¥é“æ€ä¹ˆè°ƒè¯•
âŒ ä¸çŸ¥é“å¦‚ä½•ç‹¬ç«‹ä¿®æ”¹åŠŸèƒ½
âŒ ä¸ç†è§£ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡
```

### æœ¬è·¯çº¿çš„æ ¸å¿ƒç­–ç•¥

ä¸åŒäºä»é›¶æ•™å­¦çš„è·¯çº¿ï¼Œæœ¬è·¯çº¿é‡‡ç”¨**ã€Œé€†å‘å­¦ä¹ æ³•ã€**ï¼š

```
ä¼ ç»Ÿå­¦ä¹ ï¼šå­¦è¯­æ³• â†’ å†™ä»£ç  â†’ åšé¡¹ç›®
æœ¬è·¯çº¿ï¼š  è¯»ä»£ç  â†’ æ”¹ä»£ç  â†’ ç†è§£åŸç† â†’ èƒ½ç‹¬ç«‹å†™
         â†‘___________________________â†“
              ä»¥å°æ»¡è™«ä¹‹å®¶ä¸ºæ•™æ
```

### å­¦ä¹ åŸåˆ™

1. **ä»£ç å³æ–‡æ¡£**ï¼šæŠŠé¡¹ç›®æºç å½“æ•™æï¼Œé€è¡Œé˜…è¯»
2. **ä¿®æ”¹éªŒè¯**ï¼šæ¯å­¦ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œé€šè¿‡ä¿®æ”¹ä»£ç éªŒè¯ç†è§£
3. **è°ƒè¯•é©±åŠ¨**ï¼šç”¨ debugger è·Ÿè¸ªä»£ç æ‰§è¡Œï¼Œç†è§£æ•°æ®æµ
4. **ç”»å›¾è¾…åŠ©**ï¼šç”¨æµç¨‹å›¾ã€æ¶æ„å›¾åŠ æ·±ç†è§£

---

## ç¬¬ä¸€é˜¶æ®µï¼šè¯»æ‡‚é¡¹ç›®éª¨æ¶ï¼ˆç¬¬ 1 å‘¨ï¼‰

### ç›®æ ‡
å»ºç«‹é¡¹ç›®æ•´ä½“è®¤çŸ¥ï¼Œèƒ½å‡†ç¡®æè¿°ä»»æ„æ–‡ä»¶çš„ä½œç”¨ã€‚

### ä»»åŠ¡ 1ï¼šç»˜åˆ¶é¡¹ç›®åœ°å›¾

#### å®è·µ
```bash
# 1. åœ¨çº¸ä¸Šç”»å‡ºé¡¹ç›®ç›®å½•ç»“æ„ï¼ˆä¸è¦å¤åˆ¶ç²˜è´´ï¼Œæ‰‹å†™åŠ æ·±è®°å¿†ï¼‰
# ç›®æ ‡ï¼šä¸çœ‹ä»£ç èƒ½ç”»å‡ºä¸»è¦ç›®å½•

xxm_fans_home/
â”œâ”€â”€ repo/
â”‚   â”œâ”€â”€ xxm_fans_backend/      # åç«¯é¡¹ç›®
â”‚   â”‚   â”œâ”€â”€ song_management/   # æ­Œæ›²ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ fansDIY/          # äºŒåˆ›ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ gallery/          # å›¾é›†ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ livestream/       # ç›´æ’­æ—¥å†
â”‚   â”‚   â”œâ”€â”€ data_analytics/   # æ•°æ®åˆ†æ
â”‚   â”‚   â”œâ”€â”€ core/             # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â””â”€â”€ xxm_fans_home/    # é¡¹ç›®é…ç½®
â”‚   â””â”€â”€ xxm_fans_frontend/     # å‰ç«¯é¡¹ç›®
â”‚       â”œâ”€â”€ domain/           # é¢†åŸŸå±‚
â”‚       â”œâ”€â”€ infrastructure/   # åŸºç¡€è®¾æ–½å±‚
â”‚       â”œâ”€â”€ presentation/     # è¡¨ç°å±‚
â”‚       â””â”€â”€ shared/           # å…±äº«å±‚
â”œâ”€â”€ infra/                     # éƒ¨ç½²é…ç½®
â”œâ”€â”€ spider/                    # çˆ¬è™«
â””â”€â”€ scripts/                   # è„šæœ¬
```

#### éªŒè¯é—®é¢˜ï¼ˆè‡ªé—®è‡ªç­”ï¼‰
- [ ] `core/` æ¨¡å—ä¸ºä»€ä¹ˆè¢«å…¶ä»–æ¨¡å—ä¾èµ–ï¼Ÿ
- [ ] `song_management/api/` å’Œ `song_management/services/` æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
- [ ] å‰ç«¯ `domain/` å’Œ `infrastructure/` åˆ†å±‚ä¾æ®æ˜¯ä»€ä¹ˆï¼Ÿ
- [ ] `spider/` ä¸ºä»€ä¹ˆæ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•è€Œä¸æ˜¯åç«¯é‡Œï¼Ÿ

### ä»»åŠ¡ 2ï¼šæ•°æ®æµå‘å›¾

#### å®è·µ
ç”»å›¾è¡¨ç¤ºä¸€ä¸ªè¯·æ±‚çš„å¤„ç†æµç¨‹ï¼š

```
ç”¨æˆ·è®¿é—® /songs â†’ Nginx â†’ ... â†’ è¿”å›æ•°æ®
                 â†“
          [ç”»å‡ºæ¯ä¸ªæ­¥éª¤]
```

#### å‚è€ƒç­”æ¡ˆæ£€æŸ¥
```
ç”¨æˆ·è¯·æ±‚ /api/songs/
    â†“
Nginx (80/443ç«¯å£)
    â†“
Gunicorn (Unix Socket)
    â†“
Django WSGI
    â†“
URL Router (urls.py)
    â†“
View (song_views.py::SongListView)
    â†“
Serializer (serializers.py::SongSerializer)
    â†“
Model (models/song.py::Song.objects.all())
    â†“
SQLite æ•°æ®åº“
    â†“
è¿”å› JSON
```

### ä»»åŠ¡ 3ï¼šå…³é”®æ–‡ä»¶ç´¢å¼•

#### å»ºç«‹ä½ çš„"å¯¼èˆªè¡¨"

| åŠŸèƒ½éœ€æ±‚ | åç«¯æ–‡ä»¶ | å‰ç«¯æ–‡ä»¶ |
|---------|---------|---------|
| æ­Œæ›²åˆ—è¡¨ API | `song_management/api/song_views.py` | `infrastructure/api/RealSongService.ts` |
| æ­Œæ›²æ¨¡å‹ | `song_management/models/song.py` | `domain/types.ts::Song` |
| å›¾é›† API | `gallery/api/views.py` | `infrastructure/api/RealGalleryService.ts` |
| ç›´æ’­æ—¥å† | `livestream/api/views.py` | `presentation/pages/LivestreamPage.tsx` |
| éƒ¨ç½²é…ç½® | `infra/nginx/prod-xxm_nginx.conf` | - |

#### ç»ƒä¹ 
ä¸çœ‹ä»£ç ï¼Œåªçœ‹æ–‡ä»¶åï¼Œè¯´å‡ºæ¯ä¸ªæ–‡ä»¶å¤§æ¦‚åšä»€ä¹ˆã€‚

---

## ç¬¬äºŒé˜¶æ®µï¼šæŒæ¡åç«¯æ ¸å¿ƒï¼ˆç¬¬ 2-3 å‘¨ï¼‰

### ç¬¬ 2 å‘¨ï¼šæ¨¡å‹ä¸æ•°æ®åº“

#### å­¦ä¹ ä»»åŠ¡ 1ï¼šç²¾è¯» Song æ¨¡å‹

**æ–‡ä»¶**ï¼š`repo/xxm_fans_backend/song_management/models/song.py`

**å­¦ä¹ æ–¹æ³•**ï¼š
```python
# 1. å…ˆé€šè¯»ä»£ç ï¼Œç»™æ¯è¡ŒåŠ æ³¨é‡Š
class Song(models.Model):
    """æ­Œæ›²æ¨¡å‹"""
    # CharField å¯¹åº”æ•°æ®åº“çš„ VARCHAR
    # max_length=200 é™åˆ¶é•¿åº¦
    song_name = models.CharField(max_length=200, verbose_name='æ­Œæ›²åç§°')
    
    # blank=True å…è®¸è¡¨å•ä¸ºç©º
    # null=True å…è®¸æ•°æ®åº“ä¸º NULL
    singer = models.CharField(max_length=200, blank=True, null=True, verbose_name='æ­Œæ‰‹')
    
    # DateField å­˜å‚¨æ—¥æœŸï¼ˆæ— æ—¶åŒºï¼‰
    first_perform = models.DateField(blank=True, null=True, verbose_name='é¦–æ¬¡æ¼”å”±æ—¶é—´')
    
    # IntegerField æ•´å‹
    # default=0 é»˜è®¤å€¼
    perform_count = models.IntegerField(default=0, verbose_name='æ¼”å”±æ¬¡æ•°')
```

**ä¿®æ”¹éªŒè¯**ï¼š
```python
# 2. ä¿®æ”¹éªŒè¯ï¼šç»™ Song æ·»åŠ ä¸€ä¸ªæ–°å­—æ®µ
class Song(models.Model):
    # ... åŸæœ‰å­—æ®µ
    
    # æ·»åŠ ï¼šæ­Œæ›²éš¾åº¦ï¼ˆ1-10ï¼‰
    difficulty = models.IntegerField(
        default=5, 
        verbose_name='æ¼”å”±éš¾åº¦',
        help_text='1-10ï¼Œæ•°å­—è¶Šå¤§è¶Šéš¾'
    )
```

**éªŒè¯æ­¥éª¤**ï¼š
```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
python manage.py makemigrations

# æŸ¥çœ‹ç”Ÿæˆçš„ SQL
python manage.py sqlmigrate song_management 000X

# æ‰§è¡Œè¿ç§»
python manage.py migrate

# åœ¨ shell ä¸­æµ‹è¯•
python manage.py shell
>>> from song_management.models import Song
>>> song = Song.objects.first()
>>> song.difficulty = 8
>>> song.save()
>>> Song.objects.filter(difficulty__gte=7)  # æŸ¥è¯¢éš¾åº¦>=7çš„æ­Œæ›²
```

#### å­¦ä¹ ä»»åŠ¡ 2ï¼šç†è§£å…³ç³»æ¨¡å‹

**æ–‡ä»¶**ï¼š`repo/xxm_fans_backend/song_management/models/song.py::SongRecord`

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. `ForeignKey` åšäº†ä»€ä¹ˆï¼Ÿæ•°æ®åº“å±‚é¢å¦‚ä½•ä½“ç°ï¼Ÿ
2. `related_name='records'` æœ‰ä»€ä¹ˆç”¨ï¼Ÿ
3. å¦‚ä½•é€šè¿‡ Song æŸ¥è¯¢å®ƒçš„æ‰€æœ‰ SongRecordï¼Ÿ

**è°ƒè¯•éªŒè¯**ï¼š
```python
# åœ¨ shell ä¸­è·Ÿè¸ª
python manage.py shell

# è·å–ä¸€é¦–æ­Œæ›²
song = Song.objects.first()

# æŸ¥çœ‹ç›¸å…³è®°å½• - è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆ SQL æŸ¥è¯¢ï¼Ÿ
records = song.records.all()

# æŸ¥çœ‹å®é™…æ‰§è¡Œçš„ SQL
from django.db import connection
print(connection.queries)
```

#### å­¦ä¹ ä»»åŠ¡ 3ï¼šGallery çš„è‡ªå¼•ç”¨å¤–é”®

**æ–‡ä»¶**ï¼š`repo/xxm_fans_backend/gallery/models.py`

**ç†è§£éš¾ç‚¹**ï¼šå¤šçº§åˆ†ç±»å¦‚ä½•å®ç°ï¼Ÿ

**ç”»å›¾ç†è§£**ï¼š
```
Gallery (æ ¹)
â”œâ”€â”€ Gallery (å­)
â”‚   â””â”€â”€ Gallery (å­™)
â””â”€â”€ Gallery (å­)

å¯¹åº”æ•°æ®ï¼š
id | title    | parent_id
---|----------|----------
1  | æ ¹å›¾é›†    | NULL
2  | å­å›¾é›†1   | 1
3  | å­å›¾é›†2   | 1
4  | å­™å›¾é›†    | 2
```

**è°ƒè¯•éªŒè¯**ï¼š
```python
# åˆ›å»ºæµ‹è¯•æ•°æ®
g1 = Gallery.objects.create(id='root', title='æ ¹', folder_path='/root/')
g2 = Gallery.objects.create(id='child1', title='å­1', parent=g1, folder_path='/root/child1/')
g3 = Gallery.objects.create(id='child2', title='å­2', parent=g1, folder_path='/root/child2/')

# éªŒè¯å±‚çº§è‡ªåŠ¨è®¡ç®—
g2.level  # åº”è¯¥æ˜¯ 1
g3.level  # åº”è¯¥æ˜¯ 1

# éªŒè¯å­æŸ¥è¯¢
g1.children.all()  # åº”è¯¥è¿”å› g2 å’Œ g3
```

### ç¬¬ 3 å‘¨ï¼šAPI ä¸ä¸šåŠ¡é€»è¾‘

#### å­¦ä¹ ä»»åŠ¡ 1ï¼šç†è§£ DRF è§†å›¾

**æ–‡ä»¶**ï¼š`repo/xxm_fans_backend/song_management/api/song_views.py`

**å­¦ä¹ æ–¹æ³•**ï¼šå¯¹æ¯”ä¸‰ç§è§†å›¾å†™æ³•

```python
# æ–¹å¼ 1ï¼šå‡½æ•°è§†å›¾ï¼ˆåŸå§‹ï¼‰
def song_list(request):
    songs = Song.objects.all()
    return JsonResponse([...])

# æ–¹å¼ 2ï¼šAPIViewï¼ˆç±»è§†å›¾ï¼‰
class SongListView(APIView):
    def get(self, request):
        songs = Song.objects.all()
        serializer = SongSerializer(songs, many=True)
        return Response(serializer.data)

# æ–¹å¼ 3ï¼šModelViewSetï¼ˆæœ€ç®€æ´ï¼‰
class SongViewSet(ModelViewSet):
    queryset = Song.objects.all()
    serializer_class = SongSerializer
```

**æ€è€ƒ**ï¼šé¡¹ç›®ä¸ºä»€ä¹ˆé€‰æ‹© APIView è€Œä¸æ˜¯ ModelViewSetï¼Ÿ

#### å­¦ä¹ ä»»åŠ¡ 2ï¼šåºåˆ—åŒ–å™¨çš„ä½œç”¨

**æ–‡ä»¶**ï¼š`repo/xxm_fans_backend/song_management/api/serializers.py`

**ç†è§£æ•°æ®è½¬æ¢è¿‡ç¨‹**ï¼š
```
Python å¯¹è±¡ (Song instance)
    â†“
Serializer (Python dict)
    â†“
JSON Response

å¯¹æ¯”ï¼š
- Model: æ•°æ®åº“ â†” Python å¯¹è±¡
- Serializer: Python å¯¹è±¡ â†” JSON
```

**è°ƒè¯•éªŒè¯**ï¼š
```python
from song_management.models import Song
from song_management.api.serializers import SongSerializer

song = Song.objects.first()

# æ­£å‘åºåˆ—åŒ–ï¼šå¯¹è±¡ â†’ å­—å…¸
serializer = SongSerializer(song)
print(serializer.data)  # çœ‹çœ‹è¾“å‡ºä»€ä¹ˆ

# åå‘åºåˆ—åŒ–ï¼šå­—å…¸ â†’ å¯¹è±¡
data = {'song_name': 'æµ‹è¯•æ­Œ', 'singer': 'æµ‹è¯•æ­Œæ‰‹'}
serializer = SongSerializer(data=data)
if serializer.is_valid():
    new_song = serializer.save()
    print(new_song.id)
```

#### å­¦ä¹ ä»»åŠ¡ 3ï¼šè‡ªå®šä¹‰ API é€»è¾‘

**å®è·µä»»åŠ¡**ï¼šæ·»åŠ ä¸€ä¸ª"éšæœºæ¨è"API

**æ­¥éª¤**ï¼š
```python
# 1. åœ¨ song_views.py æ·»åŠ 
from random import choice

class RandomSongView(APIView):
    def get(self, request):
        # è·å–æ‰€æœ‰ ID
        ids = Song.objects.values_list('id', flat=True)
        if not ids:
            return Response({'error': 'No songs'}, status=404)
        
        # éšæœºé€‰æ‹©ä¸€ä¸ª
        random_id = choice(list(ids))
        song = Song.objects.get(id=random_id)
        serializer = SongSerializer(song)
        return Response(serializer.data)

# 2. åœ¨ urls.py æ·»åŠ è·¯ç”±
path('random-song/', RandomSongView.as_view(), name='random_song'),

# 3. æµ‹è¯•
# GET http://localhost:8000/api/random-song/
```

#### å­¦ä¹ ä»»åŠ¡ 4ï¼šç†è§£æœåŠ¡å±‚

**æ–‡ä»¶**ï¼š`repo/xxm_fans_backend/song_management/services/`

**å…³é”®é—®é¢˜**ï¼šä¸ºä»€ä¹ˆè¦æŠŠä¸šåŠ¡é€»è¾‘ä» views ç§»åˆ° servicesï¼Ÿ

**å¯¹æ¯”**ï¼š
```python
# ä¸å¥½çš„åšæ³•ï¼šæ‰€æœ‰é€»è¾‘åœ¨ view ä¸­
class MyView(APIView):
    def post(self, request):
        # éªŒè¯æ•°æ®
        # ä¸šåŠ¡é€»è¾‘
        # æ•°æ®åº“æ“ä½œ
        # å‘é€é€šçŸ¥
        # ...

# å¥½çš„åšæ³•ï¼šview åªè´Ÿè´£ HTTPï¼Œé€»è¾‘åœ¨ service
def create_song_service(data):
    """å¯å¤ç”¨çš„ä¸šåŠ¡é€»è¾‘"""
    # æ‰€æœ‰ä¸šåŠ¡é€»è¾‘åœ¨è¿™é‡Œ
    pass

class MyView(APIView):
    def post(self, request):
        result = create_song_service(request.data)
        return Response(result)
```

---

## ç¬¬ä¸‰é˜¶æ®µï¼šæŒæ¡å‰ç«¯æ ¸å¿ƒï¼ˆç¬¬ 4-5 å‘¨ï¼‰

### ç¬¬ 4 å‘¨ï¼šTypeScript ç±»å‹ä¸ç»„ä»¶

#### å­¦ä¹ ä»»åŠ¡ 1ï¼šè¯»æ‡‚ç±»å‹å®šä¹‰

**æ–‡ä»¶**ï¼š`repo/xxm_fans_frontend/domain/types.ts`

**å­¦ä¹ æ–¹æ³•**ï¼šä¸ºæ¯ä¸ªç±»å‹å†™æ³¨é‡Š

```typescript
// Song ç±»å‹å¯¹åº”åç«¯æ¨¡å‹çš„å­—æ®µ
// æ³¨æ„å‘½åé£æ ¼è½¬æ¢ï¼šsnake_case â†’ camelCase
export interface Song {
    id: string;                    // å¯¹åº” song.id
    name: string;                  // å¯¹åº” song.song_name
    originalArtist: string;        // å¯¹åº” song.singer
    genres: string[];              // å¯¹åº” song.styles (å¤šå¯¹å¤šå…³ç³»)
    languages: string[];           // å¯¹åº” song.language (å•è¯­è¨€è½¬æ•°ç»„)
    firstPerformance: string;      // å¯¹åº” song.first_perform
    lastPerformance: string;       // å¯¹åº” song.last_performed
    performanceCount: number;      // å¯¹åº” song.perform_count
    tags: string[];                // å¯¹åº” song.tags
}
```

**éªŒè¯ç»ƒä¹ **ï¼šæ£€æŸ¥å‰åç«¯å­—æ®µæ˜¯å¦å¯¹åº”
```typescript
// æ‰¾åˆ°ä¸€å¤„ä¸åŒ¹é…çš„åœ°æ–¹ï¼Œä¿®å¤å®ƒ
// æ¯”å¦‚ï¼šåç«¯è¿”å›çš„æ˜¯ snake_caseï¼Œå‰ç«¯ç±»å‹å®šä¹‰æ˜¯ camelCase
// æŸ¥çœ‹ RealSongService.ts æ˜¯å¦‚ä½•è½¬æ¢çš„
```

#### å­¦ä¹ ä»»åŠ¡ 2ï¼šç»„ä»¶ç”Ÿå‘½å‘¨æœŸ

**æ–‡ä»¶**ï¼š`repo/xxm_fans_frontend/presentation/pages/SongsPage.tsx`

**ç”»å›¾ç†è§£ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ**ï¼š
```
SongsPage ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ
    â†“
Mountï¼ˆæŒ‚è½½ï¼‰
    â”œâ”€ è°ƒç”¨ Hooksï¼ˆuseState, useEffectï¼‰
    â”œâ”€ å‘èµ· API è¯·æ±‚
    â”œâ”€ æ¸²æŸ“ Loading çŠ¶æ€
    â†“
Updateï¼ˆæ›´æ–°ï¼‰
    â”œâ”€ ç”¨æˆ·ç‚¹å‡»ç­›é€‰ â†’ state å˜åŒ–
    â”œâ”€ ä¾èµ–å˜åŒ–è§¦å‘ useEffect
    â”œâ”€ é‡æ–°æ¸²æŸ“
    â†“
Unmountï¼ˆå¸è½½ï¼‰
    â””â”€ æ¸…ç†å·¥ä½œï¼ˆå–æ¶ˆè¯·æ±‚ç­‰ï¼‰
```

**è°ƒè¯•éªŒè¯**ï¼š
```typescript
// åœ¨ç»„ä»¶ä¸­æ·»åŠ æ—¥å¿—ï¼Œè§‚å¯Ÿæ‰§è¡Œé¡ºåº
const SongsPage: React.FC = () => {
    console.log('1. ç»„ä»¶å‡½æ•°æ‰§è¡Œ');
    
    const [songs, setSongs] = useState([]);
    
    useEffect(() => {
        console.log('2. useEffect æ‰§è¡Œ');
        fetchSongs();
        
        return () => {
            console.log('4. æ¸…ç†å‡½æ•°ï¼ˆç»„ä»¶å¸è½½æˆ–ä¾èµ–å˜åŒ–ï¼‰');
        };
    }, []);
    
    console.log('3. æ¸²æŸ“ UI');
    return (...);
};
```

#### å­¦ä¹ ä»»åŠ¡ 3ï¼šç†è§£ SWR æ•°æ®è·å–

**æ–‡ä»¶**ï¼š`repo/xxm_fans_frontend/infrastructure/hooks/useData.ts`

**æ ¸å¿ƒé—®é¢˜**ï¼š
1. ä¸ºä»€ä¹ˆç”¨ SWR è€Œä¸æ˜¯ç›´æ¥ç”¨ fetchï¼Ÿ
2. SWR çš„ key æœ‰ä»€ä¹ˆç”¨ï¼Ÿ
3. ç¼“å­˜ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ

**å¯¹æ¯”å®éªŒ**ï¼š
```typescript
// å®éªŒ 1ï¼šæ™®é€š fetch
const [data, setData] = useState(null);
useEffect(() => {
    fetch('/api/songs/').then(r => r.json()).then(setData);
}, []);

// å®éªŒ 2ï¼šSWR
const { data } = useSWR('/api/songs/', fetcher);

// è§‚å¯Ÿï¼š
// 1. åˆ‡æ¢é¡µé¢å†å›æ¥ï¼Œå“ªä¸ªä¼šé‡æ–°è¯·æ±‚ï¼Ÿ
// 2. å¿«é€Ÿåˆ‡æ¢ç­›é€‰æ¡ä»¶ï¼Œå“ªä¸ªä¼šå‘é€æ›´å¤šè¯·æ±‚ï¼Ÿ
```

### ç¬¬ 5 å‘¨ï¼šå‰ç«¯æ¶æ„ä¸è·¯ç”±

#### å­¦ä¹ ä»»åŠ¡ 1ï¼šDDD åˆ†å±‚ç†è§£

**æ–‡ä»¶ç»“æ„åˆ†æ**ï¼š
```
domain/              # é¢†åŸŸå±‚ï¼šå®šä¹‰ä¸šåŠ¡æ¦‚å¿µ
â”œâ”€ types.ts         # ä¸šåŠ¡å®ä½“ç±»å‹
â””â”€ api/             # ä¸šåŠ¡æ¥å£ï¼ˆä¸ä¾èµ–å…·ä½“æŠ€æœ¯ï¼‰

infrastructure/      # åŸºç¡€è®¾æ–½å±‚ï¼šæŠ€æœ¯å®ç°
â”œâ”€ api/             # çœŸå®çš„ API è°ƒç”¨
â”œâ”€ config/          # é…ç½®
â””â”€ hooks/           # æ•°æ®è·å–å°è£…

presentation/        # è¡¨ç°å±‚ï¼šUI
â”œâ”€ components/      # å¯å¤ç”¨ç»„ä»¶
â””â”€ pages/           # é¡µé¢ç»„ä»¶
```

**å…³é”®åŸåˆ™**ï¼š
- `domain/` ä¸å¯¼å…¥ä»»ä½• infrastructure ä»£ç 
- `presentation/` é€šè¿‡ interface ä½¿ç”¨ infrastructure
- è¿™æ ·å¯ä»¥åœ¨ä¸æ”¹å˜ä¸šåŠ¡é€»è¾‘çš„æƒ…å†µä¸‹æ›¿æ¢æŠ€æœ¯å®ç°

#### å­¦ä¹ ä»»åŠ¡ 2ï¼šè·¯ç”±ä¸å¯¼èˆª

**æ–‡ä»¶**ï¼š`repo/xxm_fans_frontend/App.tsx`

**ç»ƒä¹ **ï¼šæ·»åŠ ä¸€ä¸ªæ–°é¡µé¢
```typescript
// 1. åˆ›å»ºé¡µé¢ç»„ä»¶
// presentation/pages/TestPage.tsx
const TestPage: React.FC = () => {
    return <div>æµ‹è¯•é¡µé¢</div>;
};

// 2. æ·»åŠ è·¯ç”±
// App.tsx
const TestPage = lazy(() => import('./presentation/pages/TestPage'));

const routes = [
    // ... å…¶ä»–è·¯ç”±
    { path: '/test', element: <TestPage /> },
];

// 3. æ·»åŠ å¯¼èˆªé“¾æ¥
// components/layout/Navbar.tsx
<Link to="/test">æµ‹è¯•</Link>
```

#### å­¦ä¹ ä»»åŠ¡ 3ï¼šç»„ä»¶é€šä¿¡

**åˆ†æé¡¹ç›®ä¸­çš„é€šä¿¡æ–¹å¼**ï¼š

```typescript
// æ–¹å¼ 1ï¼šProps ä¼ é€’ï¼ˆçˆ¶å­ï¼‰
// SongTable.tsx
<SongRow song={song} onPlay={handlePlay} />

// æ–¹å¼ 2ï¼šçŠ¶æ€æå‡ï¼ˆå…„å¼Ÿï¼‰
// å…±åŒçˆ¶ç»„ä»¶ç®¡ç†çŠ¶æ€

// æ–¹å¼ 3ï¼šContextï¼ˆè·¨å±‚çº§ï¼‰
// é¡¹ç›®ä¸­ä½¿ç”¨äº† SWRProvider

// æ–¹å¼ 4ï¼šURL å‚æ•°ï¼ˆé¡µé¢é—´ï¼‰
// /gallery/:galleryId
const { galleryId } = useParams();
```

---

## ç¬¬å››é˜¶æ®µï¼šç‹¬ç«‹å¼€å‘èƒ½åŠ›ï¼ˆç¬¬ 6-7 å‘¨ï¼‰

### ç¬¬ 6 å‘¨ï¼šè°ƒè¯•ä¸æ’é”™

#### æŠ€èƒ½ 1ï¼šåç«¯è°ƒè¯•

**Django Shell è°ƒè¯•**ï¼š
```bash
python manage.py shell

# æµ‹è¯•æ¨¡å‹æŸ¥è¯¢
from song_management.models import Song
Song.objects.filter(perform_count__gt=5).explain()  # æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’

# æµ‹è¯•åºåˆ—åŒ–å™¨
from song_management.api.serializers import SongSerializer
song = Song.objects.first()
serializer = SongSerializer(song)
serializer.data
```

**æ‰“å° SQL æŸ¥è¯¢**ï¼š
```python
# settings.py ä¸´æ—¶å¼€å¯
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
        },
    },
    'loggers': {
        'django.db.backends': {
            'handlers': ['console'],
            'level': 'DEBUG',
        },
    },
}
```

**ä½¿ç”¨ pdb æ–­ç‚¹**ï¼š
```python
import pdb; pdb.set_trace()

# å¸¸ç”¨å‘½ä»¤ï¼š
# n (next) - æ‰§è¡Œä¸‹ä¸€è¡Œ
# s (step) - è¿›å…¥å‡½æ•°
# c (continue) - ç»§ç»­æ‰§è¡Œ
# p variable - æ‰“å°å˜é‡
# l (list) - æ˜¾ç¤ºä»£ç ä¸Šä¸‹æ–‡
```

#### æŠ€èƒ½ 2ï¼šå‰ç«¯è°ƒè¯•

**Chrome DevTools å¿…ç”¨åŠŸèƒ½**ï¼š
1. **Network é¢æ¿**ï¼šæŸ¥çœ‹ API è¯·æ±‚/å“åº”
2. **Console é¢æ¿**ï¼šæŸ¥çœ‹æ—¥å¿—å’Œé”™è¯¯
3. **Sources é¢æ¿**ï¼šæ–­ç‚¹è°ƒè¯•
4. **React DevTools**ï¼šæŸ¥çœ‹ç»„ä»¶æ ‘å’Œ Props

**React è°ƒè¯•æŠ€å·§**ï¼š
```typescript
// ä½¿ç”¨ useEffect è¿½è¸ªçŠ¶æ€å˜åŒ–
useEffect(() => {
    console.log('songs å˜åŒ–äº†:', songs);
}, [songs]);

// ä½¿ç”¨ debugger æ–­ç‚¹
const handleClick = () => {
    debugger;  // åœ¨è¿™é‡Œæš‚åœ
    setCount(count + 1);
};
```

#### æŠ€èƒ½ 3ï¼šæ—¥å¿—åˆ†æ

**åç«¯æ—¥å¿—**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f logs/django.log

# æŸ¥æ‰¾é”™è¯¯
grep ERROR logs/django.log
```

**å‰ç«¯æ—¥å¿—**ï¼š
```bash
# è¿‡æ»¤ç‰¹å®šæ—¥å¿—
grep "songService" 
```

### ç¬¬ 7 å‘¨ï¼šå®Œæ•´åŠŸèƒ½å¼€å‘å®æˆ˜

#### å®æˆ˜ä»»åŠ¡ï¼šæ·»åŠ "æ­Œæ›²æ”¶è—"åŠŸèƒ½

**éœ€æ±‚**ï¼šç”¨æˆ·å¯ä»¥æ”¶è—/å–æ¶ˆæ”¶è—æ­Œæ›²

**æ­¥éª¤ 1ï¼šåç«¯å¼€å‘**
```python
# 1. æ·»åŠ æ¨¡å‹å­—æ®µ
# song_management/models/song.py
class Song(models.Model):
    # ... åŸæœ‰å­—æ®µ
    is_favorite = models.BooleanField(default=False, verbose_name='æ˜¯å¦æ”¶è—')

# 2. åˆ›å»ºè¿ç§»
python manage.py makemigrations
python manage.py migrate

# 3. æ›´æ–°åºåˆ—åŒ–å™¨
# song_management/api/serializers.py
class SongSerializer(serializers.ModelSerializer):
    class Meta:
        model = Song
        fields = ['id', 'song_name', ..., 'is_favorite']  # æ·»åŠ æ–°å­—æ®µ

# 4. æ·»åŠ  API
# song_management/api/song_views.py
class ToggleFavoriteView(APIView):
    def post(self, request, song_id):
        song = Song.objects.get(id=song_id)
        song.is_favorite = not song.is_favorite
        song.save()
        return Response({'is_favorite': song.is_favorite})

# 5. æ·»åŠ è·¯ç”±
path('songs/<int:song_id>/favorite/', ToggleFavoriteView.as_view()),
```

**æ­¥éª¤ 2ï¼šå‰ç«¯å¼€å‘**
```typescript
// 1. æ›´æ–°ç±»å‹
// domain/types.ts
interface Song {
    // ... åŸæœ‰å­—æ®µ
    isFavorite: boolean;
}

// 2. æ·»åŠ  API æ–¹æ³•
// infrastructure/api/RealSongService.ts
async toggleFavorite(songId: string): Promise<ApiResult<{isFavorite: boolean}>> {
    const result = await apiClient.post<{isFavorite: boolean}>(
        `/songs/${songId}/favorite/`
    );
    return result;
}

// 3. æ·»åŠ ç»„ä»¶
// presentation/components/SongCard.tsx
const SongCard: React.FC<{song: Song}> = ({ song }) => {
    const [isFavorite, setIsFavorite] = useState(song.isFavorite);
    
    const handleToggle = async () => {
        const result = await songService.toggleFavorite(song.id);
        if (result.data) {
            setIsFavorite(result.data.isFavorite);
        }
    };
    
    return (
        <div className="song-card">
            <h3>{song.name}</h3>
            <button onClick={handleToggle}>
                {isFavorite ? 'â¤ï¸' : 'ğŸ¤'}
            </button>
        </div>
    );
};
```

**æ­¥éª¤ 3ï¼šæµ‹è¯•éªŒè¯**
- [ ] API æµ‹è¯•ï¼šç”¨ curl æˆ– Postman æµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•ï¼šèƒ½æ­£ç¡®åˆ‡æ¢æ”¶è—çŠ¶æ€
- [ ] å‰ç«¯æµ‹è¯•ï¼šç‚¹å‡»æŒ‰é’®åˆ‡æ¢å›¾æ ‡
- [ ] æŒä¹…åŒ–æµ‹è¯•ï¼šåˆ·æ–°é¡µé¢çŠ¶æ€ä¿æŒ

---

## ç¬¬äº”é˜¶æ®µï¼šæºç æ·±åº¦ç†è§£ï¼ˆæŒç»­ï¼‰

### æ·±åº¦é˜…è¯»æ¸…å•

#### å¿…è¯»æºç ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

| ä¼˜å…ˆçº§ | æ–‡ä»¶ | å­¦ä¹ ç›®æ ‡ |
|-------|------|---------|
| P0 | `song_management/models/song.py` | æ¨¡å‹è®¾è®¡ã€å…³ç³»æ˜ å°„ |
| P0 | `song_management/api/song_views.py` | API å®ç°ã€æƒé™æ§åˆ¶ |
| P0 | `domain/types.ts` | å‰åç«¯ç±»å‹å¯¹åº” |
| P0 | `RealSongService.ts` | API è°ƒç”¨å°è£… |
| P1 | `gallery/models.py` | è‡ªå¼•ç”¨å¤–é”®ã€æ ‘å½¢ç»“æ„ |
| P1 | `core/responses.py` | ç»Ÿä¸€å“åº”æ ¼å¼ |
| P1 | `useData.ts` | SWR å°è£…æŠ€å·§ |
| P2 | `spider/run_tiered_crawler.py` | çˆ¬è™«ç­–ç•¥ |
| P2 | `infra/nginx/*.conf` | éƒ¨ç½²é…ç½® |

### æºç é˜…è¯»æ–¹æ³•

#### æ–¹æ³• 1ï¼šå¸¦ç€é—®é¢˜è¯»
```
ä¸è¦ï¼šä»å¤´åˆ°å°¾é€è¡Œé˜…è¯»
è¦ï¼š    å¸¦ç€å…·ä½“é—®é¢˜æ‰¾ç­”æ¡ˆ

ç¤ºä¾‹é—®é¢˜ï¼š
- "æ­Œæ›²åˆ—è¡¨çš„æ’åºæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ"
- "å›¾ç‰‡ç¼©ç•¥å›¾æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ"
- "ç™»å½•çŠ¶æ€æ˜¯å¦‚ä½•ä¿æŒçš„ï¼Ÿ"
```

#### æ–¹æ³• 2ï¼šæ–­ç‚¹è·Ÿè¸ªæ³•
```
1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€é¡µé¢
2. Network é¢æ¿æ‰¾åˆ°å¯¹åº” API è¯·æ±‚
3. åç«¯ä»£ç ä¸­æ‰“æ–­ç‚¹
4. åˆ·æ–°é¡µé¢ï¼Œé€æ­¥è·Ÿè¸ªä»£ç æ‰§è¡Œ
5. è®°å½•è°ƒç”¨æ ˆå’Œæ•°æ®å˜åŒ–
```

#### æ–¹æ³• 3ï¼šå¯¹æ¯”å­¦ä¹ æ³•
```
1. æ‰¾åˆ° AI ç”Ÿæˆçš„ä»£ç 
2. å¯¹æ¯”é¡¹ç›®ä¸­çš„ç±»ä¼¼åŠŸèƒ½
3. åˆ†æå·®å¼‚ï¼šä¸ºä»€ä¹ˆé¡¹ç›®è¿™æ ·å†™ï¼Ÿ
4. æ”¹å†™ AI ä»£ç ï¼Œä½¿å…¶ç¬¦åˆé¡¹ç›®è§„èŒƒ
```

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒå¡

### åç«¯å¸¸ç”¨å‘½ä»¤
```bash
# æ•°æ®åº“è¿ç§»
python manage.py makemigrations
python manage.py migrate

# Shell è°ƒè¯•
python manage.py shell

# åˆ›å»ºè¶…çº§ç”¨æˆ·
python manage.py createsuperuser

# æŸ¥çœ‹ SQL
python manage.py sqlmigrate app_name migration_number
```

### å‰ç«¯å¸¸ç”¨å‘½ä»¤
```bash
# å¼€å‘æ¨¡å¼
npm run dev

# æ„å»º
npm run build

# ç±»å‹æ£€æŸ¥
npx tsc --noEmit
```

### è°ƒè¯•æŠ€å·§é€ŸæŸ¥
```python
# Django æ‰“å° SQL
from django.db import connection
print(connection.queries)

# Django æ€§èƒ½åˆ†æ
from django.db import connection
queries = len(connection.queries)
# æ‰§è¡Œæ“ä½œ
print(f"æ‰§è¡Œäº† {len(connection.queries) - queries} æ¬¡æŸ¥è¯¢")
```

```typescript
// React æ€§èƒ½åˆ†æ
import { Profiler } from 'react';

const onRender = (id, phase, actualDuration) => {
    console.log(id, phase, actualDuration);
};

<Profiler id="App" onRender={onRender}>
    <App />
</Profiler>
```

---

## æ€»ç»“

### å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬è·¯çº¿åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

**åç«¯èƒ½åŠ›**ï¼š
- [ ] ç‹¬ç«‹æ·»åŠ æ–°çš„ Model å­—æ®µå¹¶è¿ç§»
- [ ] ç¼–å†™æ–°çš„ API View å’Œ Serializer
- [ ] ä½¿ç”¨ Django Shell è°ƒè¯•æ•°æ®é—®é¢˜
- [ ] ç†è§£é¡¹ç›®ä¸­ä»»æ„åç«¯ä»£ç çš„ä½œç”¨

**å‰ç«¯èƒ½åŠ›**ï¼š
- [ ] ç‹¬ç«‹æ·»åŠ æ–°çš„é¡µé¢å’Œç»„ä»¶
- [ ] ä¿®æ”¹ç°æœ‰ç»„ä»¶çš„åŠŸèƒ½å’Œæ ·å¼
- [ ] ä½¿ç”¨ DevTools è°ƒè¯•å‰ç«¯é—®é¢˜
- [ ] ç†è§£ SWR çš„æ•°æ®æµ

**ç»¼åˆèƒ½åŠ›**ï¼š
- [ ] ç‹¬ç«‹å®Œæˆä¸€ä¸ªå®Œæ•´åŠŸèƒ½çš„å¼€å‘ï¼ˆå¦‚æ”¶è—åŠŸèƒ½ï¼‰
- [ ] æ’æŸ¥å¹¶ä¿®å¤ç®€å• Bug
- [ ] ä¸ä¾èµ– AI ä¿®æ”¹ç°æœ‰ä»£ç 
- [ ] å‘ä»–äººè§£é‡Šé¡¹ç›®æ¶æ„

### ä¸‹ä¸€æ­¥

å½“ä½ èƒ½ç‹¬ç«‹å®Œæˆä¸Šè¿°æ£€æŸ¥åï¼š
1. å°è¯•ä¸å€ŸåŠ© AIï¼Œä»å¤´å†™ä¸€ä¸ªå°åŠŸèƒ½
2. å‚ä¸ä»£ç å®¡æŸ¥ï¼Œç†è§£æœ€ä½³å®è·µ
3. é˜…è¯» Django å’Œ React å®˜æ–¹æ–‡æ¡£æ·±åŒ–ç†è®º
4. è€ƒè™‘æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•

ç¥å­¦ä¹ é¡ºåˆ©ï¼é‡åˆ°é—®é¢˜æ—¶ï¼Œå…ˆå°è¯•ç”¨ debugger è·Ÿè¸ªï¼Œå†æŸ¥é˜…æ–‡æ¡£ï¼Œæœ€åå†é—® AI "ä¸ºä»€ä¹ˆ"ã€‚
