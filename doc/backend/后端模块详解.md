# XXM Fans Home 后端模块详解

本文档详细介绍 XXM Fans Home 项目后端各功能模块的详细设计、数据模型和业务逻辑。

---

## 目录

1. [核心模块 (core)](#一核心模块-core)
2. [音乐资产管理 (song_management)](#二音乐资产管理-song_management)
3. [粉丝二创管理 (fansDIY)](#三粉丝二创管理-fansdiy)
4. [图集管理 (gallery)](#四图集管理-gallery)
5. [直播日历 (livestream)](#五直播日历-livestream)
6. [数据分析 (data_analytics)](#六数据分析-data_analytics)
7. [网站设置 (site_settings)](#七网站设置-site_settings)
8. [模板化歌单 (songlist)](#八模板化歌单-songlist)

---

## 一、核心模块 (core)

### 1.1 模块概述

core 模块是整个项目的共享基础设施，提供跨模块的通用功能和服务。

### 1.2 核心组件

| 组件 | 文件 | 功能描述 |
|------|------|----------|
| 缓存管理 | `cache.py` | Django 缓存封装，支持内存缓存和数据库缓存 |
| 异常处理 | `exceptions.py` | 自定义业务异常类 |
| 统一响应 | `responses.py` | API 统一响应格式封装 |
| 缩略图生成 | `thumbnail_generator.py` | 图片缩略图生成器 |
| 中间件 | `middleware.py` | 自定义请求/响应处理中间件 |

### 1.3 统一响应格式

```python
# 成功响应
{
    "success": true,
    "data": { ... },
    "message": "操作成功"
}

# 错误响应
{
    "success": false,
    "error": {
        "code": "ERROR_CODE",
        "message": "错误描述"
    }
}

# 分页响应
{
    "success": true,
    "data": { ... },
    "pagination": {
        "page": 1,
        "page_size": 20,
        "total": 100,
        "total_pages": 5
    }
}
```

### 1.4 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                         core 模块数据流                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   API 请求                                                       │
│      │                                                          │
│      ▼                                                          │
│   ┌──────────────┐                                              │
│   │   Middleware │  ← 请求处理、日志记录、CORS处理               │
│   └──────┬───────┘                                              │
│          │                                                      │
│          ▼                                                      │
│   ┌──────────────┐                                              │
│   │    Views     │  ← 业务视图                                   │
│   └──────┬───────┘                                              │
│          │                                                      │
│          ▼                                                      │
│   ┌──────────────────────────────────────────┐                  │
│   │              响应处理                     │                  │
│   │  ┌──────────────┐  ┌──────────────┐     │                  │
│   │  │ success_     │  │   error_     │     │                  │
│   │  │ response()   │  │  response()  │     │                  │
│   │  └──────────────┘  └──────────────┘     │                  │
│   └──────────────────────────────────────────┘                  │
│                                                                 │
│   辅助服务                                                       │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│   │    Cache     │  │ Thumbnail    │  │  Exceptions  │         │
│   │   缓存服务    │  │  缩略图生成   │  │   异常处理   │         │
│   └──────────────┘  └──────────────┘  └──────────────┘         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、音乐资产管理 (song_management)

### 2.1 模块概述

音乐资产管理模块是项目的核心业务模块，负责管理音乐作品信息、演唱记录、曲风分类和标签系统。

### 2.2 数据模型

#### 2.2.1 Song（歌曲模型）

```python
class Song(models.Model):
    song_name        # 歌曲名称 (CharField)
    singer           # 歌手 (CharField)
    first_perform    # 首次演唱时间 (DateField)
    last_performed   # 最近演唱时间 (DateField)
    perform_count    # 演唱次数 (IntegerField)
    language         # 语言 (CharField)
```

**索引设计**：
- `song_name` - 歌曲名称搜索
- `singer` - 歌手筛选
- `language` - 语言筛选

#### 2.2.2 SongRecord（演唱记录模型）

```python
class SongRecord(models.Model):
    song             # 外键 → Song
    performed_at     # 演唱时间 (DateField)
    url              # 视频链接 (URLField)
    notes            # 备注 (TextField)
    cover_url        # 封面URL (CharField)
```

**索引设计**：
- `song` + `performed_at` (倒序) - 按歌曲查记录
- `performed_at` - 按日期查记录

#### 2.2.3 Style（曲风模型）

```python
class Style(models.Model):
    name             # 曲风名称 (CharField)
    description      # 描述 (TextField)
```

#### 2.2.4 Tag（标签模型）

```python
class Tag(models.Model):
    name             # 标签名称 (CharField)
    description      # 描述 (TextField)
```

#### 2.2.5 OriginalWork（原创作品模型）

```python
class OriginalWork(models.Model):
    title            # 作品标题 (CharField)
    description      # 作品描述 (TextField)
    cover_url        # 封面URL (CharField)
    release_date     # 发布日期 (DateField)
    music_url        # 音乐链接 (URLField)
    video_url        # 视频链接 (URLField)
```

### 2.3 模型关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                    song_management 模型关系                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌──────────────┐                                              │
│   │     Song     │◄─────────────────────────┐                   │
│   │   歌曲信息    │                          │                   │
│   └──────┬───────┘                          │                   │
│          │ 1:N                              │                   │
│          │                                  │                   │
│          ▼                                  │                   │
│   ┌──────────────┐         ┌──────────────┐ │                   │
│   │  SongRecord  │         │     Tag      │─┘                   │
│   │   演唱记录    │         │    标签      │                     │
│   └──────────────┘         └──────────────┘                     │
│                                                                 │
│   ┌──────────────┐         ┌──────────────┐                     │
│   │    Style     │         │ OriginalWork │                     │
│   │    曲风       │         │   原创作品   │                     │
│   └──────────────┘         └──────────────┘                     │
│                                                                 │
│   多对多关系：                                                   │
│   Song ←── SongStyle ──► Style                                  │
│   Song ←── SongTag ────► Tag                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.4 API 接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/songs/` | GET | 歌曲列表（支持搜索、筛选、分页、排序） |
| `/api/songs/<id>/` | GET | 歌曲详情 |
| `/api/songs/<id>/records/` | GET | 歌曲演唱记录 |
| `/api/top_songs/` | GET | 排行榜（按演唱次数排序） |
| `/api/random-song/` | GET | 随机歌曲 |
| `/api/styles/` | GET | 曲风列表 |
| `/api/tags/` | GET | 标签列表 |
| `/api/originals/` | GET | 原创作品列表 |

### 2.5 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                  song_management 数据流                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 歌曲列表查询流程                                            │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐   │
│   │  前端    │───▶│  API    │───▶│ Service │───▶│  Model  │   │
│   │ 请求参数 │    │ 校验参数 │    │ 构建查询 │    │ 执行查询 │   │
│   └─────────┘    └─────────┘    └─────────┘    └────┬────┘   │
│                                                      │         │
│   参数：                                             ▼         │
│   - search (歌曲名称搜索)                        ┌─────────┐   │
│   - language (语言筛选)                          │ SQLite  │   │
│   - style (曲风筛选)                             └────┬────┘   │
│   - tag (标签筛选)                                    │         │
│   - sort (排序方式)                                   ▼         │
│   - page/page_size (分页)                      ┌─────────┐     │
│                                                │  返回   │     │
│   2. 演唱记录查询流程                          │  结果集 │     │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    └────┬────┘   │
│   │  前端    │───▶│  API    │───▶│ Service │◀───────┘         │
│   │ 请求ID  │    │ 校验ID  │    │ 关联查询 │                  │
│   └─────────┘    └─────────┘    └────┬────┘                  │
│                                      │                         │
│                                      ▼                         │
│                                ┌─────────────┐                 │
│                                │ Song.records│                 │
│                                │ .select_related('song')       │
│                                └─────────────┘                 │
│                                                                 │
│   3. 排行榜数据流                                                │
│   ┌─────────┐    ┌─────────────────────────┐    ┌─────────┐   │
│   │  前端    │───▶│  Service.top_songs()    │───▶│  Cache  │   │
│   │ 请求排行 │    │  - 按perform_count排序   │    │  (缓存) │   │
│   └─────────┘    │  - 限制返回数量          │    └─────────┘   │
│                  └─────────────────────────┘                   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.6 Admin 功能

- **合并作品**：将多个歌曲合并为一个
- **拆分作品**：将一个歌曲拆分为多个
- **批量标记**：批量设置曲风、标签
- **BV号导入**：从B站导入演唱记录

---

## 三、粉丝二创管理 (fansDIY)

### 3.1 模块概述

粉丝二创管理模块用于管理粉丝创作的二创作品，支持合集分类和作品管理。

### 3.2 数据模型

#### 3.2.1 Collection（合集模型）

```python
class Collection(models.Model):
    name             # 合集名称 (CharField)
    description      # 描述 (TextField)
    cover_url        # 封面URL (CharField)
    works_count      # 作品数量 (IntegerField)
    sort_order       # 排序 (IntegerField)
```

#### 3.2.2 Work（作品模型）

```python
class Work(models.Model):
    collection       # 外键 → Collection
    title            # 作品标题 (CharField)
    cover_url        # 封面URL (CharField)
    view_url         # 观看链接 (URLField)
    author           # 作者 (CharField)
    notes            # 备注 (TextField)
    display_order    # 显示顺序 (IntegerField)
    position         # 位置 (IntegerField)
```

### 3.3 模型关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                      fansDIY 模型关系                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────┐                                           │
│   │   Collection    │                                           │
│   │    二创合集     │                                           │
│   │                 │                                           │
│   │ - name          │                                           │
│   │ - description   │                                           │
│   │ - cover_url     │                                           │
│   │ - works_count   │◄── 自动统计                               │
│   └────────┬────────┘                                           │
│            │ 1:N                                                │
│            │                                                     │
│            ▼                                                     │
│   ┌─────────────────┐                                           │
│   │      Work       │                                           │
│   │    二创作品     │                                           │
│   │                 │                                           │
│   │ - title         │                                           │
│   │ - author        │                                           │
│   │ - view_url      │                                           │
│   │ - cover_url     │                                           │
│   └─────────────────┘                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.4 API 接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/fansDIY/collections/` | GET | 合集列表 |
| `/api/fansDIY/collections/<id>/` | GET | 合集详情 |
| `/api/fansDIY/works/` | GET | 作品列表 |
| `/api/fansDIY/works/<id>/` | GET | 作品详情 |

### 3.5 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                    fansDIY 数据流                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 合集列表查询                                                │
│   ┌─────────┐    ┌─────────┐    ┌─────────────────────────┐    │
│   │  前端    │───▶│  API    │───▶│  Collection.objects     │    │
│   │ 请求    │    │ 无参数  │    │  .filter(is_active=True)│    │
│   └─────────┘    └─────────┘    │  .order_by('sort_order')│    │
│                                 └─────────────────────────┘    │
│                                                                 │
│   2. 合集详情（含作品列表）                                       │
│   ┌─────────┐    ┌─────────┐    ┌─────────────────────────┐    │
│   │  前端    │───▶│  API    │───▶│  Collection.objects     │    │
│   │ 请求ID  │    │ 校验ID  │    │  .select_related()      │    │
│   └─────────┘    └─────────┘    │  .prefetch_related('works')   │
│                                 └─────────────────────────┘    │
│                                                                 │
│   3. 作品数量自动更新                                            │
│   ┌─────────┐         ┌─────────────────────────┐              │
│   │  Work   │────────▶│  collection.update_     │              │
│   │ 保存/删除 │触发信号  │  works_count()          │              │
│   └─────────┘         └─────────────────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、图集管理 (gallery)

### 4.1 模块概述

图集管理模块支持多级分类的图集系统，用于管理图片资源和相册展示。

### 4.2 数据模型

#### 4.2.1 Gallery（图集模型）

```python
class Gallery(models.Model):
    id               # 图集ID (CharField, PrimaryKey)
    title            # 标题 (CharField)
    description      # 描述 (TextField)
    cover_url        # 封面URL (CharField)
    parent           # 自引用外键，父图集
    level            # 层级 (IntegerField, 自动计算)
    image_count      # 图片数量 (IntegerField)
    folder_path      # 文件夹路径 (CharField)
    tags             # 标签 (JSONField)
    sort_order       # 排序 (IntegerField)
    is_active        # 是否启用 (BooleanField)
```

**核心特性**：
- 自引用外键实现多级层级
- 自动计算层级 (level)
- 自动统计图片数量（含子图集）
- 支持图片和视频格式

### 4.3 模型关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                      gallery 模型关系                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                        ┌──────────────┐                         │
│                        │    Root      │                         │
│                        │   (根图集)    │                         │
│                        └──────┬───────┘                         │
│                               │                                 │
│              ┌────────────────┼────────────────┐                │
│              │                │                │                │
│              ▼                ▼                ▼                │
│       ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │
│       │   演唱会图集  │ │   日常图集    │ │   活动图集    │       │
│       │   level=1    │ │   level=1    │ │   level=1    │       │
│       └──────┬───────┘ └──────────────┘ └──────┬───────┘       │
│              │                                  │                │
│              ▼                                  ▼                │
│       ┌──────────────┐                   ┌──────────────┐       │
│       │  2024演唱会  │                   │  生日会图集  │       │
│       │  level=2     │                   │  level=2     │       │
│       └──────────────┘                   └──────────────┘       │
│                                                                 │
│   说明：                                                          │
│   - 支持无限层级                                                  │
│   - 叶子节点存储实际图片                                           │
│   - 父节点自动汇总子节点图片数量                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.4 核心方法

| 方法 | 描述 |
|------|------|
| `get_images()` | 获取图集下的所有图片 |
| `add_image()` | 添加图片到图集（并发安全） |
| `delete_image()` | 删除图集中的图片 |
| `update_cover()` | 更新封面图片 |
| `refresh_image_count()` | 刷新图片数量（递归更新） |
| `get_breadcrumbs()` | 获取面包屑导航路径 |
| `get_descendants()` | 获取所有后代节点 |
| `get_ancestors()` | 获取所有祖先节点 |

### 4.5 API 接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/gallery/` | GET | 图集列表 |
| `/api/gallery/<id>/` | GET | 图集详情 |
| `/api/gallery/<id>/items/` | GET | 图集图片列表 |
| `/api/gallery/sync/` | POST | 同步文件夹图片到数据库 |
| `/api/gallery/thumbnail/` | GET | 获取图片缩略图 |

### 4.6 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                      gallery 数据流                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 图集列表查询（层级结构）                                     │
│   ┌─────────┐    ┌─────────┐    ┌─────────────────────────┐    │
│   │  前端    │───▶│  API    │───▶│  Gallery.objects        │    │
│   │ 请求    │    │ 无参数  │    │  .filter(parent=None)   │    │
│   └─────────┘    └─────────┘    │  .order_by('sort_order')│    │
│                                 └─────────────────────────┘    │
│                                          │                      │
│                                          ▼                      │
│                                   ┌─────────────┐              │
│                                   │ 递归查询子图集 │              │
│                                   │ (BFS/DFS)   │              │
│                                   └─────────────┘              │
│                                                                 │
│   2. 图片数量统计（自动递归）                                     │
│   ┌───────────────────────────────────────────────────────┐    │
│   │                  refresh_image_count()                 │    │
│   │                                                         │    │
│   │  1. DFS 收集所有需要更新的节点                           │    │
│   │  2. 按层级降序排序（叶子节点优先）                        │    │
│   │  3. 叶子节点：直接统计文件夹图片数量                      │    │
│   │  4. 父节点：汇总所有子节点的 image_count                 │    │
│   │  5. 批量更新数据库                                       │    │
│   │                                                         │    │
│   │  ┌──────────┐    ┌──────────┐    ┌──────────┐          │    │
│   │  │ 叶子节点  │───▶│ 父节点A  │───▶│ 父节点B  │          │    │
│   │  │ count=10 │    │ count=25 │    │ count=40 │          │    │
│   │  └──────────┘    └──────────┘    └──────────┘          │    │
│   │                          ▲         ▲                   │    │
│   │                          │         │                   │    │
│   │                   ┌──────┘         └──────┐            │    │
│   │                   │                       │            │    │
│   │              ┌──────────┐            ┌──────────┐      │    │
│   │              │ 叶子节点  │            │ 叶子节点  │      │    │
│   │              │ count=15 │            │ count=15 │      │    │
│   │              └──────────┘            └──────────┘      │    │
│   └───────────────────────────────────────────────────────┘    │
│                                                                 │
│   3. 图片添加（并发安全）                                         │
│   ┌───────────────────────────────────────────────────────┐    │
│   │                     add_image()                        │    │
│   │                                                         │    │
│   │  1. select_for_update() 锁定当前图集记录               │    │
│   │  2. 在锁内获取下一个可用编号                            │    │
│   │  3. 检查文件是否存在（极端并发情况）                     │    │
│   │  4. 保存图片文件                                        │    │
│   │  5. 更新图片数量统计                                    │    │
│   │                                                         │    │
│   └───────────────────────────────────────────────────────┘    │
│                                                                 │
│   4. 缩略图生成                                                   │
│   ┌─────────┐    ┌─────────────────┐    ┌─────────────────┐   │
│   │  前端    │───▶│  /api/gallery/  │───▶│ ThumbnailGenerator│   │
│   │ 请求缩略图│    │  /thumbnail/    │    │ 生成缩略图并缓存  │   │
│   └─────────┘    └─────────────────┘    └─────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 五、直播日历 (livestream)

### 5.1 模块概述

直播日历模块用于管理直播记录、回放信息和相关资源，支持日历视图和详情展示。

### 5.2 数据模型

```python
class Livestream(models.Model):
    # 基础信息
    date                 # 直播日期 (DateField, Unique)
    title                # 直播标题 (CharField)
    summary              # 直播简介 (TextField)
    
    # B站视频信息
    bvid                 # B站视频BV号 (CharField)
    duration_seconds     # 直播时长（秒）(IntegerField)
    duration_formatted   # 格式化时长 (CharField)
    parts                # 视频分段数 (IntegerField)
    
    # LiveMoment 图册
    live_moment          # LiveMoment 图册目录 (CharField)
    
    # 回放封面
    cover_url            # 回放封面URL (CharField)
    
    # 统计数据
    view_count           # 观看人数 (CharField)
    danmaku_count        # 弹幕数 (CharField)
    
    # 时间信息
    start_time           # 开播时间 (TimeField)
    end_time             # 下播时间 (TimeField)
    
    # 弹幕云图
    danmaku_cloud_url    # 弹幕云图URL (CharField)
    
    # 元数据
    is_active            # 是否启用 (BooleanField)
    sort_order           # 排序 (IntegerField)
```

### 5.3 模型关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                    livestream 模型关系                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌───────────────────────────────────────────────────────────┐ │
│   │                      Livestream                           │ │
│   │                      直播记录                              │ │
│   │                                                           │ │
│   │  ┌─────────────────┐  ┌─────────────────┐                │ │
│   │  │   基础信息       │  │   B站视频信息    │                │ │
│   │  │  - date         │  │  - bvid         │                │ │
│   │  │  - title        │  │  - duration     │                │ │
│   │  │  - summary      │  │  - parts        │                │ │
│   │  └─────────────────┘  └─────────────────┘                │ │
│   │                                                           │ │
│   │  ┌─────────────────┐  ┌─────────────────┐                │ │
│   │  │   统计数据       │  │   关联资源       │                │ │
│   │  │  - view_count   │  │  - live_moment  │───► 直播截图    │ │
│   │  │  - danmaku_count│  │  - cover_url    │                │ │
│   │  └─────────────────┘  └─────────────────┘                │ │
│   │                                                           │ │
│   │  ┌─────────────────┐                                      │ │
│   │  │   关联数据       │                                      │ │
│   │  │  - get_song_cuts│───► SongRecord (当日歌切)            │ │
│   │  │  - get_screenshots│                                    │ │
│   │  └─────────────────┘                                      │ │
│   └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.4 API 接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/livestream/` | GET | 直播记录列表 |
| `/api/livestream/<id>/` | GET | 直播记录详情 |
| `/api/livestream/calendar/` | GET | 直播日历数据 |
| `/api/livestream/<id>/segments/` | GET | 分段视频列表 |
| `/api/livestream/<id>/song-cuts/` | GET | 当日歌切列表 |
| `/api/livestream/<id>/screenshots/` | GET | 直播截图列表 |

### 5.5 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                    livestream 数据流                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 直播日历查询                                                │
│   ┌─────────┐    ┌─────────┐    ┌─────────────────────────┐    │
│   │  前端    │───▶│  API    │───▶│  Livestream.objects     │    │
│   │ 月份参数 │    │ 校验参数 │    │  .filter(               │    │
│   └─────────┘    └─────────┘    │    date__year=year,      │    │
│                                 │    date__month=month      │    │
│                                 │  ).order_by('-date')      │    │
│                                 └─────────────────────────┘    │
│                                                                 │
│   2. 直播详情查询（含关联数据）                                   │
│   ┌─────────┐    ┌─────────┐    ┌─────────────────────────┐    │
│   │  前端    │───▶│  API    │───▶│  to_dict(include_       │    │
│   │ 日期ID  │    │ 校验ID  │    │       details=True)     │    │
│   └─────────┘    └─────────┘    └─────────────────────────┘    │
│                                          │                      │
│                                          ▼                      │
│                                   ┌─────────────┐              │
│                                   │ 1. 基础信息  │              │
│                                   │ 2. recordings│              │
│                                   │ 3. songCuts │              │
│                                   │ 4. screenshots│             │
│                                   │ 5. danmakuCloud│            │
│                                   └─────────────┘              │
│                                                                 │
│   3. 当日歌切查询                                                │
│   ┌───────────────────────────────────────────────────────┐    │
│   │                    get_song_cuts()                     │    │
│   │                                                         │    │
│   │  SongRecord.objects.filter(                            │    │
│   │      performed_at=self.date                            │    │
│   │  ).select_related('song')                              │    │
│   │  .order_by('song__song_name')                          │    │
│   │                                                         │    │
│   └───────────────────────────────────────────────────────┘    │
│                                                                 │
│   4. 直播截图查询                                                │
│   ┌───────────────────────────────────────────────────────┐    │
│   │                   get_screenshots()                    │    │
│   │                                                         │    │
│   │  1. 读取 live_moment 目录                              │    │
│   │  2. 过滤图片文件 (*.jpg, *.png, etc.)                   │    │
│   │  3. 生成缩略图 URL                                      │    │
│   │  4. 返回 [{url, thumbnailUrl}, ...]                    │    │
│   │                                                         │    │
│   └───────────────────────────────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 六、数据分析 (data_analytics)

### 6.1 模块概述

数据分析模块负责 B站数据爬取、粉丝数追踪、作品数据统计和爬虫任务管理。

### 6.2 数据模型

#### 6.2.1 WorkStatic（作品静态信息）

```python
class WorkStatic(models.Model):
    platform         # 平台 (CharField)
    work_id          # 作品ID (CharField)
    title            # 标题 (CharField)
    author           # 作者 (CharField)
    publish_time     # 发布时间 (DateTimeField)
    cover_url        # 封面URL (CharField)
    is_valid         # 投稿是否有效 (BooleanField)
```

#### 6.2.2 WorkMetricsHour（小时级指标）

```python
class WorkMetricsHour(models.Model):
    work_static      # 外键 → WorkStatic
    crawl_session    # 外键 → CrawlSession
    recorded_at      # 记录时间 (DateTimeField)
    view_count       # 播放量 (BigIntegerField)
    like_count       # 点赞数 (BigIntegerField)
    coin_count       # 投币数 (BigIntegerField)
    favorite_count   # 收藏数 (BigIntegerField)
    share_count      # 分享数 (BigIntegerField)
    comment_count    # 评论数 (BigIntegerField)
    danmaku_count    # 弹幕数 (BigIntegerField)
```

#### 6.2.3 FollowerMetrics（粉丝数指标）

```python
class FollowerMetrics(models.Model):
    platform         # 平台 (CharField)
    account_id       # 账号ID (CharField)
    recorded_at      # 记录时间 (DateTimeField)
    follower_count   # 粉丝数 (BigIntegerField)
```

#### 6.2.4 CrawlSession（爬取会话）

```python
class CrawlSession(models.Model):
    started_at       # 开始时间 (DateTimeField)
    completed_at     # 完成时间 (DateTimeField)
    status           # 状态 (CharField)
    total_works      # 总作品数 (IntegerField)
    success_count    # 成功数 (IntegerField)
    failed_count     # 失败数 (IntegerField)
```

### 6.3 模型关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                   data_analytics 模型关系                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────┐         ┌─────────────────┐              │
│   │   CrawlSession  │◄────────│ WorkMetricsHour │              │
│   │    爬取会话      │   1:N   │   小时级指标     │              │
│   │                 │         │                 │              │
│   │ - started_at    │         │ - view_count    │              │
│   │ - status        │         │ - like_count    │              │
│   │ - total_works   │         │ - coin_count    │              │
│   └─────────────────┘         └────────┬────────┘              │
│                                        │                        │
│                                        │ N:1                    │
│                                        ▼                        │
│                              ┌─────────────────┐               │
│                              │    WorkStatic   │               │
│                              │   作品静态信息   │               │
│                              │                 │               │
│                              │ - platform      │               │
│                              │ - work_id       │               │
│                              │ - title         │               │
│                              │ - author        │               │
│                              │ - publish_time  │               │
│                              └─────────────────┘               │
│                                                                 │
│   ┌─────────────────┐                                           │
│   │ FollowerMetrics │                                           │
│   │   粉丝数指标     │                                           │
│   │                 │                                           │
│   │ - platform      │                                           │
│   │ - follower_count│                                           │
│   │ - recorded_at   │                                           │
│   └─────────────────┘                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.4 爬虫分层策略

```
┌─────────────────────────────────────────────────────────────────┐
│                    爬虫分层策略                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   数据分类              发布时间              爬取频率            │
│   ┌──────────────┐     ┌──────────┐        ┌──────────┐        │
│   │   热数据      │     │ ≤ 7天    │   ────▶│ 每小时   │        │
│   │   (Hot)      │     │          │        │          │        │
│   └──────────────┘     └──────────┘        └──────────┘        │
│                                                                 │
│   ┌──────────────┐     ┌──────────┐        ┌──────────┐        │
│   │   冷数据      │     │ > 7天    │   ────▶│ 每天3次  │        │
│   │   (Cold)     │     │          │        │ 00:00    │        │
│   └──────────────┘     └──────────┘        │ 08:00    │        │
│                                            │ 16:00    │        │
│                                            └──────────┘        │
│                                                                 │
│   优势：                                                         │
│   - 大幅降低服务器压力（平时每小时只爬取0-1条）                    │
│   - 保证新作品实时性                                             │
│   - 历史数据适度更新                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.5 API 接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/data-analytics/works/` | GET | 作品统计列表 |
| `/api/data-analytics/works/<id>/metrics/` | GET | 作品小时级指标 |
| `/api/data-analytics/followers/` | GET | 粉丝数历史数据 |
| `/api/data-analytics/dashboard/` | GET | 数据仪表盘 |

### 6.6 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                   data_analytics 数据流                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 爬虫任务调度                                                │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │              systemd timer (定时任务)                    │  │
│   │                                                         │  │
│   │  bilibili-tiered-crawler.timer ──▶ 每小时执行           │  │
│   │  bilibili-views-crawler.timer ───▶ 每天3次              │  │
│   │  bilibili-spider.timer ──────────▶ 粉丝数爬取           │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                  run_tiered_crawler.py                   │  │
│   │                                                         │  │
│   │  1. 根据当前时间判断执行策略                             │  │
│   │  2. 热数据模式：查询近7天作品，每小时爬取                  │  │
│   │  3. 冷数据模式：查询7天前作品，分批爬取                    │  │
│   │  4. 调用 B站 API 获取数据                                │  │
│   │  5. 保存到 WorkMetricsHour                               │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                     数据存储流程                         │  │
│   │                                                         │  │
│   │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │  │
│   │  │  CrawlSession│───▶│ WorkMetrics │───▶│ WorkStatic  │ │  │
│   │  │  (创建记录)  │    │  (保存指标) │    │ (更新静态信息)│ │  │
│   │  └─────────────┘    └─────────────┘    └─────────────┘ │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   2. 数据查询流程                                                │
│   ┌─────────┐    ┌─────────┐    ┌─────────────────────────┐    │
│   │  前端    │───▶│  API    │───▶│  WorkMetricsHour.objects│    │
│   │ 查询参数│    │ 校验参数 │    │  .filter(work_static=work)│   │
│   └─────────┘    └─────────┘    │  .order_by('-recorded_at')│   │
│                                 └─────────────────────────┘    │
│                                                                 │
│   3. 粉丝数追踪                                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │              get_bilibili_fans_count.py                  │  │
│   │                                                         │  │
│   │  1. 调用 B站 API 获取粉丝数                              │  │
│   │  2. 创建 FollowerMetrics 记录                           │  │
│   │  3. 支持历史趋势分析                                     │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 七、网站设置 (site_settings)

### 7.1 模块概述

网站设置模块管理全局配置和个性化推荐内容。

### 7.2 数据模型

#### 7.2.1 SiteSettings（网站设置）

```python
class SiteSettings(models.Model):
    key              # 配置键 (CharField, Unique)
    value            # 配置值 (TextField)
    description      # 描述 (TextField)
```

#### 7.2.2 Recommendation（推荐内容）

```python
class Recommendation(models.Model):
    title            # 标题 (CharField)
    subtitle         # 副标题 (CharField)
    image_url        # 图片URL (CharField)
    link_url         # 链接URL (CharField)
    type             # 类型 (CharField)
    sort_order       # 排序 (IntegerField)
    is_active        # 是否启用 (BooleanField)
```

### 7.3 API 接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/settings/` | GET | 获取网站设置 |
| `/api/recommendations/` | GET | 获取推荐内容 |

---

## 八、模板化歌单 (songlist)

### 8.1 模块概述

模板化歌单模块是一个配置驱动的动态模型系统，支持多歌手共享歌单模板，通过域名或 URL 参数区分不同歌手。

### 8.2 核心特性

- **配置驱动**：一行配置添加新艺术家
- **动态模型**：自动生成模型和 API
- **独立数据库**：songlist 使用独立数据库
- **独立权限**：每个艺术家独立的权限管理

### 8.3 配置示例

```python
# songlist/config.py
ARTISTS = {
    'xxm': {
        'name': '咻咻满',
        'db_table_prefix': 'xxm_',
        'display_name': '咻咻满的歌单',
    },
    'youyou': {
        'name': '油油',
        'db_table_prefix': 'youyou_',
        'display_name': '油油的歌单',
    },
    'bingjie': {
        'name': '饼姐',
        'db_table_prefix': 'bingjie_',
        'display_name': '饼姐的歌单',
    },
}
```

### 8.4 动态模型生成

```
┌─────────────────────────────────────────────────────────────────┐
│                  模板化歌单动态模型生成                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   配置文件                                                       │
│   ┌─────────────┐                                               │
│   │  ARTISTS    │                                               │
│   │  艺术家配置  │                                               │
│   └──────┬──────┘                                               │
│          │                                                      │
│          ▼                                                      │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    应用启动时                            │  │
│   │                                                         │  │
│   │  for artist_id, config in ARTISTS.items():             │  │
│   │      1. 动态创建 Song 模型                              │  │
│   │      2. 动态创建 Style 模型                             │  │
│   │      3. 动态创建 Language 模型                          │  │
│   │      4. 注册到 Django Admin                             │  │
│   │      5. 创建对应的 API 视图                             │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│          │                                                      │
│          ▼                                                      │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    生成的模型                            │  │
│   │                                                         │  │
│   │  xxm_songs    → 表: songlist_xxm_songs                 │  │
│   │  youyou_songs → 表: songlist_youyou_songs              │  │
│   │  bingjie_songs│ 表: songlist_bingjie_songs             │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 8.5 API 接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/songlist/songs/` | GET | 歌单音乐作品列表 |
| `/api/songlist/languages/` | GET | 语言列表 |
| `/api/songlist/styles/` | GET | 曲风列表 |
| `/api/songlist/random/` | GET | 随机音乐作品 |
| `/api/songlist/settings/` | GET | 网站设置 |

### 8.6 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                    songlist 数据流                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 请求路由                                                    │
│   ┌─────────┐    ┌─────────────────────────────────────────┐   │
│   │  前端    │───▶│  URL: /api/songlist/songs/?artist=xxm   │   │
│   │ 请求    │    │                                         │   │
│   └─────────┘    └─────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    URL 解析                              │  │
│   │                                                         │  │
│   │  1. 从 query string 获取 artist 参数                    │  │
│   │  2. 验证 artist 是否在配置中                             │  │
│   │  3. 获取对应的模型类                                     │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    查询数据                              │  │
│   │                                                         │  │
│   │  model = get_artist_model(artist_id)                   │  │
│   │  queryset = model.objects.all()                        │  │
│   │  # 应用过滤、排序、分页                                   │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              │                                  │
│                              ▼                                  │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                    序列化响应                            │  │
│   │                                                         │  │
│   │  使用动态生成的序列化器                                  │  │
│   │  返回统一的响应格式                                      │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   2. 独立数据库访问                                              │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │                                                         │  │
│   │   主数据库          songlist_db (独立)                   │  │
│   │  ┌───────────┐      ┌───────────┐                       │  │
│   │  │ song_mgmt │      │ xxm_songs │                       │  │
│   │  │ fansDIY   │      │youyou_songs│                      │  │
│   │  │ gallery   │      │bingjie_songs│                     │  │
│   │  └───────────┘      └───────────┘                       │  │
│   │                                                         │  │
│   │  使用 router 切换数据库连接                               │  │
│   │  using('songlist_db')                                   │  │
│   │                                                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 九、模块间数据流总结

### 9.1 整体数据流图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              后端模块间数据流总览                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   用户请求                                                                           │
│      │                                                                              │
│      ▼                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                              Nginx 反向代理                                  │  │
│   └─────────────────────────────────────────────────────────────────────────────┘  │
│      │                                                                              │
│      ├──────────────────┬──────────────────┬──────────────────┐                    │
│      ▼                  ▼                  ▼                  ▼                    │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐                   │
│   │   API    │    │  Admin   │    │  静态文件 │    │  媒体文件 │                   │
│   │  接口    │    │  后台    │    │          │    │          │                   │
│   └────┬─────┘    └──────────┘    └──────────┘    └──────────┘                   │
│        │                                                                           │
│        ├──────────────────┬──────────────────┬──────────────────┐                 │
│        ▼                  ▼                  ▼                  ▼                 │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐                   │
│   │song_mgmt │    │ fansDIY  │    │  gallery │    │livestream│ ...               │
│   │  歌曲管理 │    │ 二创管理 │    │  图集管理 │    │ 直播日历 │                   │
│   └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘                   │
│        │               │               │               │                          │
│        │               │               │               │                          │
│        ▼               ▼               ▼               ▼                          │
│   ┌─────────────────────────────────────────────────────────────┐                 │
│   │                         core 模块                           │                 │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │                 │
│   │  │  cache   │  │responses │  │thumbnail │  │exceptions│   │                 │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │                 │
│   └─────────────────────────────────────────────────────────────┘                 │
│        │                                                                           │
│        ▼                                                                           │
│   ┌─────────────────────────────────────────────────────────────┐                 │
│   │                        数据存储层                            │                 │
│   │  ┌─────────────────────────────────────────────────────────┐│                 │
│   │  │                    SQLite 数据库                         ││                 │
│   │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  ││                 │
│   │  │  │主数据库  │ │songlist  │ │  cache   │ │   logs   │  ││                 │
│   │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘  ││                 │
│   │  └─────────────────────────────────────────────────────────┘│                 │
│   │  ┌─────────────────────────────────────────────────────────┐│                 │
│   │  │                      文件系统                            ││                 │
│   │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  ││                 │
│   │  │  │  covers  │ │ gallery  │ │footprint │ │songlist  │  ││                 │
│   │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘  ││                 │
│   │  └─────────────────────────────────────────────────────────┘│                 │
│   └─────────────────────────────────────────────────────────────┘                 │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 跨模块调用关系

| 调用方 | 被调用方 | 调用场景 |
|--------|----------|----------|
| livestream | song_management | 获取当日歌切列表 |
| data_analytics | core | 使用缓存服务 |
| gallery | core | 使用缩略图生成器 |
| fansDIY | core | 使用统一响应格式 |
| song_management | core | 使用缩略图生成器 |
| 所有模块 | core | 使用异常处理 |

---

## 十、总结

XXM Fans Home 后端采用模块化设计，各模块职责清晰：

1. **core** - 共享基础设施，提供通用服务
2. **song_management** - 核心业务，管理音乐和演唱记录
3. **fansDIY** - 粉丝二创内容管理
4. **gallery** - 多级图集管理系统
5. **livestream** - 直播记录和资源管理
6. **data_analytics** - 数据爬取和统计分析
7. **site_settings** - 全局配置管理
8. **songlist** - 配置驱动的多歌手歌单系统

各模块间通过 core 模块共享通用功能，保持低耦合高内聚的设计原则。
