# 小满虫分布图功能实施方案

## 功能概述

"小满虫分布图"是一个通过IP地址统计访问网站的粉丝地理分布，并以地图可视化形式展现的数据分析功能。该功能可以展示：

- 国内粉丝来自哪些省份
- 国外粉丝来自哪些国家
- 访问热力分布图
- 详细的访问统计数据

## 技术架构

### 后端（Django）

1. **数据模型** (`data_analytics/models/visitor_geo.py`)
   - `VisitorGeo`: 存储每次访问的IP地址和地理位置信息
   - `GeoDistribution`: 按天统计各地区的访问次数（聚合数据）

2. **中间件** (`core/visitor_geo_middleware.py`)
   - 自动收集每个请求的IP地址和地理位置信息
   - 支持X-Forwarded-For获取真实IP
   - 排除静态文件和API请求的收集

3. **API接口** (`data_analytics/api/views.py`)
   - `/api/data-analytics/visitor-geo/distribution/`: 获取访客地理分布数据
   - `/api/data-analytics/visitor-geo/map/`: 获取地图可视化数据（包含经纬度）

### 前端（React + TypeScript）

1. **地图组件** (`presentation/pages/DataAnalysisPage/components/FanDistributionMap.tsx`)
   - 使用ECharts实现地图可视化
   - 支持中国地图和世界地图切换
   - 提供时间范围选择（7天、30天、90天、1年）
   - 展示统计卡片和详细数据表格

2. **数据服务** (`infrastructure/api/RealDataAnalyticsService.ts`)
   - 封装API调用逻辑
   - 提供类型安全的接口

## 部署步骤

### 1. 数据库迁移

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
python manage.py makemigrations data_analytics
python manage.py migrate
```

### 2. 配置中间件

编辑 `repo/xxm_fans_backend/xxm_fans_home/settings.py`，在 `MIDDLEWARE` 中添加：

```python
MIDDLEWARE = [
    # ... 其他中间件
    'core.visitor_geo_middleware.VisitorGeoMiddleware',
]
```

### 3. 安装前端依赖

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_frontend
npm install echarts
```

### 4. 配置IP地理位置服务（可选）

默认情况下，中间件使用测试数据。如需真实地理位置数据，需要集成第三方IP地理位置查询服务：

#### 方案一：使用IP2Location（推荐）

1. 安装IP2Location库：

```bash
pip install IP2Location
```

2. 下载IP2Location数据库文件（.BIN格式）

3. 修改 `core/visitor_geo_middleware.py` 中的 `_get_geo_info` 方法：

```python
import IP2Location

# 初始化IP2Location
database = IP2Location.IP2Location()
database.open("IP2LOCATION-LITE-DB5.BIN")

def _get_geo_info(self, ip_address):
    try:
        rec = database.get_all(ip_address)
        return {
            'country': rec.country_long,
            'country_code': rec.country_short,
            'region': rec.region,
            'city': rec.city,
            'latitude': rec.latitude,
            'longitude': rec.longitude,
            'isp': rec.isp
        }
    except:
        return self._get_default_geo_info()
```

#### 方案二：使用IPAPI（免费，需网络请求）

```python
import requests

def _get_geo_info(self, ip_address):
    try:
        response = requests.get(f'https://ipapi.co/{ip_address}/json/', timeout=2)
        if response.status_code == 200:
            data = response.json()
            return {
                'country': data.get('country_name', ''),
                'country_code': data.get('country_code', ''),
                'region': data.get('region', ''),
                'city': data.get('city', ''),
                'latitude': data.get('latitude'),
                'longitude': data.get('longitude'),
                'isp': data.get('org', '')
            }
    except:
        pass
    return self._get_default_geo_info()
```

### 5. 构建前端

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_frontend
npm run build
```

### 6. 重启服务

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/scripts
./dev_stop_services.sh
./dev_start_services.sh
```

## 功能使用

### 访问分布图

访问路径：`/data`（数据分析页面）

在数据分析页面中，可以看到"小满虫分布图"模块，包含：

1. **地图可视化**
   - 国内分布：显示各省份的访问热力
   - 全球分布：显示各国访问分布
   - 支持缩放和拖拽
   - 悬停显示详细数据

2. **统计卡片**
   - 总访问量
   - 独立访客数
   - 覆盖地区数
   - 统计天数

3. **控制面板**
   - 切换国内/全球视图
   - 选择时间范围（7天、30天、90天、1年）

4. **详细数据表格**
   - 地区名称
   - 访问次数
   - 独立访客数
   - 占比

### API接口

#### 获取地理分布数据

```http
GET /api/data-analytics/visitor-geo/distribution/?days=30&group_by=country
```

**参数：**
- `days`: 查询天数（1-365）
- `group_by`: 分组方式（'country' 或 'region'）
- `country`: 筛选特定国家（可选）

**返回示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "days": 30,
    "group_by": "country",
    "total_visits": 15000,
    "total_unique_visitors": 8500,
    "geo_distribution": [
      {
        "country": "中国",
        "country_code": "CN",
        "visit_count": 12000,
        "unique_visitor_count": 6800
      },
      {
        "country": "美国",
        "country_code": "US",
        "visit_count": 1500,
        "unique_visitor_count": 900
      }
    ]
  }
}
```

#### 获取地图数据

```http
GET /api/data-analytics/visitor-geo/map/?days=30&limit=100
```

**参数：**
- `days`: 查询天数（1-365）
- `limit`: 返回的最大记录数（1-1000）

**返回示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "days": 30,
    "total_locations": 25,
    "map_data": [
      {
        "country": "中国",
        "country_code": "CN",
        "region": "湖北省",
        "region_code": "42",
        "latitude": 30.5928,
        "longitude": 114.3055,
        "visit_count": 3500,
        "unique_visitor_count": 2100
      }
    ]
  }
}
```

## 性能优化建议

### 1. 数据聚合

对于高流量网站，建议定期运行数据聚合任务，将原始访问数据按天汇总到 `GeoDistribution` 表中：

```python
# 在 data_analytics/management/commands/aggregate_geo_data.py
from django.core.management.base import BaseCommand
from django.utils import timezone
from datetime import timedelta
from data_analytics.models import VisitorGeo, GeoDistribution
from django.db.models import Count

class Command(BaseCommand):
    def handle(self, *args, **options):
        today = timezone.now().date()
        yesterday = today - timedelta(days=1)

        # 聚合昨天的数据
        geo_data = VisitorGeo.objects.filter(
            visit_time__date=yesterday
        ).values('country', 'country_code', 'region', 'region_code').annotate(
            visit_count=Count('id'),
            unique_visitor_count=Count('ip_address', distinct=True)
        )

        for item in geo_data:
            GeoDistribution.objects.update_or_create(
                date=yesterday,
                country=item['country'],
                region=item['region'],
                defaults={
                    'visit_count': item['visit_count'],
                    'unique_visitor_count': item['unique_visitor_count'],
                    'is_domestic': item['country'] == '中国'
                }
            )
```

然后设置定时任务（使用systemd timer或celery beat）每天凌晨执行。

### 2. 数据清理

定期清理旧的详细访问数据，只保留聚合数据：

```python
# 保留最近90天的详细数据
from datetime import timedelta

old_data_date = timezone.now() - timedelta(days=90)
VisitorGeo.objects.filter(visit_time__lt=old_data_date).delete()
```

### 3. 缓存

对于热门查询（如最近30天的数据），可以使用Redis缓存：

```python
from django.core.cache import cache

def get_cached_geo_distribution(days, group_by):
    cache_key = f'geo_distribution:{days}:{group_by}'
    result = cache.get(cache_key)
    
    if result is None:
        result = calculate_geo_distribution(days, group_by)
        cache.set(cache_key, result, 3600)  # 缓存1小时
    
    return result
```

### 4. 前端优化

- 使用懒加载加载ECharts地图数据
- 对大数据集进行虚拟滚动优化
- 使用Web Worker处理数据计算

## 隐私与安全

### 1. IP地址处理

- 在日志中避免明文记录IP地址
- 考虑对IP地址进行匿名化处理（如只保留前三个字节）
- 遵守GDPR等隐私法规，提供数据删除接口

### 2. 数据保护

- 定期备份数据库
- 限制对访客数据的访问权限
- 使用HTTPS加密传输

## 扩展功能建议

1. **实时更新**：使用WebSocket实现地图数据的实时更新
2. **热力图**：在地图上叠加热力图层，显示访问密度
3. **时间轴**：添加时间轴控件，可以播放历史数据的变化
4. **对比分析**：支持不同时间段的对比分析
5. **导出功能**：支持导出数据为CSV、Excel等格式
6. **移动端适配**：优化移动端地图交互体验

## 故障排查

### 地图不显示

1. 检查ECharts地图数据是否正确加载
2. 确认浏览器是否支持Canvas
3. 查看控制台是否有错误信息

### 数据不准确

1. 检查中间件是否正常工作
2. 确认IP地理位置服务是否正常
3. 查看数据库中是否有数据记录

### 性能问题

1. 检查是否启用了数据聚合
2. 确认是否使用了缓存
3. 查看数据库索引是否正确创建

## 技术支持

如有问题，请联系：910002662@qq.com
