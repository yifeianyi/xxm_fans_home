# XXM Fans Home - Agent æŸ¥è¯¢å­ç³»ç»Ÿæ•°æ®æµæ–‡æ¡£

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿° Agent æŸ¥è¯¢å­ç³»ç»Ÿçš„æ•°æ®æµåŠ¨è¿‡ç¨‹ï¼Œä»ç”¨æˆ·è¾“å…¥æŸ¥è¯¢åˆ°è¿”å›ç»“æœçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

---

## äºŒã€æ•´ä½“æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·å±‚                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ç”¨æˆ·è¾“å…¥æŸ¥è¯¢: "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ"                                     â”‚
â”‚  2. å‰ç«¯ç»„ä»¶: AgentChat.tsx                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              APIå±‚ (Django)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  POST /api/agent/query                                                       â”‚
â”‚  Request: { "query": "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ", "user_id": "user_123" }        â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  RateLimitMiddleware - é€Ÿç‡é™åˆ¶æ£€æŸ¥                                  â”‚    â”‚
â”‚  â”‚  - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¶…è¿‡30æ¬¡/åˆ†é’Ÿçš„é™åˆ¶                                    â”‚    â”‚
â”‚  â”‚  - Redis: key="ratelimit:user_123"                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Agentæ ¸å¿ƒå±‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ­¥éª¤1: æ„å›¾è¯†åˆ«å™¨ (IntentRecognizer)                               â”‚    â”‚
â”‚  â”‚  Input:  "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ"                                     â”‚    â”‚
â”‚  â”‚  Process:                                                           â”‚    â”‚
â”‚  â”‚    - è§„åˆ™åŒ¹é…: pattern=r'(å”±å¾—æœ€å¤š|æ¼”å”±æœ€å¤š).*æ­Œ|(\d{4})å¹´.*æ­Œ'     â”‚    â”‚
â”‚  â”‚    - å‚æ•°æå–: year=2024, limit=5, sort_by='perform_count'          â”‚    â”‚
â”‚  â”‚  Output: Intent(type='song_stats', parameters={...}, confidence=0.92)â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ­¥éª¤2: ç¼“å­˜ç®¡ç†å™¨ (CacheManager) - æ£€æŸ¥ç¼“å­˜                        â”‚    â”‚
â”‚  â”‚  Cache Key: "agent:song_stats:hash(year=2024&limit=5)"              â”‚    â”‚
â”‚  â”‚  Redis GET: cache_key                                               â”‚    â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”‚  IF cached_result EXISTS:                                              â”‚
â”‚  â”‚    â†’ è¿”å›ç¼“å­˜ç»“æœ                                                       â”‚
â”‚  â”‚    â†’ from_cache=True                                                   â”‚
â”‚  â”‚    â†’ execution_time=0.005s                                             â”‚
â”‚  â”‚  ELSE:                                                                  â”‚    â”‚
â”‚  â”‚    â†’ ç»§ç»­æ‰§è¡ŒæŸ¥è¯¢                                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ­¥éª¤3: æŸ¥è¯¢æ‰§è¡Œå™¨ (QueryExecutor)                                   â”‚    â”‚
â”‚  â”‚  Intent: song_stats                                                  â”‚    â”‚
â”‚  â”‚  Parameters: {year: 2024, limit: 5, sort_by: 'perform_count'}        â”‚    â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”‚  â†’ è°ƒç”¨ AgentQueryService.get_songs_stats()                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ•°æ®è®¿é—®å±‚ (Services)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  AgentQueryService.get_songs_stats(year=2024, limit=5)              â”‚    â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”‚  Django ORM Query:                                                     â”‚    â”‚
â”‚  â”‚    SELECT s.id, s.song_name, s.singer,                                â”‚    â”‚
â”‚  â”‚           COUNT(sr.id) as total_performs,                             â”‚    â”‚
â”‚  â”‚           MIN(sr.performed_at) as first_date,                         â”‚    â”‚
â”‚  â”‚           MAX(sr.performed_at) as last_date                           â”‚    â”‚
â”‚  â”‚    FROM song_management_song s                                       â”‚    â”‚
â”‚  â”‚    LEFT JOIN song_management_songrecord sr ON s.id = sr.song_id      â”‚    â”‚
â”‚  â”‚    WHERE strftime('%Y', sr.performed_at) = '2024'                    â”‚    â”‚
â”‚  â”‚    GROUP BY s.id                                                      â”‚    â”‚
â”‚  â”‚    ORDER BY total_performs DESC                                      â”‚    â”‚
â”‚  â”‚    LIMIT 5                                                             â”‚    â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”‚  SQLite Database: /home/yifeianyi/Desktop/xxm_fans_home/data/db.sqlite3â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  è¿”å›æ•°æ®æ ¼å¼åŒ–:                                                       â”‚    â”‚
â”‚  â”‚  [                                                                     â”‚    â”‚
â”‚  â”‚    {                                                                   â”‚    â”‚
â”‚  â”‚      "id": 1,                                                         â”‚    â”‚
â”‚  â”‚      "song_name": "ç¨»é¦™",                                            â”‚    â”‚
â”‚  â”‚      "singer": "å‘¨æ°ä¼¦",                                            â”‚    â”‚
â”‚  â”‚      "perform_count": 12,                                            â”‚    â”‚
â”‚  â”‚      "first_perform": "2024-03-15",                                  â”‚    â”‚
â”‚  â”‚      "last_performed": "2024-12-20",                                 â”‚    â”‚
â”‚  â”‚      "styles": ["æµè¡Œ"],                                            â”‚    â”‚
â”‚  â”‚      "tags": ["åŠ©çœ "]                                                â”‚    â”‚
â”‚  â”‚    },                                                                  â”‚    â”‚
â”‚  â”‚    ...                                                                 â”‚    â”‚
â”‚  â”‚  ]                                                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Agentæ ¸å¿ƒå±‚ (ç»§ç»­)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ­¥éª¤4: ç»“æœæ ¼å¼åŒ–å™¨ (ResultFormatter)                               â”‚    â”‚
â”‚  â”‚  Input: songs_data (List[Dict])                                      â”‚    â”‚
â”‚  â”‚  Format: table                                                       â”‚    â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”‚  Output:                                                               â”‚    â”‚
â”‚  â”‚  {                                                                     â”‚    â”‚
â”‚  â”‚    "type": "table",                                                   â”‚    â”‚
â”‚  â”‚    "columns": ["æ­Œæ›²åç§°", "æ­Œæ‰‹", "æ¼”å”±æ¬¡æ•°", "é¦–æ¬¡æ¼”å”±", "æœ€è¿‘æ¼”å”±"],    â”‚    â”‚
â”‚  â”‚    "rows": [                                                          â”‚    â”‚
â”‚  â”‚      ["ç¨»é¦™", "å‘¨æ°ä¼¦", 12, "2024-03-15", "2024-12-20"],              â”‚    â”‚
â”‚  â”‚      ["é’èŠ±ç“·", "å‘¨æ°ä¼¦", 10, "2024-01-08", "2024-11-25"],             â”‚    â”‚
â”‚  â”‚      ...                                                               â”‚    â”‚
â”‚  â”‚    ],                                                                  â”‚    â”‚
â”‚  â”‚    "summary": "2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ"                                  â”‚    â”‚
â”‚  â”‚  }                                                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ­¥éª¤5: ç¼“å­˜ç»“æœ                                                      â”‚    â”‚
â”‚  â”‚  Redis SET: cache_key, value={result}, timeout=300                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ­¥éª¤6: ä¸Šä¸‹æ–‡ç®¡ç†å™¨ (ContextManager) - æ›´æ–°ä¸Šä¸‹æ–‡                    â”‚    â”‚
â”‚  â”‚  - ä¿å­˜ç”¨æˆ·æŸ¥è¯¢å†å²                                                   â”‚    â”‚
â”‚  â”‚  - æå–å®ä½“: ["ç¨»é¦™", "é’èŠ±ç“·", ...]                                  â”‚    â”‚
â”‚  â”‚  - æ›´æ–°å½“å‰å…³æ³¨å®ä½“: current_entity="ç¨»é¦™"                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                      â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ­¥éª¤7: æŸ¥è¯¢ç›‘æ§å™¨ (QueryMonitor) - è®°å½•æ—¥å¿—                          â”‚    â”‚
â”‚  â”‚  - logger.info("Query: song_stats, Time: 0.15s, Success: True")      â”‚    â”‚
â”‚  â”‚  - æ›´æ–°ç»Ÿè®¡: QueryStats.objects.update_or_create()                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              APIå“åº”å±‚                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Response (200 OK):                                                        â”‚
â”‚  {                                                                         â”‚
â”‚    "success": true,                                                        â”‚
â”‚    "intent": {                                                             â”‚
â”‚      "type": "song_stats",                                                 â”‚
â”‚      "parameters": {"year": 2024, "limit": 5},                            â”‚
â”‚      "confidence": 0.92                                                    â”‚
â”‚    },                                                                      â”‚
â”‚    "result": {                                                             â”‚
â”‚      "type": "table",                                                      â”‚
â”‚      "columns": ["æ­Œæ›²åç§°", "æ­Œæ‰‹", "æ¼”å”±æ¬¡æ•°", "é¦–æ¬¡æ¼”å”±", "æœ€è¿‘æ¼”å”±"],      â”‚
â”‚      "rows": [[...], [...], ...],                                         â”‚
â”‚      "summary": "2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ"                                    â”‚
â”‚    },                                                                      â”‚
â”‚    "execution_time": 0.15,                                                 â”‚
â”‚    "from_cache": false                                                     â”‚
â”‚  }                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å‰ç«¯å±‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AgentChat.tsx:                                                             â”‚
â”‚  - è§£æå“åº”ç»“æœ                                                             â”‚
â”‚  - æ¸²æŸ“ ResultDisplay ç»„ä»¶ (è¡¨æ ¼æ ¼å¼)                                       â”‚
â”‚  - æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´å’Œç¼“å­˜çŠ¶æ€                                                   â”‚
â”‚  - æ›´æ–°æ¶ˆæ¯å†å²                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€è¯¦ç»†æ•°æ®æµè¯´æ˜

### 3.1 ç”¨æˆ·è¾“å…¥é˜¶æ®µ

**æ•°æ®å†…å®¹**ï¼š
```json
{
  "query": "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ",
  "user_id": "user_123",
  "format": "table"
}
```

**å¤„ç†é€»è¾‘**ï¼š
1. å‰ç«¯ç»„ä»¶ `AgentChat.tsx` æ•è·ç”¨æˆ·è¾“å…¥
2. æ„å»ºHTTP POSTè¯·æ±‚åˆ° `/api/agent/query`
3. è®¾ç½®è¯·æ±‚å¤´ `Content-Type: application/json`

---

### 3.2 APIå…¥å£é˜¶æ®µ

**RateLimitMiddleware å¤„ç†æµç¨‹**ï¼š

```
è¾“å…¥: user_id = "user_123"

1. ç”Ÿæˆç¼“å­˜é”®: "ratelimit:user_123"
2. Redis GET: cache_key
3. IF count >= 30:
       â†’ è¿”å› 429 Too Many Requests
       â†’ Response: {"error": "æŸ¥è¯¢è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"}
   ELSE:
       â†’ Redis INCR: cache_key
       â†’ Redis EXPIRE: cache_key, 60
       â†’ ç»§ç»­å¤„ç†è¯·æ±‚
```

**å®‰å…¨è¿‡æ»¤å™¨å¤„ç†**ï¼š

```
è¾“å…¥: query = "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ"

1. æ­£åˆ™æ£€æŸ¥: SQL_INJECTION_PATTERNS
2. IF query åŒ…å«éæ³•å­—ç¬¦:
       â†’ è¿”å› 400 Bad Request
       â†’ Response: {"error": "æŸ¥è¯¢åŒ…å«éæ³•å­—ç¬¦"}
   ELSE:
       â†’ sanitize_query(query)
       â†’ ç»§ç»­å¤„ç†
```

---

### 3.3 æ„å›¾è¯†åˆ«é˜¶æ®µ

**IntentRecognizer å·¥ä½œæµç¨‹**ï¼š

```
è¾“å…¥: query = "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ"

1. é¢„å¤„ç†:
   - è½¬å°å†™: "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ"
   - å»é™¤å¤šä½™ç©ºæ ¼

2. è§„åˆ™åŒ¹é… (æŒ‰ä¼˜å…ˆçº§):
   Rule 1: pattern=r'(å”±å¾—æœ€å¤š|æ¼”å”±æœ€å¤š).*æ­Œ|(\d{4})å¹´.*æ­Œ'
   Result: MATCH âœ…

3. å‚æ•°æå–:
   - æå–å¹´ä»½: year = 2024
   - æå–é™åˆ¶: limit = 5
   - é»˜è®¤æ’åº: sort_by = 'perform_count'

4. ç½®ä¿¡åº¦è®¡ç®—:
   confidence = 0.92 (åŸºäºå…³é”®è¯åŒ¹é…åº¦)

5. è¿”å›æ„å›¾å¯¹è±¡:
{
  "type": "song_stats",
  "parameters": {
    "year": 2024,
    "limit": 5,
    "sort_by": "perform_count"
  },
  "confidence": 0.92
}
```

---

### 3.4 ç¼“å­˜æ£€æŸ¥é˜¶æ®µ

**CacheManager å·¥ä½œæµç¨‹**ï¼š

```
è¾“å…¥: intent = {type: "song_stats", parameters: {...}}

1. ç”Ÿæˆç¼“å­˜é”®:
   param_str = json.dumps({"year": 2024, "limit": 5, "sort_by": "perform_count"}, sort_keys=True)
   # param_str = '{"limit": 5, "sort_by": "perform_count", "year": 2024}'
   hash_value = hashlib.md5(param_str.encode()).hexdigest()
   # hash_value = "a1b2c3d4e5f6..."
   cache_key = f"agent:song_stats:{hash_value}"
   # cache_key = "agent:song_stats:a1b2c3d4e5f6..."

2. Redis GET: cache_key
   Result: None (æœªå‘½ä¸­ç¼“å­˜)

3. è¿”å›: from_cache = False

å¦‚æœç¼“å­˜å‘½ä¸­:
4. è¿”å›ç¼“å­˜ç»“æœ
5. from_cache = True
6. execution_time â‰ˆ 0.005s
```

---

### 3.5 æŸ¥è¯¢æ‰§è¡Œé˜¶æ®µ

**QueryExecutor å·¥ä½œæµç¨‹**ï¼š

```
è¾“å…¥: intent = {type: "song_stats", parameters: {...}}

1. è·¯ç”±åˆ°å¯¹åº”çš„æŸ¥è¯¢æ–¹æ³•:
   if intent.type == "song_stats":
       return self._execute_song_stats(intent.parameters)

2. è°ƒç”¨ AgentQueryService:
   songs_stats = self.services['agent'].get_songs_stats(
       year=2024,
       limit=5,
       sort_by='perform_count'
   )
```

**AgentQueryService æŸ¥è¯¢é€»è¾‘**ï¼š

```
def get_songs_stats(year, limit, sort_by):
    # 1. æ„å»º Django ORM æŸ¥è¯¢
    songs = Song.objects.annotate(
        total_performs=Count('records')
    ).filter(
        records__performed_at__year=year
    ).distinct()

    # 2. æŒ‰æŒ‡å®šå­—æ®µæ’åº
    if sort_by == 'perform_count':
        songs = songs.order_by('-total_performs')
    elif sort_by == 'first_perform':
        songs = songs.order_by('records__performed_at')

    # 3. é™åˆ¶ç»“æœæ•°é‡
    songs = songs[:limit]

    # 4. æ•°æ®æ ¼å¼åŒ–
    result = []
    for song in songs:
        first_record = song.records.order_by('performed_at').first()
        last_record = song.records.order_by('-performed_at').first()
        
        result.append({
            'id': song.id,
            'song_name': song.song_name,
            'singer': song.singer or '-',
            'perform_count': song.total_performs,
            'first_perform': first_record.performed_at.strftime('%Y-%m-%d') if first_record else '-',
            'last_performed': last_record.performed_at.strftime('%Y-%m-%d') if last_record else '-',
            'styles': [s.style.name for s in song.song_styles.all()],
            'tags': [t.tag.name for t in song.song_tags.all()]
        })

    return result
```

**SQL å®é™…æ‰§è¡Œ**ï¼š

```sql
-- Django ORM ç”Ÿæˆçš„ SQL
SELECT 
    s.id,
    s.song_name,
    s.singer,
    COUNT(sr.id) as total_performs,
    MIN(sr.performed_at) as first_date,
    MAX(sr.performed_at) as last_date
FROM song_management_song s
LEFT JOIN song_management_songrecord sr ON s.id = sr.song_id
WHERE strftime('%Y', sr.performed_at) = '2024'
GROUP BY s.id
ORDER BY total_performs DESC
LIMIT 5
```

**æ•°æ®åº“æŸ¥è¯¢ç»“æœ**ï¼š

```
| id  | song_name | singer    | total_performs | first_date  | last_date   |
|-----|-----------|-----------|----------------|-------------|-------------|
| 1   | ç¨»é¦™      | å‘¨æ°ä¼¦    | 12             | 2024-03-15  | 2024-12-20  |
| 2   | é’èŠ±ç“·    | å‘¨æ°ä¼¦    | 10             | 2024-01-08  | 2024-11-25  |
| 3   | å‘Šç™½æ°”çƒ  | å‘¨æ°ä¼¦    | 8              | 2024-02-20  | 2024-10-15  |
| 4   | å¤œæ›²      | å‘¨æ°ä¼¦    | 7              | 2024-04-05  | 2024-12-05  |
| 5   | ç®€å•çˆ±    | å‘¨æ°ä¼¦    | 6              | 2024-01-25  | 2024-09-30  |
```

---

### 3.6 æ•°æ®å…³è”æŸ¥è¯¢

å¯¹äºæ¯é¦–æ­Œï¼Œè¿˜éœ€è¦æŸ¥è¯¢æ›²é£å’Œæ ‡ç­¾ï¼š

```sql
-- æŸ¥è¯¢æ›²é£ (styles)
SELECT style.name
FROM song_management_songstyle ss
JOIN song_management_style style ON ss.style_id = style.id
WHERE ss.song_id = 1

-- ç»“æœ: ['æµè¡Œ']

-- æŸ¥è¯¢æ ‡ç­¾ (tags)
SELECT tag.name
FROM song_management_songtag st
JOIN song_management_tag tag ON st.tag_id = tag.id
WHERE st.song_id = 1

-- ç»“æœ: ['åŠ©çœ ']
```

**æœ€ç»ˆæ•°æ®ç»“æ„**ï¼š

```json
[
  {
    "id": 1,
    "song_name": "ç¨»é¦™",
    "singer": "å‘¨æ°ä¼¦",
    "perform_count": 12,
    "first_perform": "2024-03-15",
    "last_performed": "2024-12-20",
    "styles": ["æµè¡Œ"],
    "tags": ["åŠ©çœ "]
  },
  {
    "id": 2,
    "song_name": "é’èŠ±ç“·",
    "singer": "å‘¨æ°ä¼¦",
    "perform_count": 10,
    "first_perform": "2024-01-08",
    "last_performed": "2024-11-25",
    "styles": ["å¤é£"],
    "tags": ["æˆè…”"]
  },
  ...
]
```

---

### 3.7 ç»“æœæ ¼å¼åŒ–é˜¶æ®µ

**ResultFormatter å·¥ä½œæµç¨‹**ï¼š

```
è¾“å…¥: 
  - songs_data (List[Dict])
  - format: 'table'

1. è°ƒç”¨æ ¼å¼åŒ–æ–¹æ³•:
   formatted = self._format_table(songs_data)

2. æå–è¡¨æ ¼åˆ—:
   columns = ["æ­Œæ›²åç§°", "æ­Œæ‰‹", "æ¼”å”±æ¬¡æ•°", "é¦–æ¬¡æ¼”å”±", "æœ€è¿‘æ¼”å”±"]

3. æå–è¡¨æ ¼è¡Œ:
   rows = [
     ["ç¨»é¦™", "å‘¨æ°ä¼¦", 12, "2024-03-15", "2024-12-20"],
     ["é’èŠ±ç“·", "å‘¨æ°ä¼¦", 10, "2024-01-08", "2024-11-25"],
     ["å‘Šç™½æ°”çƒ", "å‘¨æ°ä¼¦", 8, "2024-02-20", "2024-10-15"],
     ["å¤œæ›²", "å‘¨æ°ä¼¦", 7, "2024-04-05", "2024-12-05"],
     ["ç®€å•çˆ±", "å‘¨æ°ä¼¦", 6, "2024-01-25", "2024-09-30"]
   ]

4. ç”Ÿæˆæ‘˜è¦:
   summary = "2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ"

5. è¿”å›æ ¼å¼åŒ–ç»“æœ:
{
  "type": "table",
  "columns": ["æ­Œæ›²åç§°", "æ­Œæ‰‹", "æ¼”å”±æ¬¡æ•°", "é¦–æ¬¡æ¼”å”±", "æœ€è¿‘æ¼”å”±"],
  "rows": [[...], [...], ...],
  "summary": "2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ"
}
```

---

### 3.8 ç¼“å­˜å­˜å‚¨é˜¶æ®µ

**CacheManager å­˜å‚¨é€»è¾‘**ï¼š

```
è¾“å…¥:
  - cache_key = "agent:song_stats:a1b2c3d4e5f6..."
  - result = {type: "table", columns: [...], rows: [...], summary: "..."}

1. åºåˆ—åŒ–ç»“æœ:
   serialized = json.dumps(result, ensure_ascii=False)

2. Redis SET:
   - key: cache_key
   - value: serialized
   - timeout: 300 (5åˆ†é’Ÿ)

3. è¿”å›: æˆåŠŸ
```

---

### 3.9 ä¸Šä¸‹æ–‡ç®¡ç†é˜¶æ®µ

**ContextManager å·¥ä½œæµç¨‹**ï¼š

```
è¾“å…¥:
  - user_id = "user_123"
  - query = "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ"
  - result = {...}

1. è·å–æˆ–åˆ›å»ºå¯¹è¯ä¸Šä¸‹æ–‡:
   context = self.get_or_create_context("user_123")

2. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯:
   context.add_message(
     role='user',
     content='2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ',
     timestamp=2026-02-03T10:30:00Z
   )

3. æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯:
   context.add_message(
     role='assistant',
     content='2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ',
     result=result,
     timestamp=2026-02-03T10:30:01Z
   )

4. æå–å®ä½“:
   entities = self._extract_entities(result)
   # entities = ["ç¨»é¦™", "é’èŠ±ç“·", "å‘Šç™½æ°”çƒ"]

5. æ›´æ–°å½“å‰å…³æ³¨å®ä½“:
   context.current_entity = entities[0]
   # context.current_entity = "ç¨»é¦™"

6. ä¿å­˜åˆ°å†…å­˜ (æˆ–Redis):
   self.contexts["user_123"] = context
```

**ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„**ï¼š

```json
{
  "user_id": "user_123",
  "history": [
    {
      "role": "user",
      "content": "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ",
      "result": null,
      "timestamp": "2026-02-03T10:30:00Z"
    },
    {
      "role": "assistant",
      "content": "2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ",
      "result": {
        "type": "table",
        "columns": [...],
        "rows": [...],
        "summary": "2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ"
      },
      "timestamp": "2026-02-03T10:30:01Z"
    }
  ],
  "current_entity": "ç¨»é¦™",
  "temp_data": {}
}
```

---

### 3.10 æŸ¥è¯¢ç›‘æ§é˜¶æ®µ

**QueryMonitor å·¥ä½œæµç¨‹**ï¼š

```
è¾“å…¥:
  - intent = {type: "song_stats", ...}
  - result = {success: true, ...}
  - execution_time = 0.15

1. è®°å½•æ—¥å¿—:
   logger.info(
     f"Query: {intent.type.value}, "
     f"Time: {execution_time}s, "
     f"Success: {result.success}"
   )
   # è¾“å‡º: "Query: song_stats, Time: 0.15s, Success: True"

2. æ›´æ–°æŸ¥è¯¢ç»Ÿè®¡:
   QueryStats.objects.update_or_create(
     date=date(2026, 2, 3),
     intent_type='song_stats',
     defaults={
       'query_count': F('query_count') + 1,
       'avg_execution_time': execution_time
     }
   )

3. è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡:
   - æ€»æŸ¥è¯¢æ•° = 100
   - ç¼“å­˜å‘½ä¸­æ•° = 25
   - ç¼“å­˜å‘½ä¸­ç‡ = 25%

4. ä¿å­˜æŸ¥è¯¢å†å²:
   QueryHistory.objects.create(
     user_id='user_123',
     query='2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ',
     intent_type='song_stats',
     parameters={'year': 2024, 'limit': 5},
     result=result.to_dict(),
     execution_time=0.15,
     from_cache=False
   )
```

---

### 3.11 APIå“åº”é˜¶æ®µ

**æ„å»ºå“åº”**ï¼š

```python
response_data = {
    "success": True,
    "intent": {
        "type": "song_stats",
        "parameters": {
            "year": 2024,
            "limit": 5,
            "sort_by": "perform_count"
        },
        "confidence": 0.92
    },
    "result": {
        "type": "table",
        "columns": ["æ­Œæ›²åç§°", "æ­Œæ‰‹", "æ¼”å”±æ¬¡æ•°", "é¦–æ¬¡æ¼”å”±", "æœ€è¿‘æ¼”å”±"],
        "rows": [
            ["ç¨»é¦™", "å‘¨æ°ä¼¦", 12, "2024-03-15", "2024-12-20"],
            ["é’èŠ±ç“·", "å‘¨æ°ä¼¦", 10, "2024-01-08", "2024-11-25"],
            ["å‘Šç™½æ°”çƒ", "å‘¨æ°ä¼¦", 8, "2024-02-20", "2024-10-15"],
            ["å¤œæ›²", "å‘¨æ°ä¼¦", 7, "2024-04-05", "2024-12-05"],
            ["ç®€å•çˆ±", "å‘¨æ°ä¼¦", 6, "2024-01-25", "2024-09-30"]
        ],
        "summary": "2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ"
    },
    "execution_time": 0.15,
    "from_cache": False
}

return JsonResponse(response_data)
```

**HTTP Response**ï¼š

```
HTTP/1.1 200 OK
Content-Type: application/json
X-Execution-Time: 0.15
X-Cache-Hit: false

{
  "success": true,
  "intent": {...},
  "result": {...},
  "execution_time": 0.15,
  "from_cache": false
}
```

---

### 3.12 å‰ç«¯æ¸²æŸ“é˜¶æ®µ

**AgentChat ç»„ä»¶å¤„ç†**ï¼š

```typescript
// æ¥æ”¶å“åº”
const data = await response.json();

// è§£æç»“æœ
const assistantMessage: Message = {
  id: (Date.now() + 1).toString(),
  role: 'assistant',
  content: data.result.summary || 'æŸ¥è¯¢å®Œæˆ',
  result: data.result,
  timestamp: new Date(),
  meta: {
    executionTime: data.execution_time,
    fromCache: data.from_cache,
    intent: data.intent
  }
};

// æ›´æ–°æ¶ˆæ¯å†å²
setMessages(prev => [...prev, assistantMessage]);

// æ¸²æŸ“ ResultDisplay ç»„ä»¶
<ResultDisplay result={data.result} />
```

**TableResult ç»„ä»¶æ¸²æŸ“**ï¼š

```typescript
const TableResult: React.FC<TableResultProps> = ({ columns, rows }) => (
  <div className="table-result glass-card">
    <table className="data-table">
      <thead>
        <tr>
          {columns.map(col => (
            <th key={col}>{col}</th>
          ))}
        </tr>
      </thead>
      <tbody>
        {rows.map((row, i) => (
          <tr key={i}>
            {row.map((cell, j) => (
              <td key={j}>{cell}</td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>
    <div className="result-meta">
      <span>â±ï¸ æ‰§è¡Œæ—¶é—´: 0.15s</span>
      <span>ğŸ’¾ ç¼“å­˜: æœªå‘½ä¸­</span>
    </div>
  </div>
);
```

---

## å››ã€é”™è¯¯å¤„ç†æ•°æ®æµ

### 4.1 é€Ÿç‡é™åˆ¶é”™è¯¯

```
ç”¨æˆ·è¯·æ±‚
    â†“
RateLimitMiddleware æ£€æŸ¥
    â†“
Redis GET "ratelimit:user_123" â†’ count = 35
    â†“
count >= 30 ? YES
    â†“
è¿”å› 429 Too Many Requests
{
  "success": false,
  "error": "æŸ¥è¯¢è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
  "retry_after": 25  # ç§’
}
    â†“
å‰ç«¯æ˜¾ç¤ºé”™è¯¯æç¤º
```

### 4.2 æ„å›¾è¯†åˆ«å¤±è´¥

```
ç”¨æˆ·æŸ¥è¯¢: "éšä¾¿çœ‹çœ‹"
    â†“
IntentRecognizer.recognize()
    â†“
è§„åˆ™åŒ¹é… â†’ æœªåŒ¹é…ä»»ä½•è§„åˆ™
    â†“
è¿”å› Intent(type=UNKNOWN, confidence=0.0)
    â†“
QueryExecutor æ£€æµ‹åˆ° UNKNOWN æ„å›¾
    â†“
è¿”å› QueryResult(success=false, error="æ— æ³•ç†è§£æ‚¨çš„æŸ¥è¯¢ï¼Œè¯·æ¢ä¸€ç§è¯´æ³•")
    â†“
API Response:
{
  "success": false,
  "error": "æ— æ³•ç†è§£æ‚¨çš„æŸ¥è¯¢ï¼Œè¯·æ¢ä¸€ç§è¯´æ³•",
  "suggestions": [
    "æœ€è¿‘æ¼”å”±çš„æ­Œæ›²",
    "æœ¬å‘¨ç›´æ’­",
    "çƒ­é—¨æ­Œæ›²"
  ]
}
```

### 4.3 æ•°æ®åº“æŸ¥è¯¢é”™è¯¯

```
QueryExecutor._execute_song_stats()
    â†“
AgentQueryService.get_songs_stats()
    â†“
Django ORM Query
    â†“
SQLite Database Error
    â†“
æ•è·å¼‚å¸¸: DatabaseError("no such table: song_management_song")
    â†“
è®°å½•é”™è¯¯æ—¥å¿—
    â†“
è¿”å› QueryResult(success=false, error="æ•°æ®åº“æŸ¥è¯¢å¤±è´¥")
    â†“
API Response:
{
  "success": false,
  "error": "æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
}
```

---

## äº”ã€å¤šè½®å¯¹è¯æ•°æ®æµ

### 5.1 å¯¹è¯åœºæ™¯

```
ç¬¬ä¸€è½®:
ç”¨æˆ·: "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ"
    â†“
è¿”å›: è¡¨æ ¼ç»“æœ [ç¨»é¦™, é’èŠ±ç“·, å‘Šç™½æ°”çƒ, å¤œæ›², ç®€å•çˆ±]
    â†“
ContextManager æ›´æ–°ä¸Šä¸‹æ–‡:
  - history: [user_msg, assistant_msg]
  - current_entity: "ç¨»é¦™"

ç¬¬äºŒè½®:
ç”¨æˆ·: "è¿™é¦–æ­Œç¬¬ä¸€æ¬¡å”±æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ"
    â†“
IntentRecognizer è¯†åˆ«:
  - æŸ¥è¯¢: "è¿™é¦–æ­Œç¬¬ä¸€æ¬¡å”±æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ"
  - ä»ä¸Šä¸‹æ–‡æå–: current_entity = "ç¨»é¦™"
  - æ„å›¾: record_search
  - å‚æ•°: {song_name: "ç¨»é¦™", sort_by: "first_perform"}
    â†“
QueryExecutor æ‰§è¡Œ:
  - æŸ¥è¯¢: SongRecord.objects.filter(song__song_name="ç¨»é¦™").order_by('performed_at').first()
    â†“
è¿”å›: "ç¨»é¦™ç¬¬ä¸€æ¬¡æ¼”å”±äº2024å¹´3æœˆ15æ—¥"
    â†“
ContextManager æ›´æ–°ä¸Šä¸‹æ–‡:
  - history: [..., user_msg, assistant_msg]
  - current_entity: "ç¨»é¦™" (ä¿æŒä¸å˜)
```

### 5.2 ä¸Šä¸‹æ–‡æ•°æ®å˜åŒ–

```
åˆå§‹çŠ¶æ€:
{
  "user_id": "user_123",
  "history": [],
  "current_entity": null
}

ç¬¬ä¸€è½®å:
{
  "user_id": "user_123",
  "history": [
    {
      "role": "user",
      "content": "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ",
      "timestamp": "2026-02-03T10:30:00Z"
    },
    {
      "role": "assistant",
      "content": "2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ",
      "result": {...},
      "timestamp": "2026-02-03T10:30:01Z"
    }
  ],
  "current_entity": "ç¨»é¦™"
}

ç¬¬äºŒè½®å:
{
  "user_id": "user_123",
  "history": [
    {...},  // ç¬¬ä¸€è½® user
    {...},  // ç¬¬ä¸€è½® assistant
    {
      "role": "user",
      "content": "è¿™é¦–æ­Œç¬¬ä¸€æ¬¡å”±æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ",
      "timestamp": "2026-02-03T10:31:00Z"
    },
    {
      "role": "assistant",
      "content": "ç¨»é¦™ç¬¬ä¸€æ¬¡æ¼”å”±äº2024å¹´3æœˆ15æ—¥",
      "result": {...},
      "timestamp": "2026-02-03T10:31:01Z"
    }
  ],
  "current_entity": "ç¨»é¦™"
}
```

---

## å…­ã€ç¼“å­˜æ•°æ®æµè¯¦è§£

### 6.1 ç¼“å­˜é”®ç”Ÿæˆç®—æ³•

```python
def generate_cache_key(intent_type: str, parameters: dict) -> str:
    """
    ç”Ÿæˆç¼“å­˜é”®
    
    ç®—æ³•:
    1. å°†å‚æ•°å­—å…¸è½¬ä¸ºæœ‰åºJSONå­—ç¬¦ä¸²
    2. ä½¿ç”¨MD5å“ˆå¸Œç”Ÿæˆå”¯ä¸€æ ‡è¯†
    3. æ‹¼æ¥æ„å›¾ç±»å‹å’Œå“ˆå¸Œå€¼
    
    ç¤ºä¾‹:
    - intent_type: "song_stats"
    - parameters: {"year": 2024, "limit": 5, "sort_by": "perform_count"}
    
    æ­¥éª¤1: json.dumps({"year": 2024, "limit": 5, "sort_by": "perform_count"}, sort_keys=True)
         = '{"limit": 5, "sort_by": "perform_count", "year": 2024}'
    
    æ­¥éª¤2: hashlib.md5('{"limit": 5, "sort_by": "perform_count", "year": 2024}'.encode()).hexdigest()
         = "a1b2c3d4e5f67890abcdef1234567890"
    
    æ­¥éª¤3: f"agent:{intent_type}:{hash_value}"
         = "agent:song_stats:a1b2c3d4e5f67890abcdef1234567890"
    """
    param_str = json.dumps(parameters, sort_keys=True)
    hash_value = hashlib.md5(param_str.encode()).hexdigest()
    return f"agent:{intent_type}:{hash_value}"
```

### 6.2 ç¼“å­˜å‘½ä¸­æµç¨‹

```
ç”¨æˆ·æŸ¥è¯¢: "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ"
    â†“
IntentRecognizer è¯†åˆ«æ„å›¾
    â†“
CacheManager ç”Ÿæˆç¼“å­˜é”®: "agent:song_stats:a1b2c3d4..."
    â†“
Redis GET "agent:song_stats:a1b2c3d4..."
    â†“
ç¼“å­˜å‘½ä¸­! âœ…
    â†“
è¿”å›ç¼“å­˜ç»“æœ:
{
  "type": "table",
  "columns": [...],
  "rows": [...],
  "summary": "2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ"
}
    â†“
from_cache = True
execution_time = 0.005s
    â†“
API Response:
{
  "success": true,
  "result": {...},
  "execution_time": 0.005,
  "from_cache": true
}
```

### 6.3 ç¼“å­˜å¤±æ•ˆæµç¨‹

```
åœºæ™¯: æ•°æ®æ›´æ–°åéœ€è¦æ¸…é™¤ç›¸å…³ç¼“å­˜

1. æ¼”å”±è®°å½•æ–°å¢:
   SongRecord.objects.create(
     song=song_1,
     performed_at=date(2024, 12, 25)
   )

2. è§¦å‘æ¸…é™¤ç¼“å­˜:
   CacheManager.invalidate_pattern("song_stats")

3. Redis åˆ é™¤åŒ¹é…é”®:
   - DEL agent:song_stats:a1b2c3d4...
   - DEL agent:song_stats:e5f6g7h8...
   - DEL agent:song_stats:i9j0k1l2...

4. ä¸‹æ¬¡æŸ¥è¯¢é‡æ–°æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
```

---

## ä¸ƒã€æ€§èƒ½æŒ‡æ ‡æ•°æ®æµ

### 7.1 æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡

```
æ¯æ¬¡æŸ¥è¯¢æ”¶é›†çš„æŒ‡æ ‡:

1. æ„å›¾è¯†åˆ«æ—¶é—´ (intent_recognition_time):
   - å¼€å§‹: æ¥æ”¶æŸ¥è¯¢è¯·æ±‚
   - ç»“æŸ: IntentRecognizer.recognize() è¿”å›
   - ç›®æ ‡: < 0.05s

2. ç¼“å­˜æ£€æŸ¥æ—¶é—´ (cache_check_time):
   - å¼€å§‹: ç”Ÿæˆç¼“å­˜é”®
   - ç»“æŸ: Redis GET è¿”å›
   - ç›®æ ‡: < 0.01s

3. æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ (db_query_time):
   - å¼€å§‹: Django ORM æ‰§è¡Œ
   - ç»“æŸ: è¿”å›æŸ¥è¯¢ç»“æœ
   - ç›®æ ‡: < 0.10s

4. ç»“æœæ ¼å¼åŒ–æ—¶é—´ (format_time):
   - å¼€å§‹: ResultFormatter.format()
   - ç»“æŸ: è¿”å›æ ¼å¼åŒ–ç»“æœ
   - ç›®æ ‡: < 0.01s

5. æ€»æ‰§è¡Œæ—¶é—´ (execution_time):
   execution_time = intent_recognition_time + 
                   cache_check_time + 
                   db_query_time + 
                   format_time
   - ç›®æ ‡: < 0.20s (æœªå‘½ä¸­ç¼“å­˜)
   - ç›®æ ‡: < 0.01s (å‘½ä¸­ç¼“å­˜)
```

### 7.2 ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡

```
æ¯æ—¥ç»Ÿè®¡è®¡ç®—:

1. æ€»æŸ¥è¯¢æ•° (total_queries):
   SELECT SUM(query_count) 
   FROM agent_query_stats 
   WHERE date = '2026-02-03'

2. ç¼“å­˜å‘½ä¸­æ•° (cache_hits):
   SELECT COUNT(*) 
   FROM agent_query_history 
   WHERE date(created_at) = '2026-02-03' 
   AND from_cache = true

3. ç¼“å­˜å‘½ä¸­ç‡ (cache_hit_rate):
   cache_hit_rate = (cache_hits / total_queries) * 100

4. æ›´æ–°ç»Ÿè®¡è¡¨:
   QueryStats.objects.filter(date='2026-02-03').update(
     cache_hit_rate=cache_hit_rate
   )
```

---

## å…«ã€æ•°æ®å­˜å‚¨æµè½¬

### 8.1 æ•°æ®åº“å†™å…¥æµç¨‹

```
ç”¨æˆ·æŸ¥è¯¢å®Œæˆå:

1. æŸ¥è¯¢å†å²è®°å½•:
   QueryHistory.objects.create(
     user_id='user_123',
     query='2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ',
     intent_type='song_stats',
     parameters={'year': 2024, 'limit': 5, 'sort_by': 'perform_count'},
     result={
       'type': 'table',
       'columns': [...],
       'rows': [...],
       'summary': '2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ'
     },
     execution_time=0.15,
     from_cache=False,
     created_at=timezone.now()
   )

2. æŸ¥è¯¢ç»Ÿè®¡æ›´æ–°:
   QueryStats.objects.update_or_create(
     date=date(2026, 2, 3),
     intent_type='song_stats',
     defaults={
       'query_count': F('query_count') + 1,
       'avg_execution_time': 0.15,
       'cache_hit_rate': 25.0
     }
   )

3. ä¸Šä¸‹æ–‡å­˜å‚¨ (å¯é€‰):
   # å¦‚æœå¯ç”¨RedisæŒä¹…åŒ–ä¸Šä¸‹æ–‡
   redis_client.set(
     f"context:user_123",
     json.dumps(context.to_dict()),
     ex=3600  # 1å°æ—¶è¿‡æœŸ
   )
```

### 8.2 æ•°æ®åº“è¯»å–æµç¨‹

```
ç”¨æˆ·è¯·æ±‚æŸ¥è¯¢å†å²:

GET /api/agent/history?user_id=user_123

1. æŸ¥è¯¢å†å²:
   histories = QueryHistory.objects.filter(
     user_id='user_123'
   ).order_by('-created_at')[:50]

2. åºåˆ—åŒ–ç»“æœ:
   result = [
     {
       'id': h.id,
       'query': h.query,
       'intent_type': h.intent_type,
       'parameters': h.parameters,
       'result': h.result,
       'execution_time': h.execution_time,
       'from_cache': h.from_cache,
       'created_at': h.created_at.isoformat()
     }
     for h in histories
   ]

3. è¿”å›:
   {
     'success': true,
     'data': result,
     'total': len(result)
   }
```

---

## ä¹ã€å®æ—¶ç›‘æ§æ•°æ®æµ

### 9.1 æ—¥å¿—è¾“å‡ºæµç¨‹

```
æŸ¥è¯¢å¤„ç†è¿‡ç¨‹ä¸­çš„æ—¥å¿—:

[2026-02-03 10:30:00] INFO - Received query: "2024å¹´å”±å¾—æœ€å¤šçš„5é¦–æ­Œ" from user_123
[2026-02-03 10:30:00] INFO - Intent recognized: song_stats (confidence: 0.92)
[2026-02-03 10:30:00] INFO - Cache check: MISS (key: agent:song_stats:a1b2c3d4...)
[2026-02-03 10:30:00] INFO - DB query executed in 0.12s
[2026-02-03 10:30:00] INFO - Result formatted in 0.005s
[2026-02-03 10:30:01] INFO - Query completed in 0.15s
[2026-02-03 10:30:01] INFO - Result cached (expires in 300s)
[2026-02-03 10:30:01] INFO - Context updated for user_123
```

### 9.2 æ€§èƒ½ç›‘æ§æ•°æ®æµ

```
æ¯åˆ†é’Ÿæ”¶é›†çš„æ€§èƒ½æŒ‡æ ‡:

1. æŸ¥è¯¢é‡:
   - queries_per_minute: COUNT(*) WHERE created_at > NOW() - INTERVAL 1 MINUTE

2. å¹³å‡å“åº”æ—¶é—´:
   - avg_response_time: AVG(execution_time) WHERE created_at > NOW() - INTERVAL 1 MINUTE

3. ç¼“å­˜å‘½ä¸­ç‡:
   - cache_hit_rate: (SUM(CASE WHEN from_cache THEN 1 ELSE 0 END) / COUNT(*)) * 100

4. é”™è¯¯ç‡:
   - error_rate: (SUM(CASE WHEN NOT success THEN 1 ELSE 0 END) / COUNT(*)) * 100

5. å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ:
   POST /monitoring/metrics
   {
     "timestamp": "2026-02-03T10:30:00Z",
     "metrics": {
       "queries_per_minute": 45,
       "avg_response_time": 0.12,
       "cache_hit_rate": 32.5,
       "error_rate": 0.0
     }
   }
```

---

## åã€æ€»ç»“

### 10.1 å®Œæ•´æ•°æ®æµæ—¶é—´çº¿

```
T=0.000s: ç”¨æˆ·è¾“å…¥æŸ¥è¯¢
T=0.005s: é€Ÿç‡é™åˆ¶æ£€æŸ¥é€šè¿‡
T=0.010s: å®‰å…¨è¿‡æ»¤å™¨æ£€æŸ¥é€šè¿‡
T=0.050s: æ„å›¾è¯†åˆ«å®Œæˆ (0.040s)
T=0.060s: ç¼“å­˜æ£€æŸ¥ - æœªå‘½ä¸­ (0.010s)
T=0.180s: æ•°æ®åº“æŸ¥è¯¢å®Œæˆ (0.120s)
T=0.185s: ç»“æœæ ¼å¼åŒ–å®Œæˆ (0.005s)
T=0.190s: ç¼“å­˜ç»“æœ (0.005s)
T=0.195s: ä¸Šä¸‹æ–‡æ›´æ–°å®Œæˆ (0.005s)
T=0.200s: ç›‘æ§æ—¥å¿—è®°å½•å®Œæˆ (0.005s)
T=0.200s: APIå“åº”è¿”å›

æ€»è€—æ—¶: 0.200s
```

### 10.2 æ•°æ®æµå…³é”®èŠ‚ç‚¹

| èŠ‚ç‚¹ | è¾“å…¥æ•°æ® | è¾“å‡ºæ•°æ® | è€—æ—¶ | æ•°æ®å­˜å‚¨ |
|-----|---------|---------|-----|---------|
| 1. é€Ÿç‡é™åˆ¶ | user_id | å…è®¸/æ‹’ç» | 0.005s | Redis |
| 2. æ„å›¾è¯†åˆ« | queryæ–‡æœ¬ | Intentå¯¹è±¡ | 0.040s | æ—  |
| 3. ç¼“å­˜æ£€æŸ¥ | ç¼“å­˜é”® | ç¼“å­˜ç»“æœ/None | 0.010s | Redis |
| 4. æ•°æ®åº“æŸ¥è¯¢ | Intentå‚æ•° | åŸå§‹æ•°æ® | 0.120s | SQLite |
| 5. ç»“æœæ ¼å¼åŒ– | åŸå§‹æ•°æ® | æ ¼å¼åŒ–ç»“æœ | 0.005s | æ—  |
| 6. ç¼“å­˜å­˜å‚¨ | æ ¼å¼åŒ–ç»“æœ | æˆåŠŸ/å¤±è´¥ | 0.005s | Redis |
| 7. ä¸Šä¸‹æ–‡ç®¡ç† | æŸ¥è¯¢ç»“æœ | ä¸Šä¸‹æ–‡å¯¹è±¡ | 0.005s | Redis/å†…å­˜ |
| 8. ç›‘æ§è®°å½• | æ‰§è¡Œç»Ÿè®¡ | æ—¥å¿— | 0.005s | æ–‡ä»¶/æ•°æ®åº“ |

### 10.3 æ•°æ®æµä¼˜åŒ–ç‚¹

1. **ç¼“å­˜ä¼˜åŒ–**: æé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼Œç›®æ ‡ > 50%
2. **æ•°æ®åº“ä¼˜åŒ–**: æ·»åŠ ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢è¯­å¥
3. **æ„å›¾è¯†åˆ«ä¼˜åŒ–**: ä½¿ç”¨æ›´é«˜æ•ˆçš„åŒ¹é…ç®—æ³•
4. **æ‰¹é‡æŸ¥è¯¢**: å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°
5. **å¼‚æ­¥å¤„ç†**: éå…³é”®è·¯å¾„ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡

---

## é™„å½•

### A. æ•°æ®åº“è¡¨ç»“æ„

```sql
-- æŸ¥è¯¢å†å²è¡¨
CREATE TABLE agent_query_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id VARCHAR(100) NOT NULL,
    query TEXT NOT NULL,
    intent_type VARCHAR(50) NOT NULL,
    parameters JSON,
    result JSON,
    execution_time REAL NOT NULL,
    from_cache BOOLEAN DEFAULT FALSE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_query_history_user ON agent_query_history(user_id, created_at);
CREATE INDEX idx_query_history_intent ON agent_query_history(intent_type);

-- æŸ¥è¯¢ç»Ÿè®¡è¡¨
CREATE TABLE agent_query_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    date DATE NOT NULL,
    intent_type VARCHAR(50) NOT NULL,
    query_count INTEGER DEFAULT 0,
    avg_execution_time REAL DEFAULT 0,
    cache_hit_rate REAL DEFAULT 0,
    UNIQUE(date, intent_type)
);

CREATE INDEX idx_query_stats_date ON agent_query_stats(date);
```

### B. Redisæ•°æ®ç»“æ„

```
# é€Ÿç‡é™åˆ¶
String: ratelimit:{user_id}
Value: count (int)
TTL: 60s

# æŸ¥è¯¢ç¼“å­˜
String: agent:{intent_type}:{hash}
Value: JSON result
TTL: 300s

# ä¸Šä¸‹æ–‡å­˜å‚¨
String: context:{user_id}
Value: JSON context
TTL: 3600s

# æ€§èƒ½ç»Ÿè®¡
Hash: metrics:2026-02-03
Fields:
  - queries_per_minute: int
  - avg_response_time: float
  - cache_hit_rate: float
  - error_rate: float
```

### C. APIå“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "intent": {
    "type": "song_stats",
    "parameters": {
      "year": 2024,
      "limit": 5,
      "sort_by": "perform_count"
    },
    "confidence": 0.92
  },
  "result": {
    "type": "table",
    "columns": ["æ­Œæ›²åç§°", "æ­Œæ‰‹", "æ¼”å”±æ¬¡æ•°", "é¦–æ¬¡æ¼”å”±", "æœ€è¿‘æ¼”å”±"],
    "rows": [
      ["ç¨»é¦™", "å‘¨æ°ä¼¦", 12, "2024-03-15", "2024-12-20"],
      ["é’èŠ±ç“·", "å‘¨æ°ä¼¦", 10, "2024-01-08", "2024-11-25"],
      ["å‘Šç™½æ°”çƒ", "å‘¨æ°ä¼¦", 8, "2024-02-20", "2024-10-15"],
      ["å¤œæ›²", "å‘¨æ°ä¼¦", 7, "2024-04-05", "2024-12-05"],
      ["ç®€å•çˆ±", "å‘¨æ°ä¼¦", 6, "2024-01-25", "2024-09-30"]
    ],
    "summary": "2024å¹´æ¼”å”±æœ€å¤šçš„5é¦–æ­Œ"
  },
  "execution_time": 0.15,
  "from_cache": false,
  "meta": {
    "query_id": "abc123",
    "timestamp": "2026-02-03T10:30:01Z"
  }
}
```