# 直播记录 BV 号导入功能

## 功能概述

在 Django Admin 的"直播记录"模块中添加"导入 BV 号"功能，支持从 B 站视频导入直播记录信息。该功能类似于"演唱记录"中的 BV 号导入功能，但针对直播记录的库表格式进行了优化。

## 实现文件

| 文件路径 | 说明 |
|---------|------|
| `repo/xxm_fans_backend/livestream/forms.py` | BV 导入表单定义 |
| `repo/xxm_fans_backend/livestream/admin.py` | Admin 配置和导入逻辑实现 |
| `repo/xxm_fans_backend/templates/admin/livestream_change_list.html` | 列表页面添加导入按钮 |
| `repo/xxm_fans_backend/templates/admin/import_bv_livestream_form.html` | 导入页面模板 |
| `repo/xxm_fans_backend/templates/admin/select_cover.html` | 封面选择页面模板 |

## 核心功能

### 1. 标题格式解析

支持以下日期格式：
- `YYYY-MM-DD`（如：2019-12-10）
- `YYYY年M月D日`（如：2019年12月10日）

**支持的标题格式示例：**
```
咻咻满-2019-12-10-直播录像-户外专场，全程高能！！！
咻咻满-2019年12月10日-直播录像
主播名-2020-01-15-直播录像-新年特别节目
```

### 2. 标题与简介分离

系统会识别标题中的"直播录像"关键字，智能分离标题和简介：

| 原始标题 | 直播标题 | 直播简介 |
|---------|---------|---------|
| `咻咻满-2019-12-10-直播录像-户外专场，全程高能！！！` | `咻咻满-2019-12-10-直播录像` | `户外专场，全程高能！！！` |
| `咻咻满-2019-12-10-直播录像` | `咻咻满-2019-12-10-直播录像` | `2019-12-10 的精彩直播时刻`（默认） |

**规则：**
- 标题保留到"直播录像"为止（包含主播名和日期）
- "直播录像"之后的部分作为简介（不含日期）
- 支持多种分隔符：`-`、`:`、空格等

### 3. 多 P 视频处理

- **单记录原则**：无论视频包含多少分 P，只创建一条直播记录
- 从第一个分 P 的标题中提取日期和标题信息
- 记录总分 P 数到 `parts` 字段
- 自动计算总时长（所有分 P 的 duration 之和）

### 4. 自动填充字段

导入时自动填充以下字段：

| 字段 | 说明 |
|-----|------|
| `date` | 从标题解析的日期 |
| `title` | 处理后的标题（含日期） |
| `summary` | 直播简介（不含日期） |
| `bvid` | B 站视频 BV 号 |
| `parts` | 视频分 P 数 |
| `duration_seconds` | 直播总时长（秒） |
| `duration_formatted` | 格式化时长（如：3h4m50s） |
| `cover_url` | 下载的封面路径（可选择保留或替换） |

### 5. 封面选择功能

当导入的日期已存在封面时，系统会显示封面选择页面：

**封面选择流程：**
1. 系统检测到该日期已有封面
2. 显示封面选择页面，左右对比展示：
   - **左侧**：现有封面缩略图 + 保留选项
   - **右侧**：待下载新封面预览 + 替换选项
3. 用户选择后点击确认，完成导入

**显示条件：**
- 该日期的直播记录已存在
- 现有记录已有封面（cover_url 不为空）
- 新视频的封面可下载

**处理逻辑：**
- 选择"保留现有封面"：不下载新封面，其他信息正常更新
- 选择"使用新封面"：下载并替换为新封面，其他信息正常更新

### 6. 重复记录处理

- **按日期判断**：系统根据直播日期判断记录是否已存在
- **不会重复创建**：同一天的直播只会有一条记录
- **自动补充 BV 号**：如果该日期记录已存在但没有 BV 号，导入时会自动补充 BV 号、直播时长和分段数
- **保护已有数据**：如果记录已有 BV 号，导入时只会更新标题、封面等信息，不会覆盖原有 BV 号
- **封面可选替换**：如果记录已有封面，系统会提示用户选择是否替换

## 使用方式

### 1. 访问导入页面

在 Django Admin 的"直播记录"列表页面，点击右上角的"导入 BV 号"按钮。

### 2. 输入 BV 号

在输入框中输入 B 站视频的 BV 号，例如：`BV1xx411c7mD`

### 3. 系统自动处理

点击"导入"按钮后，系统会自动：
1. 调用 B 站 API 获取视频信息和分 P 列表
2. 解析第一个分 P 的标题，提取日期和标题信息
3. 下载视频封面到 `/media/covers/{year}/{month}/YYYY-MM-DD.jpg`
4. 计算直播总时长
5. 创建或更新直播记录

### 4. 查看结果

导入完成后，系统会显示处理结果：
- ✅ 新建记录：该日期的直播记录已创建
- ✅ 更新记录（补充 BV 号）：已有记录被补充了 BV 号、时长等信息
- ✅ 更新记录（更新信息）：已有记录被更新了标题、封面等信息

## 技术实现

### 核心类和方法

```python
class LivestreamAdmin(admin.ModelAdmin):
    def import_bv_view(self, request):
        """处理导入请求视图"""
        
    def select_cover_view(self, request):
        """封面选择视图"""
        
    def _parse_bv_info(self, bvid: str) -> dict:
        """
        解析BV号信息
        返回包含日期、标题、简介、封面URL等信息的字典
        """
        
    def _save_livestream(self, bv_info: dict, existing: Livestream = None, 
                         replace_cover: bool = True) -> dict:
        """
        保存直播记录
        支持选择是否替换封面
        """
        
    def _get_cover_display_url(self, cover_path: str) -> str:
        """
        获取封面用于显示的URL
        处理相对路径和绝对路径的转换
        """
        
    def _format_duration(self, seconds: int) -> str:
        """
        将秒数格式化为可读字符串
        例如：7384 -> "2h3m4s"
        """
```

### 依赖的 B 站工具

使用项目统一的 B 站工具模块：

```python
from tools.bilibili import BilibiliAPIClient, BilibiliCoverDownloader, BilibiliAPIError
```

- `BilibiliAPIClient`：获取视频信息和分 P 列表
- `BilibiliCoverDownloader`：下载视频封面
- `BilibiliAPIError`：API 错误处理

## 注意事项

1. **标题格式要求**：视频标题必须包含可识别的日期格式，否则无法导入
2. **网络依赖**：需要能够访问 B 站 API 才能获取视频信息
3. **封面下载**：封面下载失败不会影响记录创建，会使用空值
4. **分 P 一致性**：多 P 视频的所有分 P 应该属于同一天直播，否则只取第一个分 P 的日期
5. **封面选择**：当已有封面时，系统会显示选择页面，用户可决定是否替换
6. **封面路径**：现有封面的路径需要能被正确解析为可访问的URL才能显示缩略图

## 示例场景

### 场景 1：全新导入

**输入：** `BV1xx411c7mD`  
**视频标题：** `咻咻满-2019-12-10-直播录像-户外专场，全程高能！！！`  
**结果：**
- 创建新记录
- 日期：2019-12-10
- 标题：咻咻满-2019-12-10-直播录像
- 简介：户外专场，全程高能！！！
- 分段数：1

### 场景 2：补充已有记录

**数据库状态：** 已存在 date=2019-12-10 的记录，但 bvid=''  
**输入：** `BV1xx411c7mD`  
**视频标题：** `咻咻满-2019-12-10-直播录像`  
**结果：**
- 更新现有记录
- 补充 BV 号
- 补充直播时长
- 补充分段数

### 场景 3：多 P 视频

**输入：** `BV1xx411c7mD`  
**分 P 标题：**
- P1: `咻咻满-2019-12-10-直播录像-上半场`
- P2: `咻咻满-2019-12-10-直播录像-下半场`

**结果：**
- 创建一条记录（取 P1 信息）
- 日期：2019-12-10
- 标题：咻咻满-2019-12-10-直播录像
- 简介：上半场
- 分段数：2
- 时长：P1 时长 + P2 时长

### 场景 4：封面选择

**数据库状态：** 已存在 date=2019-12-10 的记录，且有封面  
**输入：** `BV1xx411c7mD`  
**系统响应：**
- 显示封面选择页面
- 左侧：现有封面缩略图 + "保留现有封面"选项
- 右侧：B站新封面预览 + "使用新封面"选项

**用户选择"使用新封面"后：**
- 更新记录
- 替换为B站视频封面
- 更新其他信息（标题、时长等）
- 提示：✅ 2019-12-10 - 咻咻满-2019-12-10-直播录像（替换封面）- 更新记录

## 更新历史

| 日期 | 更新内容 |
|-----|---------|
| 2026-02-12 | 初始实现：支持 BV 号导入、标题解析、封面下载、多 P 处理 |
| 2026-02-12 | 改进多 P 逻辑：只创建单条记录，记录总分 P 数 |
| 2026-02-12 | 添加重复记录检测和 BV 号自动补充 |
| 2026-02-12 | 添加直播时长计算和格式化 |
| 2026-02-12 | 实现标题与简介分离：标题含日期，简介不含日期 |
| 2026-02-12 | 添加封面选择功能：支持对比显示和手动选择是否替换 |
| 2026-02-12 | 修复封面下载：使用原封面文件名保持文件名一致，确保成功替换 |
