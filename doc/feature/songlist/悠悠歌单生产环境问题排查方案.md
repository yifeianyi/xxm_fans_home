# 悠悠歌单生产环境问题排查方案

## 一、生产环境特点

与开发环境不同，生产环境具有以下特点：

1. **使用静态文件构建**：前端是 `npm run build` 产物，不是 Vite 开发服务器
2. **HTTPS 访问**：使用 SSL 证书，端口 443
3. **独立域名**：`leyou.xxm8777.cn`
4. **Nginx 直接提供静态文件**：不通过代理转发
5. **后端 API 代理**：`/api/` 请求代理到 Django 后端

## 二、问题诊断清单

### 1. 检查域名解析

```bash
# 检查域名是否正确解析到服务器 IP
nslookup leyou.xxm8777.cn
ping leyou.xxm8777.cn

# 预期输出：服务器 IP 地址
```

### 2. 检查 Nginx 配置

```bash
# 检查 Nginx 配置文件是否存在
ls -la /etc/nginx/sites-enabled/youyou-songlist.conf

# 检查配置语法
sudo nginx -t

# 预期输出：
# nginx: configuration file /etc/nginx/nginx.conf test is successful
```

### 3. 检查 SSL 证书

```bash
# 检查 SSL 证书是否存在
sudo ls -la /etc/letsencrypt/live/leyou.xxm8777.cn/

# 预期输出：
# fullchain.pem
# privkey.pem

# 检查证书有效期
sudo certbot certificates

# 检查证书是否过期
echo | openssl s_client -connect leyou.xxm8777.cn:443 2>/dev/null | openssl x509 -noout -dates
```

### 4. 检查前端构建文件

```bash
# 检查 dist 目录是否存在
ls -la /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist/

# 检查 index.html 是否存在
ls -la /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist/index.html

# 检查文件权限
ls -ld /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist/
```

### 5. 检查后端服务

```bash
# 检查 Django 后端是否运行
ps aux | grep "gunicorn\|manage.py runserver"

# 检查端口 8000 是否监听
sudo netstat -tlnp | grep 8000

# 测试后端 API
curl -I http://127.0.0.1:8000/api/songlist/songs/?artist=youyou
```

### 6. 检查 Nginx 服务状态

```bash
# 检查 Nginx 服务状态
sudo systemctl status nginx

# 检查 Nginx 是否监听 80 和 443 端口
sudo netstat -tlnp | grep nginx

# 检查 Nginx 进程
ps aux | grep nginx
```

### 7. 检查防火墙

```bash
# 检查防火墙状态
sudo ufw status

# 检查是否开放了 80 和 443 端口
sudo ufw status | grep -E "80|443"

# 如果防火墙开启，需要开放端口
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

## 三、常见问题及解决方案

### 问题 1：访问域名显示 404 Not Found

**可能原因**：
1. Nginx 配置未启用
2. 前端构建文件不存在
3. 文件路径配置错误

**排查步骤**：

```bash
# 1. 检查 Nginx 配置是否启用
sudo ls -la /etc/nginx/sites-enabled/ | grep youyou-songlist

# 如果没有，创建软链接
sudo ln -s /home/yifeianyi/Desktop/xxm_fans_home/infra/nginx/youyou-songlist.conf /etc/nginx/sites-enabled/

# 2. 检查前端构建文件
ls -la /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist/index.html

# 如果不存在，重新构建
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend
npm run build

# 3. 检查 Nginx 配置中的路径
grep "root" /etc/nginx/sites-enabled/youyou-songlist.conf

# 4. 重载 Nginx
sudo nginx -t
sudo systemctl reload nginx
```

### 问题 2：HTTP 可以访问，HTTPS 显示连接错误

**可能原因**：
1. SSL 证书未申请
2. SSL 证书已过期
3. SSL 证书配置错误
4. 443 端口未开放

**排查步骤**：

```bash
# 1. 检查 SSL 证书是否存在
sudo ls -la /etc/letsencrypt/live/leyou.xxm8777.cn/

# 如果不存在，申请证书
sudo certbot --nginx -d leyou.xxm8777.cn

# 2. 检查证书有效期
sudo certbot certificates

# 如果过期，续期
sudo certbot renew

# 3. 检查 Nginx 配置中 HTTPS 部分
grep -A 30 "listen 443" /etc/nginx/sites-enabled/youyou-songlist.conf

# 确保 HTTPS server block 未被注释

# 4. 检查 443 端口是否开放
sudo netstat -tlnp | grep 443

# 5. 检查防火墙
sudo ufw status | grep 443

# 如果未开放，添加规则
sudo ufw allow 443/tcp

# 6. 重载 Nginx
sudo nginx -t
sudo systemctl reload nginx
```

### 问题 3：前端页面加载成功，但 API 请求失败

**可能原因**：
1. 后端服务未启动
2. 后端服务崩溃
3. API 代理配置错误
4. CORS 配置问题

**排查步骤**：

```bash
# 1. 检查后端服务状态
sudo systemctl status xxm-backend

# 如果使用 systemd 管理后端
ps aux | grep gunicorn

# 2. 测试后端 API 直接访问
curl -I http://127.0.0.1:8000/api/songlist/songs/?artist=youyou

# 3. 检查 Nginx API 代理配置
grep -A 15 "location /api/" /etc/nginx/sites-enabled/youyou-songlist.conf

# 4. 查看 Nginx 错误日志
sudo tail -50 /var/log/nginx/error.log

# 5. 查看后端日志
sudo journalctl -u xxm-backend -n 50

# 6. 检查后端 CORS 配置
grep -A 10 "CORS" /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/xxm_fans_home/settings.py

# 7. 重启后端服务
sudo systemctl restart xxm-backend
```

### 问题 4：图片资源加载失败

**可能原因**：
1. 图片文件不存在
2. 文件路径配置错误
3. 文件权限问题
4. Nginx 配置错误

**排查步骤**：

```bash
# 1. 检查图片文件是否存在
ls -la /home/yifeianyi/Desktop/xxm_fans_home/media/songlist/youyou/

# 2. 检查文件权限
ls -la /home/yifeianyi/Desktop/xxm_fans_home/media/

# 确保文件可读
sudo chmod -R 755 /home/yifeianyi/Desktop/xxm_fans_home/media/

# 3. 检查 Nginx 媒体文件配置
grep -A 10 "location /media/" /etc/nginx/sites-enabled/youyou-songlist.conf

# 4. 测试图片直接访问
curl -I http://leyou.xxm8777.cn/media/songlist/youyou/avatar.jpg

# 5. 查看 Nginx 访问日志
sudo tail -50 /var/log/nginx/access.log | grep media

# 6. 查看浏览器 Network 面板
# 确认图片请求路径和状态码
```

### 问题 5：页面显示旧版本（缓存问题）

**可能原因**：
1. 浏览器缓存
2. Nginx 缓存配置
3. CDN 缓存（如果使用）

**排查步骤**：

```bash
# 1. 检查 Nginx 缓存配置
grep -i "cache" /etc/nginx/sites-enabled/youyou-songlist.conf

# 2. 清除 Nginx 缓存（如果有配置缓存目录）
sudo rm -rf /var/cache/nginx/*

# 3. 重新构建前端，确保文件名包含哈希
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend
npm run build

# 4. 清除浏览器缓存
# Chrome/Edge: Ctrl+Shift+Delete
# Firefox: Ctrl+Shift+Delete

# 5. 使用无痕模式测试
# 打开浏览器无痕/隐私模式访问网站

# 6. 检查构建后的文件名
ls -la /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist/assets/

# 应该看到类似以下文件名（包含哈希）：
# index-abc123.js
# index-def456.css
```

### 问题 6：SSL 证书即将过期或已过期

**可能原因**：
1. Certbot 自动续期失败
2. 服务器时间不正确
3. 防火墙阻止续期

**排查步骤**：

```bash
# 1. 检查证书有效期
sudo certbot certificates

# 2. 检查 Certbot 自动续期服务
sudo systemctl status certbot.timer

# 3. 检查服务器时间
date

# 如果时间不正确，修正时间
sudo ntpdate -u time.nist.gov

# 4. 手动测试续期
sudo certbot renew --dry-run

# 5. 如果失败，检查日志
sudo journalctl -u certbot -n 50

# 6. 检查防火墙是否阻止 80 端口（续期需要 80 端口）
sudo ufw status | grep 80

# 7. 手动续期
sudo certbot renew

# 8. 重载 Nginx
sudo systemctl reload nginx
```

## 四、生产环境部署和更新流程

### 1. 前端构建和部署

```bash
# 1. 进入前端目录
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend

# 2. 安装依赖（如果是首次或更新依赖）
npm install

# 3. 生产构建
npm run build

# 4. 验证构建文件
ls -la dist/index.html

# 5. 重载 Nginx
sudo nginx -t
sudo systemctl reload nginx
```

### 2. 后端部署和更新

```bash
# 1. 进入后端目录
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend

# 2. 激活虚拟环境
source venv/bin/activate

# 3. 安装新依赖
pip install -r requirements.txt

# 4. 数据库迁移
python manage.py migrate

# 5. 收集静态文件
python manage.py collectstatic --noinput

# 6. 重启后端服务
sudo systemctl restart xxm-backend

# 7. 检查服务状态
sudo systemctl status xxm-backend
```

### 3. SSL 证书申请和配置

```bash
# 1. 确保 HTTP 可以访问
curl -I http://leyou.xxm8777.cn

# 2. 申请 SSL 证书
sudo certbot --nginx -d leyou.xxm8777.cn

# 3. 按提示操作：
# - 输入邮箱
# - 同意服务条款
# - 选择是否重定向 HTTP 到 HTTPS（建议选择是）

# 4. 验证证书
sudo certbot certificates

# 5. 测试 HTTPS 访问
curl -I https://leyou.xxm8777.cn
```

## 五、日志查看和分析

### Nginx 日志

```bash
# 访问日志
sudo tail -f /var/log/nginx/access.log

# 错误日志
sudo tail -f /var/log/nginx/error.log

# 查看特定域名的日志
sudo tail -f /var/log/nginx/access.log | grep leyou.xxm8777.cn

# 查看错误请求
sudo tail -f /var/log/nginx/error.log | grep leyou.xxm8777.cn
```

### 后端日志

```bash
# 如果使用 systemd 管理后端
sudo journalctl -u xxm-backend -f

# 查看最近 100 行
sudo journalctl -u xxm-backend -n 100

# 查看特定时间段的日志
sudo journalctl -u xxm-backend --since "1 hour ago"

# 如果后端有日志文件
tail -f /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/logs/error.log
```

### Certbot 日志

```bash
# 查看 Certbot 日志
sudo journalctl -u certbot -n 50

# 查看续期日志
sudo cat /var/log/letsencrypt/letsencrypt.log | tail -50
```

## 六、性能监控和优化

### 1. 检查服务器资源

```bash
# CPU 使用率
top

# 内存使用情况
free -h

# 磁盘使用情况
df -h

# 检查特定目录大小
du -sh /home/yifeianyi/Desktop/xxm_fans_home/
```

### 2. Nginx 性能优化

```bash
# 检查 Nginx 连接数
sudo netstat -an | grep :443 | wc -l

# 查看活跃连接
sudo netstat -an | grep :443 | grep ESTABLISHED | wc -l

# 检查 Nginx 配置限制
grep "worker_connections" /etc/nginx/nginx.conf
```

### 3. 启用 Gzip 压缩

在 Nginx 配置中添加：

```nginx
# 在 http 块中添加
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
```

## 七、安全检查

### 1. 检查文件权限

```bash
# 检查关键目录权限
ls -la /home/yifeianyi/Desktop/xxm_fans_home/

# 确保敏感文件不可公开访问
ls -la /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/.env
```

### 2. 检查防火墙规则

```bash
# 查看防火墙状态
sudo ufw status verbose

# 确保只开放必要的端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
```

### 3. 检查 Nginx 安全配置

```bash
# 检查是否配置了安全头
grep -i "X-Frame-Options\|X-Content-Type-Options" /etc/nginx/sites-enabled/youyou-songlist.conf
```

## 八、备份和恢复

### 1. 数据库备份

```bash
# 创建备份目录
mkdir -p /home/yifeianyi/backups

# 备份数据库
cp /home/yifeianyi/Desktop/xxm_fans_home/data/db.sqlite3 /home/yifeianyi/backups/db_$(date +%Y%m%d_%H%M%S).sqlite3

# 设置自动备份（添加到 crontab）
crontab -e

# 添加以下行（每天凌晨 2 点备份）
0 2 * * * cp /home/yifeianyi/Desktop/xxm_fans_home/data/db.sqlite3 /home/yifeianyi/backups/db_$(date +\%Y\%m\%d_\%H\%M\%S).sqlite3
```

### 2. 媒体文件备份

```bash
# 备份媒体文件
rsync -avz /home/yifeianyi/Desktop/xxm_fans_home/media/ /home/yifeianyi/backups/media_$(date +%Y%m%d)/
```

### 3. 配置文件备份

```bash
# 备份 Nginx 配置
sudo cp /etc/nginx/sites-enabled/youyou-songlist.conf /home/yifeianyi/backups/

# 备份后端配置
cp /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/.env /home/yifeianyi/backups/
```

## 九、故障恢复流程

### 场景 1：网站完全无法访问

```bash
# 1. 检查服务器是否在线
ping leyou.xxm8777.cn

# 2. 检查 Nginx 服务
sudo systemctl status nginx

# 如果未运行，启动
sudo systemctl start nginx

# 3. 检查防火墙
sudo ufw status

# 4. 检查端口监听
sudo netstat -tlnp | grep -E "80|443"

# 5. 检查域名解析
nslookup leyou.xxm8777.cn

# 6. 检查 SSL 证书
sudo certbot certificates

# 7. 查看日志
sudo tail -50 /var/log/nginx/error.log
```

### 场景 2：后端 API 失败

```bash
# 1. 检查后端服务
sudo systemctl status xxm-backend

# 2. 重启后端
sudo systemctl restart xxm-backend

# 3. 检查数据库
ls -la /home/yifeianyi/Desktop/xxm_fans_home/data/db.sqlite3

# 4. 检查后端日志
sudo journalctl -u xxm-backend -n 100

# 5. 测试 API
curl -I http://127.0.0.1:8000/api/songlist/songs/?artist=youyou
```

### 场景 3：SSL 证书问题

```bash
# 1. 检查证书
sudo certbot certificates

# 2. 手动续期
sudo certbot renew

# 3. 重载 Nginx
sudo systemctl reload nginx

# 4. 如果续期失败，重新申请
sudo certbot --nginx -d leyou.xxm8777.cn --force-renewal
```

## 十、定期维护任务

### 每日任务

- [ ] 检查服务器资源使用情况
- [ ] 查看错误日志
- [ ] 验证网站访问正常

### 每周任务

- [ ] 检查 SSL 证书有效期
- [ ] 检查磁盘空间
- [ ] 备份数据库和媒体文件

### 每月任务

- [ ] 更新系统安全补丁
- [ ] 检查 Nginx 访问日志异常
- [ ] 审查防火墙规则
- [ ] 测试备份恢复流程

## 十一、相关文件路径

### Nginx 配置

```
/etc/nginx/sites-enabled/youyou-songlist.conf    # 生产环境配置
/home/yifeianyi/Desktop/xxm_fans_home/infra/nginx/youyou-songlist.conf  # 配置源文件
```

### 前端文件

```
/home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist/  # 构建产物
/home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/photos/  # 图片资源
```

### 后端文件

```
/home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/  # 后端代码
/home/yifeianyi/Desktop/xxm_fans_home/data/db.sqlite3  # 数据库
/home/yifeianyi/Desktop/xxm_fans_home/media/  # 媒体文件
```

### 日志文件

```
/var/log/nginx/access.log  # Nginx 访问日志
/var/log/nginx/error.log   # Nginx 错误日志
/var/log/letsencrypt/letsencrypt.log  # Certbot 日志
/home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/logs/  # 后端日志
```

### SSL 证书

```
/etc/letsencrypt/live/leyou.xxm8777.cn/  # 证书目录
/etc/letsencrypt/live/leyou.xxm8777.cn/fullchain.pem  # 证书文件
/etc/letsencrypt/live/leyou.xxm8777.cn/privkey.pem  # 私钥文件
```

### systemd 服务

```
/etc/systemd/system/xxm-backend.service  # 后端服务配置
/etc/systemd/system/certbot.timer  # SSL 自动续期定时任务
```

---

**文档版本**: 1.0
**创建日期**: 2026-01-27
**适用环境**: 生产环境（Production）
**维护者**: XXM Fans Home Team

**重要提示**：
1. 生产环境操作前务必先备份
2. 建议先在测试环境验证配置
3. 执行重大更新前通知用户
4. 保持定期备份习惯
5. 监控服务运行状态