# 模板歌单子域名配置指南

本文档介绍如何为模板歌单系统配置多个歌手子域名。

---

## 架构概述

模板歌单系统支持通过不同的子域名访问不同歌手的歌单页面，所有子域名都共享同一个后端和前端构建产物。

### 域名结构

```
leyou.xxm8777.cn  -> 乐游歌单
youyou.xxm8777.cn -> 悠悠歌单
bingjie.xxm8777.cn -> 冰洁歌单
...
```

### 工作原理

1. **DNS 解析**: 所有子域名解析到同一台服务器
2. **Nginx 路由**: 根据不同的子域名提供 HTTPS 访问
3. **前端识别**: 前端通过 `window.location.hostname` 识别当前域名
4. **数据隔离**: 后端通过 `artist` 参数返回对应歌手的数据

---

## 配置步骤

### 方法一：使用自动化脚本（推荐）

使用 `setup_songlist_subdomain.sh` 脚本快速配置：

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/scripts

# 添加新歌手子域名
# 参数1: 子域名前缀（如: leyou）
# 参数2: 歌手配置键名（需要在 songlist/ARTIST_CONFIG 中定义）
sudo ./setup_songlist_subdomain.sh leyou youyou

# 添加悠悠歌单
sudo ./setup_songlist_subdomain.sh youyou youyou
```

脚本会自动完成以下操作：
1. ✅ 创建 Nginx 配置文件
2. ✅ 申请 SSL 证书
3. ✅ 启用 Nginx 配置
4. ✅ 更新前端域名配置
5. ✅ 提示 DNS 配置信息

### 方法二：手动配置

#### 1. 复制模板配置

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/infra/nginx

# 复制模板文件
cp songlist-template.conf leyou-songlist.conf
```

#### 2. 替换域名占位符

编辑 `leyou-songlist.conf`，将所有 `{{DOMAIN}}` 替换为实际域名：

```bash
# 使用 sed 批量替换
sed -i 's/{{DOMAIN}}/leyou.xxm8777.cn/g' leyou-songlist.conf
```

或手动编辑：

```nginx
server {
    listen 80;
    server_name leyou.xxm8777.cn;
    ...
}

server {
    listen 443 ssl http2;
    server_name leyou.xxm8777.cn;
    ...
}
```

#### 3. 部署 Nginx 配置

```bash
# 复制到 Nginx 配置目录
sudo cp leyou-songlist.conf /etc/nginx/sites-available/

# 创建软链接启用配置
sudo ln -s /etc/nginx/sites-available/leyou-songlist.conf /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载 Nginx
sudo systemctl reload nginx
```

#### 4. 申请 SSL 证书

```bash
# 使用 Certbot 申请证书
sudo certbot --nginx -d leyou.xxm8777.cn
```

按提示操作：
- 输入邮箱地址
- 同意服务条款
- 选择是否将 HTTP 流量重定向到 HTTPS

#### 5. 配置 DNS

在域名服务商（如阿里云、腾讯云）的 DNS 管理中添加 A 记录：

| 类型 | 主机记录 | 记录值 | TTL |
|------|----------|--------|-----|
| A    | leyou    | 服务器IP地址 | 600 |

#### 6. 更新前端域名配置

编辑前端环境变量文件：

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend

# 编辑 .env 文件
nano .env
```

添加域名到歌手的映射：

```env
# 域名到歌手的映射配置
leyou.xxm8777.cn=youyou
youyou.xxm8777.cn=youyou
bingjie.xxm8777.cn=bingjie
```

#### 7. 重新构建前端（如需要）

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend

# 生产构建
npm run build
```

---

## 后端配置

### 1. 定义歌手配置

在 `repo/xxm_fans_backend/songlist/__init__.py` 中定义歌手：

```python
ARTIST_CONFIG = {
    'youyou': {
        'name': '悠悠',
        'description': '悠悠的歌单',
    },
    'bingjie': {
        'name': '冰洁',
        'description': '冰洁的歌单',
    },
    'leyou': {
        'name': '乐游',
        'description': '乐游的歌单',
    },
}
```

### 2. 添加歌手数据

通过 Django Admin 后台添加歌手的歌曲数据：

1. 访问 `https://xxm8777.cn/admin/`
2. 进入 Songlist 应用
3. 为对应的 `artist_key` 添加歌曲数据

---

## 配置文件说明

### Nginx 配置模板

`infra/nginx/songlist-template.conf` 是通用配置模板，包含：

- **HTTP 重定向到 HTTPS**
- **SSL 证书配置**
- **前端静态文件服务**
- **API 代理到后端**
- **媒体文件服务**
- **静态文件服务**
- **SEO 文件支持**

### 前端域名配置

`repo/TempSongListFrontend/.env` 文件定义域名到歌手的映射：

```env
# 域名到歌手的映射配置
localhost=youyou
127.0.0.1=youyou
leyou.xxm8777.cn=youyou
youyou.xxm8777.cn=youyou

# 默认值（当域名不匹配时使用）
DEFAULT_ARTIST=youyou
```

---

## 验证配置

### 1. 检查 DNS 解析

```bash
# 在本地终端执行
ping leyou.xxm8777.cn

# 或使用 nslookup
nslookup leyou.xxm8777.cn
```

### 2. 检查 SSL 证书

```bash
# 查看证书列表
sudo certbot certificates

# 访问 HTTPS 网站
curl -I https://leyou.xxm8777.cn
```

### 3. 检查 Nginx 状态

```bash
# 查看 Nginx 状态
sudo systemctl status nginx

# 查看监听端口
sudo netstat -tlnp | grep -E '80|443'
```

### 4. 测试网站访问

在浏览器中访问 `https://leyou.xxm8777.cn`，应该能看到对应的歌手歌单页面。

---

## 常见问题

### 1. SSL 证书申请失败

**问题**: Certbot 无法验证域名所有权

**解决方案**:
- 确保域名已正确解析到服务器
- 等待 DNS 生效（通常 10-30 分钟）
- 检查服务器防火墙是否开放 80 和 443 端口

```bash
# 检查防火墙状态
sudo ufw status

# 开放端口
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

### 2. Nginx 配置测试失败

**问题**: `nginx -t` 报错

**解决方案**:
- 检查配置文件语法
- 确保 SSL 证书路径正确
- 检查文件路径权限

```bash
# 查看详细错误
sudo nginx -t

# 查看 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log
```

### 3. 前端无法识别域名

**问题**: 前端显示错误的歌手数据

**解决方案**:
- 检查 `.env` 文件中的域名配置
- 确保域名格式正确（不包含协议前缀）
- 重新构建前端

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend

# 检查配置
cat .env

# 重新构建
npm run build
```

### 4. API 请求失败

**问题**: 前端无法访问后端 API

**解决方案**:
- 检查后端服务是否运行
- 检查 Nginx API 代理配置
- 查看后端日志

```bash
# 检查后端服务
sudo systemctl status xxm-backend

# 查看后端日志
sudo journalctl -u xxm-backend -f

# 测试 API
curl http://127.0.0.1:8000/api/songlist/songs/?artist=youyou
```

### 5. 媒体文件无法加载

**问题**: 图片等媒体文件显示 404

**解决方案**:
- 检查媒体文件路径配置
- 确保文件存在且有正确的权限
- 检查 Nginx media location 配置

```bash
# 检查文件路径
ls -la /home/yifeianyi/Desktop/xxm_fans_home/media/

# 检查权限
sudo chmod -R 755 /home/yifeianyi/Desktop/xxm_fans_home/media/
```

---

## 维护和管理

### 1. 查看所有子域名配置

```bash
# 列出所有启用的配置
ls -la /etc/nginx/sites-enabled/

# 查看所有 SSL 证书
sudo certbot certificates
```

### 2. 更新子域名配置

```bash
# 编辑 Nginx 配置
sudo nano /etc/nginx/sites-available/leyou-songlist.conf

# 测试并重载
sudo nginx -t
sudo systemctl reload nginx
```

### 3. 删除子域名

```bash
# 禁用配置
sudo rm /etc/nginx/sites-enabled/leyou-songlist.conf

# 删除配置文件
sudo rm /etc/nginx/sites-available/leyou-songlist.conf

# 撤销 SSL 证书
sudo certbot delete --cert-name leyou.xxm8777.cn

# 重载 Nginx
sudo systemctl reload nginx
```

### 4. SSL 证书自动续期

Certbot 会自动设置定时任务，检查续期配置：

```bash
# 查看定时任务
sudo systemctl status certbot.timer

# 手动测试续期
sudo certbot renew --dry-run
```

---

## 性能优化建议

### 1. 启用 Gzip 压缩

在 Nginx 配置中添加：

```nginx
http {
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
}
```

### 2. 配置缓存策略

```nginx
# 静态文件长期缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# API 不缓存
location /api/ {
    expires -1;
    add_header Cache-Control "no-store, no-cache, must-revalidate";
}
```

### 3. 使用 CDN

将静态文件部署到 CDN（如 Cloudflare、阿里云 CDN）以加速访问。

### 4. 数据库优化

- 定期清理无用的数据
- 为常用查询字段添加索引
- 考虑使用 Redis 缓存热门数据

---

## 安全建议

1. **定期更新系统**: `sudo apt update && sudo apt upgrade`
2. **配置防火墙**: 使用 ufw 或 iptables 限制访问
3. **启用 HSTS**: 在 Nginx 配置中已启用
4. **定期备份数据**: 设置自动备份任务
5. **监控日志**: 定期检查异常访问记录
6. **限制 Admin 访问**: 限制 Django Admin 的访问 IP

---

## 附录

### A. 配置文件路径

| 配置文件 | 路径 |
|----------|------|
| Nginx 配置模板 | `/home/yifeianyi/Desktop/xxm_fans_home/infra/nginx/songlist-template.conf` |
| Nginx 配置目录 | `/etc/nginx/sites-available/` |
| SSL 证书目录 | `/etc/letsencrypt/live/` |
| 前端环境变量 | `/home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/.env` |
| 后端歌手配置 | `/home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/songlist/__init__.py` |

### B. 常用命令

```bash
# Nginx 管理
sudo systemctl start nginx      # 启动
sudo systemctl stop nginx       # 停止
sudo systemctl restart nginx    # 重启
sudo systemctl reload nginx     # 重载配置
sudo nginx -t                   # 测试配置

# SSL 证书
sudo certbot renew              # 续期
sudo certbot certificates       # 查看证书
sudo certbot delete             # 删除证书

# 日志查看
sudo tail -f /var/log/nginx/access.log  # 访问日志
sudo tail -f /var/log/nginx/error.log   # 错误日志

# DNS 查询
nslookup leyou.xxm8777.cn      # 查询 DNS
dig leyou.xxm8777.cn            # 详细 DNS 信息
```

### C. 参考文档

- [Nginx 官方文档](https://nginx.org/en/docs/)
- [Certbot 官方文档](https://certbot.eff.org/)
- [Django 部署文档](https://docs.djangoproject.com/en/stable/howto/deployment/)
- [项目部署指南](/doc/songlist/youyou-songlist-cloud-deployment-guide.md)

---

**文档版本**: 1.0
**最后更新**: 2026-01-27
**维护者**: XXM Fans Home Team