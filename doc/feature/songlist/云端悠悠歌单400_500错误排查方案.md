# äº‘ç«¯æ‚ æ‚ æ­Œå• 400/500 é”™è¯¯æŽ’æŸ¥æ–¹æ¡ˆ

## ðŸš¨ é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼šæµè§ˆå™¨è®¿é—® `leyou.xxm8777.cn` æ—¶ï¼ŒAPI è¿”å›ž 400 æˆ– 500 é”™è¯¯ç 

**å½“å‰é…ç½®çŠ¶æ€**ï¼š
- åŸŸåï¼š`leyou.xxm8777.cn`
- HTTPS é…ç½®ï¼š**è¢«æ³¨é‡ŠæŽ‰**ï¼ˆSSL è¯ä¹¦æœªç”³è¯·ï¼‰
- å®žé™…è¿è¡Œï¼šä»… HTTP 80 ç«¯å£ï¼Œé‡å®šå‘åˆ° HTTPS

---

## ðŸ” å¿«é€Ÿè¯Šæ–­æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç¡®è®¤ SSL è¯ä¹¦çŠ¶æ€

```bash
# SSH ç™»å½•åˆ°ç”Ÿäº§æœåŠ¡å™¨
ssh user@your-server-ip

# æ£€æŸ¥ SSL è¯ä¹¦æ˜¯å¦å­˜åœ¨
ls -la /etc/letsencrypt/live/leyou.xxm8777.cn/

# æ£€æŸ¥ Nginx é…ç½®è¯­æ³•
sudo nginx -t

# æŸ¥çœ‹å½“å‰ç”Ÿæ•ˆçš„ Nginx é…ç½®
sudo nginx -T | grep -A 20 "server_name leyou.xxm8777.cn"
```

### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ Nginx æ—¥å¿—

```bash
# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—ï¼ˆæœ€è¿‘çš„ 50 è¡Œï¼‰
sudo tail -50 /var/log/nginx/error.log

# æŸ¥çœ‹ Nginx è®¿é—®æ—¥å¿—ï¼ˆè¿‡æ»¤ 400/500 é”™è¯¯ï¼‰
sudo tail -100 /var/log/nginx/access.log | grep -E " 400 | 500 "

# å®žæ—¶ç›‘æŽ§é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

### ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯• API ç«¯ç‚¹

```bash
# åœ¨æœåŠ¡å™¨æœ¬åœ°æµ‹è¯• API
curl -I http://127.0.0.1:8000/api/songlist/songs/?artist=youyou

# æµ‹è¯•é€šè¿‡ Nginx ä»£ç†
curl -I http://127.0.0.1/api/songlist/songs/?artist=youyou

# æµ‹è¯•å¤–éƒ¨è®¿é—®ï¼ˆæ›¿æ¢ä¸ºå®žé™…æœåŠ¡å™¨ IPï¼‰
curl -I http://your-server-ip/api/songlist/songs/?artist=youyou
```

### ç¬¬å››æ­¥ï¼šæ£€æŸ¥åŽç«¯æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥ Django åŽç«¯è¿›ç¨‹
ps aux | grep -E "gunicorn|python.*manage.py"

# æ£€æŸ¥åŽç«¯ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep :8000
# æˆ–
sudo ss -tlnp | grep :8000

# æ£€æŸ¥ systemd æœåŠ¡ï¼ˆå¦‚æžœä½¿ç”¨ï¼‰
sudo systemctl status django-backend
sudo journalctl -u django-backend -n 50
```

---

## ðŸ“‹ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1ï¼šHTTPS é‡å®šå‘å¾ªçŽ¯

**ç—‡çŠ¶**ï¼šè®¿é—®åŸŸåæ—¶æµè§ˆå™¨æç¤º"é‡å®šå‘æ¬¡æ•°è¿‡å¤š"

**åŽŸå› **ï¼šNginx é…ç½®ä¸­ HTTPS server block è¢«æ³¨é‡Šï¼Œä½†ä»ç„¶é‡å®šå‘åˆ° HTTPS

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# ä¸´æ—¶æ–¹æ¡ˆï¼šå–æ¶ˆ HTTPS é‡å®šå‘ï¼Œä½¿ç”¨ HTTP è®¿é—®
sudo nano /etc/nginx/sites-enabled/leyou-songlist.conf

# ä¿®æ”¹ 80 ç«¯å£çš„ location / ä¸ºï¼š
location / {
    root /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist;
    try_files $uri $uri/ /index.html;
}

# é‡è½½ Nginx
sudo nginx -s reload
```

### é—®é¢˜ 2ï¼šSSL è¯ä¹¦æœªé…ç½®

**ç—‡çŠ¶**ï¼šè®¿é—® `https://leyou.xxm8777.cn` æ—¶æµè§ˆå™¨æç¤º"è¿žæŽ¥ä¸å®‰å…¨"æˆ– 404

**è§£å†³æ–¹æ¡ˆ - ç”³è¯· SSL è¯ä¹¦**ï¼š

```bash
# 1. ç¡®ä¿ Nginx é…ç½®ä¸­ 80 ç«¯å£çš„ acme-challenge location å·²é…ç½®
# ï¼ˆå·²åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæ— éœ€ä¿®æ”¹ï¼‰

# 2. ä½¿ç”¨ Certbot ç”³è¯·è¯ä¹¦
sudo certbot certonly --webroot \
  -w /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist \
  -d leyou.xxm8777.cn

# 3. éªŒè¯è¯ä¹¦å·²ç”Ÿæˆ
ls -la /etc/letsencrypt/live/leyou.xxm8777.cn/

# 4. å–æ¶ˆæ³¨é‡Š Nginx é…ç½®ä¸­çš„ HTTPS server block
sudo nano /etc/nginx/sites-enabled/leyou-songlist.conf

# 5. æµ‹è¯•é…ç½®
sudo nginx -t

# 6. é‡è½½ Nginx
sudo nginx -s reload
```

### é—®é¢˜ 3ï¼šåŽç«¯ API 500 é”™è¯¯

**ç—‡çŠ¶**ï¼šAPI è¯·æ±‚è¿”å›ž 500 Internal Server Error

**æŽ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æŸ¥çœ‹åŽç«¯æ—¥å¿—
tail -50 /tmp/backend.log
# æˆ–
journalctl -u django-backend -n 50

# 2. æ£€æŸ¥ Django è°ƒè¯•é¡µé¢ï¼ˆå¦‚æžœ DEBUG=Trueï¼‰
# æµè§ˆå™¨è®¿é—®é”™è¯¯é¡µé¢æŸ¥çœ‹è¯¦ç»†å †æ ˆ

# 3. æ£€æŸ¥æ•°æ®åº“è¿žæŽ¥
python3 manage.py dbshell

# 4. æ£€æŸ¥æ•°æ®åº“è¿ç§»çŠ¶æ€
python3 manage.py showmigrations

# 5. æµ‹è¯•æ•°æ®åº“æŸ¥è¯¢
python3 manage.py shell
>>> from songlist.models import YouyouSong
>>> YouyouSong.objects.count()
```

**å¸¸è§åŽç«¯é—®é¢˜**ï¼š

| é—®é¢˜ | åŽŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| æ•°æ®åº“è¿žæŽ¥å¤±è´¥ | SQLite æ–‡ä»¶æƒé™é—®é¢˜ | `chmod 644 /path/to/db.sqlite3` |
| ç¼ºå°‘æ•°æ®è¡¨ | æœªè¿è¡Œè¿ç§» | `python3 manage.py migrate` |
| CORS é”™è¯¯ | è·¨åŸŸè¯·æ±‚è¢«æ‹’ç» | æ£€æŸ¥ `CORS_ALLOWED_ORIGINS` é…ç½® |
| ç¼ºå°‘ä¾èµ– | åŒ…æœªå®‰è£… | `pip install -r requirements.txt` |

### é—®é¢˜ 4ï¼šNginx ä»£ç†é…ç½®é—®é¢˜

**ç—‡çŠ¶**ï¼šNginx è¿”å›ž 502 Bad Gateway

**æŽ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ proxy_pass åœ°å€æ˜¯å¦æ­£ç¡®
sudo nginx -T | grep proxy_pass

# 2. æµ‹è¯•åŽç«¯æ˜¯å¦å¯è®¿é—®
curl http://127.0.0.1:8000/api/songlist/songs/?artist=youyou

# 3. æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
sudo ufw allow 8000/tcp

# 4. æ£€æŸ¥ SELinuxï¼ˆå¦‚æžœå¯ç”¨ï¼‰
sudo getenforce
sudo setsebool -P httpd_can_network_connect 1
```

### é—®é¢˜ 5ï¼šé™æ€æ–‡ä»¶ 404

**ç—‡çŠ¶**ï¼šå‰ç«¯é¡µé¢å¯ä»¥è®¿é—®ï¼Œä½† CSS/JS æ–‡ä»¶è¿”å›ž 404

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# 1. æ£€æŸ¥ dist ç›®å½•æ˜¯å¦å­˜åœ¨
ls -la /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist/

# 2. æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ root è·¯å¾„
sudo nginx -T | grep "root.*dist"

# 3. æ£€æŸ¥æ–‡ä»¶æƒé™
sudo chmod -R 755 /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist
sudo chown -R www-data:www-data /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist

# 4. é‡æ–°æž„å»ºå‰ç«¯ï¼ˆå¦‚æžœéœ€è¦ï¼‰
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend
npm run build
```

---

## ðŸ› ï¸ å®Œæ•´ä¿®å¤æµç¨‹

### åœºæ™¯ 1ï¼šé¦–æ¬¡éƒ¨ç½²ï¼Œæœªé…ç½® SSL

```bash
# 1. ä¸´æ—¶ä½¿ç”¨ HTTPï¼ˆå–æ¶ˆ HTTPS é‡å®šå‘ï¼‰
sudo nano /etc/nginx/sites-enabled/leyou-songlist.conf
# ä¿®æ”¹ location / ä¸ºç›´æŽ¥è¿”å›žé™æ€æ–‡ä»¶

# 2. é‡è½½ Nginx
sudo nginx -s reload

# 3. æµ‹è¯• HTTP è®¿é—®
curl http://leyou.xxm8777.cn

# 4. ç”³è¯· SSL è¯ä¹¦
sudo certbot certonly --webroot \
  -w /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist \
  -d leyou.xxm8777.cn

# 5. å¯ç”¨ HTTPS é…ç½®
# å–æ¶ˆæ³¨é‡Š HTTPS server block

# 6. é‡è½½ Nginx
sudo nginx -s reload

# 7. æµ‹è¯• HTTPS è®¿é—®
curl https://leyou.xxm8777.cn
```

### åœºæ™¯ 2ï¼šAPI 500 é”™è¯¯

```bash
# 1. æŸ¥çœ‹åŽç«¯æ—¥å¿—
tail -100 /tmp/backend.log

# 2. æ£€æŸ¥æ•°æ®åº“
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
python3 manage.py check

# 3. è¿è¡Œè¿ç§»
python3 manage.py migrate

# 4. é‡å¯åŽç«¯æœåŠ¡
sudo systemctl restart django-backend
# æˆ–
pkill -f "gunicorn"
nohup gunicorn xxm_fans_home.wsgi:application \
  -c /home/yifeianyi/Desktop/xxm_fans_home/infra/gunicorn/gunicorn_config.py \
  > /tmp/backend.log 2>&1 &

# 5. æµ‹è¯• API
curl http://127.0.0.1:8000/api/songlist/songs/?artist=youyou
```

### åœºæ™¯ 3ï¼šæµè§ˆå™¨è¿”å›ž 400 Bad Request

```bash
# 1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# Ctrl+Shift+Delete

# 2. ä½¿ç”¨éšèº«æ¨¡å¼æµ‹è¯•
# æ‰“å¼€æµè§ˆå™¨éšèº«çª—å£è®¿é—®

# 3. æ£€æŸ¥ CORS é…ç½®
sudo nano /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/xxm_fans_home/settings.py
# ç¡®è®¤ CORS_ALLOWED_ORIGINS åŒ…å«ä½ çš„åŸŸå

# 4. æ£€æŸ¥è¯·æ±‚å¤´
# åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…· Network æ ‡ç­¾ä¸­æŸ¥çœ‹è¯·æ±‚è¯¦æƒ…

# 5. æµ‹è¯•ä¸åŒçš„è¯·æ±‚æ–¹å¼
curl -X GET "http://leyou.xxm8777.cn/api/songlist/songs/?artist=youyou" \
  -H "Content-Type: application/json"
```

---

## ðŸ“Š ç›‘æŽ§å’Œæ—¥å¿—

### å®žæ—¶ç›‘æŽ§è„šæœ¬

```bash
#!/bin/bash
# monitor.sh - å®žæ—¶ç›‘æŽ§è„šæœ¬

echo "=== Nginx é”™è¯¯æ—¥å¿— ==="
tail -f /var/log/nginx/error.log &

echo "=== åŽç«¯æ—¥å¿— ==="
tail -f /tmp/backend.log &

echo "=== ç³»ç»Ÿèµ„æº ==="
htop

# ä½¿ç”¨ Ctrl+C åœæ­¢
```

### æ—¥å¿—åˆ†æžå‘½ä»¤

```bash
# ç»Ÿè®¡é”™è¯¯ç±»åž‹
sudo grep -E " 400 | 500 " /var/log/nginx/access.log | awk '{print $9}' | sort | uniq -c

# æŸ¥æ‰¾æ…¢è¯·æ±‚
sudo awk '($NF > 1)' /var/log/nginx/access.log | sort -k9 -n -r | head -20

# æŸ¥çœ‹ç‰¹å®š IP çš„è¯·æ±‚
sudo grep "your-ip-address" /var/log/nginx/access.log | tail -20
```

---

## ðŸ” å®‰å…¨æ£€æŸ¥

```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
find /home/yifeianyi/Desktop/xxm_fans_home -type f -name "*.sqlite3" -exec ls -la {} \;

# æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
ls -la /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/.env

# æ£€æŸ¥ Nginx é…ç½®æƒé™
ls -la /etc/nginx/sites-enabled/

# æ£€æŸ¥ SSL è¯ä¹¦æœ‰æ•ˆæœŸ
sudo certbot certificates
```

---

## ðŸ“ž ç´§æ€¥æ¢å¤

### å¿«é€Ÿå›žæ»šåˆ° HTTP

```bash
# 1. å¤‡ä»½å½“å‰é…ç½®
sudo cp /etc/nginx/sites-enabled/leyou-songlist.conf /etc/nginx/sites-enabled/leyou-songlist.conf.backup

# 2. ä¿®æ”¹ä¸ºçº¯ HTTP æ¨¡å¼
sudo tee /etc/nginx/sites-enabled/leyou-songlist.conf > /dev/null <<'EOF'
server {
    listen 80;
    server_name leyou.xxm8777.cn;

    location / {
        root /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend/dist;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /media/ {
        alias /home/yifeianyi/Desktop/xxm_fans_home/media/;
        expires 30d;
    }
}
EOF

# 3. é‡è½½ Nginx
sudo nginx -t && sudo nginx -s reload
```

---

## ðŸ“ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# Nginx ç›¸å…³
sudo nginx -t                    # æµ‹è¯•é…ç½®
sudo nginx -s reload             # é‡è½½é…ç½®
sudo systemctl restart nginx     # é‡å¯ Nginx
sudo nginx -T                    # æŸ¥çœ‹å®Œæ•´é…ç½®

# åŽç«¯ç›¸å…³
ps aux | grep gunicorn           # æŸ¥çœ‹è¿›ç¨‹
sudo systemctl restart django-backend  # é‡å¯æœåŠ¡ï¼ˆsystemdï¼‰
python3 manage.py runserver      # å¼€å‘æœåŠ¡å™¨
python3 manage.py migrate        # è¿è¡Œè¿ç§»

# æ—¥å¿—ç›¸å…³
sudo tail -f /var/log/nginx/error.log    # Nginx é”™è¯¯æ—¥å¿—
tail -f /tmp/backend.log                 # åŽç«¯æ—¥å¿—
journalctl -u django-backend -f          # systemd æ—¥å¿—

# SSL è¯ä¹¦ç›¸å…³
sudo certbot certificates         # æŸ¥çœ‹è¯ä¹¦
sudo certbot renew --dry-run      # æµ‹è¯•ç»­æœŸ
sudo certbot renew                # ç»­æœŸè¯ä¹¦

# ç½‘ç»œç›¸å…³
curl -I http://127.0.0.1:8000    # æµ‹è¯•åŽç«¯
netstat -tlnp | grep :8000        # æŸ¥çœ‹ç«¯å£
sudo ufw status                   # æŸ¥çœ‹é˜²ç«å¢™
```

---

## ðŸŽ¯ æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰æ£€æŸ¥ï¼š
- [ ] SSL è¯ä¹¦å·²ç”³è¯·
- [ ] Nginx é…ç½®å·²å–æ¶ˆæ³¨é‡Š HTTPS block
- [ ] å‰ç«¯å·²æž„å»ºï¼ˆ`npm run build`ï¼‰
- [ ] åŽç«¯è¿ç§»å·²è¿è¡Œï¼ˆ`python3 manage.py migrate`ï¼‰
- [ ] æ•°æ®åº“æ–‡ä»¶æƒé™æ­£ç¡®
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [ ] CORS é…ç½®æ­£ç¡®

éƒ¨ç½²åŽéªŒè¯ï¼š
- [ ] HTTP è®¿é—®æ­£å¸¸
- [ ] HTTPS è®¿é—®æ­£å¸¸
- [ ] API è¯·æ±‚æˆåŠŸ
- [ ] é™æ€æ–‡ä»¶åŠ è½½æ­£å¸¸
- [ ] åª’ä½“æ–‡ä»¶å¯è®¿é—®
- [ ] æµè§ˆå™¨æŽ§åˆ¶å°æ— é”™è¯¯

---

## ðŸ“ž æ”¯æŒä¿¡æ¯

å¦‚æžœä»¥ä¸Šæ–¹æ¡ˆæ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. Nginx é”™è¯¯æ—¥å¿—ï¼ˆæœ€è¿‘çš„ 50 è¡Œï¼‰
2. åŽç«¯æ—¥å¿—ï¼ˆæœ€è¿‘çš„ 50 è¡Œï¼‰
3. Nginx é…ç½®æ–‡ä»¶å†…å®¹
4. æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­çš„é”™è¯¯ä¿¡æ¯
5. å…·ä½“çš„ API è¯·æ±‚ URL å’Œå“åº”å†…å®¹

```bash
# æ”¶é›†è¯Šæ–­ä¿¡æ¯
bash -c 'echo "=== Nginx ç‰ˆæœ¬ ===" && nginx -v && \
echo "=== Nginx é”™è¯¯æ—¥å¿— ===" && tail -30 /var/log/nginx/error.log && \
echo "=== åŽç«¯æ—¥å¿— ===" && tail -30 /tmp/backend.log && \
echo "=== è¿›ç¨‹çŠ¶æ€ ===" && ps aux | grep -E "nginx|gunicorn" && \
echo "=== ç«¯å£ç›‘å¬ ===" && netstat -tlnp | grep -E "80|443|8000"' > /tmp/diagnosis.txt
```