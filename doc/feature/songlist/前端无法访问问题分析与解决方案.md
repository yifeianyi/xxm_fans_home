# 模板化歌单前端无法访问问题分析与解决方案

## 问题描述

在使用 `scripts/dev_start_services.sh` 启动服务后，模板化歌单前端无法通过 Nginx 代理访问。

访问地址：
- `http://localhost:8080/songlist/` - 无法访问
- `http://localhost:5174/` - 可以直接访问

## 问题分析

### 核心问题：端口配置不匹配

#### 1. Nginx 配置错误

**文件位置**: `infra/nginx/xxm_nginx.conf`

**当前配置**:
```nginx
location /songlist/ {
    proxy_pass http://127.0.0.1:3001/songlist/;
    proxy_http_version 1.1;

    # HMR 必须
    proxy_set_header Host $host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

**问题**: 配置指向端口 `3001`，但实际运行的是端口 `5174`

#### 2. 启动脚本配置

**文件位置**: `scripts/dev_start_services.sh`

**当前配置**:
```bash
echo "2.5. 启动模板化歌单前端服务..."
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/Temp_frontend
if check_running "vite.*5174"; then
    echo "   模板化歌单前端已在运行"
else
    nohup npm run dev -- --port 5174 > /tmp/songlist_frontend.log 2>&1 &
    echo "   模板化歌单前端启动成功 (端口 5174)"
fi
```

**实际端口**: `5174`

#### 3. Vite 配置

**文件位置**: `repo/Temp_frontend/vite.config.js`

**当前配置**:
```javascript
server: {
  port: 5174,
  host: '0.0.0.0',
  proxy: {
    '/api': {
      target: 'http://127.0.0.1:8000',
      changeOrigin: true,
      secure: false,
    },
    '/media': {
      target: 'http://127.0.0.1:8000',
      changeOrigin: true,
      secure: false,
    },
    '/photos': {
      target: 'http://127.0.0.1:8000',
      changeOrigin: true,
      secure: false,
    },
  }
}
```

**配置端口**: `5174`

### 问题总结

| 配置文件 | 端口 | 状态 |
|---------|------|------|
| Nginx 配置 | 3001 | ❌ 错误 |
| 启动脚本 | 5174 | ✅ 正确 |
| Vite 配置 | 5174 | ✅ 正确 |

## 解决方案

### 方案一：修改 Nginx 配置（推荐）

**修改文件**: `infra/nginx/xxm_nginx.conf`

**修改内容**:
```nginx
# 修改前
location /songlist/ {
    proxy_pass http://127.0.0.1:3001/songlist/;
    ...
}

# 修改后
location /songlist/ {
    proxy_pass http://127.0.0.1:5174/;
    proxy_http_version 1.1;

    # HMR 必须
    proxy_set_header Host $host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

**注意**: `proxy_pass` 的路径从 `/songlist/` 改为 `/`，因为 Vite 开发服务器在根路径提供服务。

### 方案二：统一端口配置（备用）

如果需要使用端口 3001，需要同时修改以下文件：

1. **启动脚本**: `scripts/dev_start_services.sh`
   ```bash
   nohup npm run dev -- --port 3001 > /tmp/songlist_frontend.log 2>&1 &
   ```

2. **Vite 配置**: `repo/Temp_frontend/vite.config.js`
   ```javascript
   server: {
     port: 3001,
     ...
   }
   ```

## 后端 API 配置验证

### 后端路由配置

**文件**: `repo/xxm_fans_backend/xxm_fans_home/urls.py`

```python
# songlist 独立路由
path('api/songlist/', include('songlist.urls')),
```

### 前端 API 调用

**文件**: `repo/Temp_frontend/src/App.vue`

```javascript
const apiBasePath = computed(() => `/api/songlist`)

// 示例调用
fetch(`${apiBasePath.value}/songs/?artist=${currentArtist.value}`)
```

**状态**: ✅ 正确

## 前端图片路径配置

### 后端图片存储配置

**文件**: `repo/xxm_fans_backend/songlist/models.py`

```python
photo = models.ImageField(
    upload_to=f'songlist/{artist_key}/',
    verbose_name='图片',
    blank=True,
    null=True
)
```

**说明**:
- 图片上传路径: `media/songlist/{artist_key}/{filename}`
- 例如: `media/songlist/youyou/avatar.jpg`

### Nginx 静态文件配置

**文件**: `infra/nginx/xxm_nginx.conf`

```nginx
# 3️⃣ 媒体文件（图片等）- 直接由Nginx提供
location /media/ {
    alias /home/yifeianyi/Desktop/xxm_fans_home/media/;
    expires 30d;
    add_header Cache-Control "public, immutable";

    # 安全头
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
}
```

**说明**: 所有媒体文件（包括 songlist 图片）统一通过 `/media/` 路径访问

### 前端图片调用

**文件**: `repo/Temp_frontend/src/App.vue`

```javascript
const imagePath = `/media/songlist/${currentArtist.value}/${setting.photo_url}`
if (setting.position === 1) {
    // 头像图标
    headIconUrl.value = imagePath
} else if (setting.position === 2) {
    // 背景图片
    backgroundUrl.value = imagePath
}
```

**状态**: ✅ 正确

### Django 路由配置

**文件**: `repo/xxm_fans_backend/xxm_fans_home/urls.py`

```python
# 在开发环境中提供媒体文件服务
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

**说明**: Django 在开发环境自动处理 `/media/` 路径的文件服务

## 前端环境变量配置

### .env 文件配置

**文件**: `repo/Temp_frontend/.env`

```env
# 本地开发环境
localhost=youyou
127_0_0_1=youyou

# 默认歌手
DEFAULT_ARTIST=youyou
```

### 域名映射逻辑

**文件**: `repo/Temp_frontend/src/App.vue`

```javascript
const getArtistFromDomain = () => {
  const hostname = window.location.hostname
  const port = window.location.port
  const fullHostname = port ? `${hostname}:${port}` : hostname

  // 从环境变量中获取映射
  const domainMappings = import.meta.env.VITE_DOMAIN_MAPPINGS
    ? JSON.parse(import.meta.env.VITE_DOMAIN_MAPPINGS)
    : {}

  // 检查 URL 参数中的 artist
  const urlParams = new URLSearchParams(window.location.search)
  const artistFromUrl = urlParams.get('artist')
  if (artistFromUrl) {
    return artistFromUrl
  }

  // 使用默认值
  return import.meta.env.VITE_DEFAULT_ARTIST || 'youyou'
}
```

**状态**: ✅ 正确

### 资源路径说明

**图片资源路径**:
- 后端存储: `media/songlist/{artist_key}/{filename}`
- 前端访问: `/media/songlist/{artist_key}/{filename}`
- 代理配置: Vite 代理 `/media/` 到 Django 后端

**示例**:
- 歌手: `youyou`
- 文件名: `avatar.jpg`
- 存储路径: `media/songlist/youyou/avatar.jpg`
- 访问路径: `/media/songlist/youyou/avatar.jpg`

## 完整解决方案实施步骤

### 步骤 1：修改 Nginx 配置

```bash
# 编辑 Nginx 配置文件
nano infra/nginx/xxm_nginx.conf
```

**修改内容**:

1. 修改 `location /songlist/` 部分：
```nginx
# 1.5️⃣ 模板化歌单前端（Vite）
location /songlist/ {
    proxy_pass http://127.0.0.1:5174/;
    proxy_http_version 1.1;

    # HMR 必须
    proxy_set_header Host $host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

2. 确认 `/media/` location 配置存在且正确：
```nginx
# 3️⃣ 媒体文件（图片等）- 直接由Nginx提供
location /media/ {
    alias /home/yifeianyi/Desktop/xxm_fans_home/media/;
    expires 30d;
    add_header Cache-Control "public, immutable";

    # 安全头
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
}
```

3. 确认没有 `/photos/` 相关的 location 块（如有则删除）

### 步骤 2：修改前端代码

**文件**: `repo/Temp_frontend/src/App.vue`

修改 `fetchSiteSettings` 函数中的图片路径：

```javascript
// 根据position设置headIcon和background
// 图片存储路径: media/songlist/{artist_key}/{filename}
data.forEach(setting => {
  if (setting.photo_url) {
    const imagePath = `/media/songlist/${currentArtist.value}/${setting.photo_url}`
    if (setting.position === 1) {
      // 头像图标
      headIconUrl.value = imagePath
    } else if (setting.position === 2) {
      // 背景图片
      backgroundUrl.value = imagePath
    }
  }
})
```

### 步骤 3：修改 Vite 配置

**文件**: `repo/Temp_frontend/vite.config.js`

移除 `/photos/` 代理配置：

```javascript
server: {
  port: 5174,
  host: '0.0.0.0',
  proxy: {
    // 代理 /api 请求到后端
    '/api': {
      target: 'http://127.0.0.1:8000',
      changeOrigin: true,
      secure: false,
    },
    // 代理 /media 请求到后端（包括 songlist 的图片资源）
    '/media': {
      target: 'http://127.0.0.1:8000',
      changeOrigin: true,
      secure: false,
    },
  }
}
```

### 步骤 4：修改 Django 路由

**文件**: `repo/xxm_fans_backend/xxm_fans_home/urls.py`

移除所有 `/photos/` 相关的路由：

```python
urlpatterns = [
    # ... 其他路由 ...

    # 新增：songlist独立路由
    path('api/songlist/', include('songlist.urls')),
    path('admin/', admin.site.urls),

    # 注意：songlist 图片资源统一使用 /media/ 路径，由 Django upload_to 配置管理
    # 图片存储路径：media/songlist/{artist_key}/{filename}
    # 访问路径：/media/songlist/{artist_key}/{filename}
    # 已由 static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT) 统一处理
]

# 在开发环境中提供媒体文件服务
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

### 步骤 2：重启服务

```bash
# 停止当前服务
./scripts/dev_stop_services.sh

# 重新启动服务
./scripts/dev_start_services.sh
```

### 步骤 3：验证访问

在浏览器中访问以下地址：

1. **通过 Nginx 代理访问**:
   - `http://localhost:8080/songlist/` - 默认歌手
   - `http://localhost:8080/songlist/?artist=youyou` - 乐游
   - `http://localhost:8080/songlist/?artist=bingjie` - 冰洁

2. **直接访问前端服务**:
   - `http://localhost:5174/` - 默认歌手
   - `http://localhost:5174/?artist=youyou` - 乐游
   - `http://localhost:5174/?artist=bingjie` - 冰洁

3. **后端 API 测试**:
   - `http://localhost:8080/api/songlist/songs/?artist=youyou`
   - `http://localhost:8080/api/songlist/languages/?artist=youyou`
   - `http://localhost:8080/api/songlist/styles/?artist=youyou`
   - `http://localhost:8080/api/songlist/site-settings/?artist=youyou`

### 步骤 4：检查日志

如果问题仍然存在，检查以下日志：

```bash
# 检查歌单前端日志
cat /tmp/songlist_frontend.log

# 检查 Nginx 错误日志
cat /tmp/nginx/error.log

# 检查 Nginx 访问日志
cat /tmp/nginx/access.log

# 检查后端日志
tail -f /tmp/backend.log
```

## 常见问题排查

### 问题 1：访问 http://localhost:8080/songlist/ 显示 404

**原因**: Nginx 配置的端口错误

**解决方案**: 按照上述步骤 1 修改 Nginx 配置

### 问题 2：访问 http://localhost:8080/songlist/ 显示 502 Bad Gateway

**原因**: 前端服务未启动

**解决方案**:
```bash
# 检查进程是否运行
ps aux | grep vite

# 如果未运行，手动启动
cd repo/Temp_frontend
npm run dev -- --port 5174
```

### 问题 3：API 请求失败

**原因**: 后端服务未启动或 CORS 配置问题

**解决方案**:
```bash
# 检查后端服务
ps aux | grep manage.py

# 检查后端日志
tail -f /tmp/backend.log

# 检查 Django CORS 配置
# 确认 settings.py 中配置了 corsheaders
```

### 问题 4：图片加载失败

**原因**:
1. 图片文件不存在
2. Django 的照片 URL 字段配置错误
3. 前端路径构建错误

**解决方案**:
1. **检查图片文件**:
   ```bash
   # 检查 media 目录
   ls -la media/songlist/{artist_key}/
   ```

2. **检查 Django 管理后台**:
   - 登录 Django Admin
   - 进入 songlist 应用
   - 检查 SiteSetting 中的 photo_url 字段

3. **检查前端路径构建**:
   - 确认使用 `/media/songlist/${currentArtist.value}/${setting.photo_url}`
   - 确认 `currentArtist.value` 和 `setting.photo_url` 有值

4. **检查浏览器控制台**:
   - 打开开发者工具
   - 查看 Network 面板
   - 确认图片请求路径是否正确
   - 查看请求状态码（404 表示文件不存在）

## 生产环境部署建议

### 1. 使用生产构建

```bash
cd repo/Temp_frontend
npm run build
```

### 2. 配置 Nginx 提供静态文件

```nginx
# 生产环境配置
location /songlist/ {
    alias /path/to/Temp_frontend/dist/;
    try_files $uri $uri/ /songlist/index.html;
}
```

### 3. 配置多个域名

```nginx
# 乐游域名
server {
    listen 80;
    server_name youyou.example.com;

    location / {
        proxy_pass http://127.0.0.1:5174/;
        ...
    }
}

# 冰洁域名
server {
    listen 80;
    server_name bingjie.example.com;

    location / {
        proxy_pass http://127.0.0.1:5174/;
        ...
    }
}
```

## 总结

### 核心问题

1. **端口配置不匹配**: Nginx 配置的端口（3001）与实际运行的端口（5174）不匹配
2. **资源路径不统一**: 之前使用 `/photos/` 路径，现在统一使用 `/media/` 路径

### 推荐解决方案

1. **修改 Nginx 配置** (`infra/nginx/xxm_nginx.conf`)
   - 将 `location /songlist/` 中的 `proxy_pass` 端口从 `3001` 改为 `5174`
   - 将路径从 `/songlist/` 改为 `/`
   - 移除所有 `/photos/` 相关的 location 块

2. **修改前端代码** (`repo/Temp_frontend/src/App.vue`)
   - 图片路径从 `/photos/${setting.photo_url}` 改为 `/media/songlist/${currentArtist.value}/${setting.photo_url}`

3. **修改 Vite 配置** (`repo/Temp_frontend/vite.config.js`)
   - 移除 `/photos/` 代理配置
   - 保留 `/media/` 代理配置

4. **修改 Django 路由** (`repo/xxm_fans_backend/xxm_fans_home/urls.py`)
   - 移除所有 `/photos/` 相关的路由
   - 依赖 Django 的 `static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)` 统一处理

### 资源路径说明

**后端图片存储**:
- 配置: `upload_to=f'songlist/{artist_key}/'`
- 实际路径: `media/songlist/{artist_key}/{filename}`
- 例如: `media/songlist/youyou/avatar.jpg`

**前端访问路径**:
- 访问路径: `/media/songlist/{artist_key}/{filename}`
- 例如: `/media/songlist/youyou/avatar.jpg`

**优势**:
- 统一管理所有媒体文件
- 无需额外的 Nginx location 配置
- Django 自动处理开发环境的文件服务
- Nginx 统一处理生产环境的文件服务

### 验证步骤

1. 修改 Nginx 配置
2. 重启服务
3. 访问 `http://localhost:8080/songlist/` 验证
4. 检查日志确认无错误

### 后续优化

1. 添加生产环境构建配置
2. 配置多个歌手域名
3. 添加 HTTPS 支持
4. 优化缓存策略

## 附录：相关文件清单

| 文件路径 | 作用 | 需要修改 | 修改内容 |
|---------|------|---------|---------|
| `infra/nginx/xxm_nginx.conf` | Nginx 配置 | ✅ 是 | 修改端口、移除 /photos/ 配置 |
| `scripts/dev_start_services.sh` | 启动脚本 | ✅ 是 | 更新访问地址说明 |
| `repo/Temp_frontend/vite.config.js` | Vite 配置 | ✅ 是 | 移除 /photos/ 代理 |
| `repo/Temp_frontend/src/App.vue` | 前端应用 | ✅ 是 | 修改图片路径 |
| `repo/xxm_fans_backend/xxm_fans_home/urls.py` | Django 路由 | ✅ 是 | 移除 /photos/ 路由 |
| `repo/xxm_fans_backend/songlist/models.py` | songlist 模型 | ❌ 否 | 已正确配置 upload_to |
| `repo/xxm_fans_backend/songlist/urls.py` | songlist 路由 | ❌ 否 | 无需修改 |
| `repo/xxm_fans_backend/songlist/views.py` | songlist 视图 | ❌ 否 | 无需修改 |
| `repo/Temp_frontend/.env` | 环境变量 | ❌ 否 | 无需修改 |