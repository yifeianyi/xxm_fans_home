# 悠悠歌单问题排查方案

## 一、问题描述

在使用 `scripts/dev_start_services.sh` 启动服务后，通过 `http://localhost:8080/songlist/` 访问悠悠歌单前端时出现问题。

## 二、问题根源分析

### 1. 目录名不匹配

**启动脚本中的路径**：
```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/Temp_frontend
```

**实际目录名**：
```bash
/home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend
```

### 2. 端口冲突

由于目录路径错误，启动脚本无法正确启动歌单前端，导致：

| 端口 | 进程 | 状态 |
|------|------|------|
| 5173 | 主前端（xxm_fans_frontend） | ✅ 正常 |
| 5174 | 主前端重复实例 | ❌ 冲突（应该是歌单前端）|
| 5175 | 主前端重复实例 | ⚠️ 多余 |
| 5176 | 主前端重复实例 | ⚠️ 多余 |
| 5177 | 主前端重复实例 | ⚠️ 多余 |
| 5178 | 主前端重复实例 | ⚠️ 多余 |
| 5179 | 歌单前端（实际运行） | ✅ 正确但端口错误 |

### 3. Nginx 配置错误

原 Nginx 配置指向端口 5174，但该端口被主前端占用，导致：
- 访问 `http://localhost:8080/songlist/` 返回主前端页面
- 而不是悠悠歌单前端页面

## 三、快速诊断命令

```bash
# 1. 检查服务运行状态
ps aux | grep vite | grep -v grep

# 2. 检查端口占用
netstat -tlnp | grep -E "5173|5174|5179|8080"

# 3. 测试访问
curl -I http://localhost:8080/songlist/
curl -I http://localhost:5174/
curl -I http://localhost:5179/

# 4. 查看日志
tail -30 /tmp/songlist_frontend.log
tail -30 /tmp/nginx/error.log

# 5. 检查目录结构
ls -la /home/yifeianyi/Desktop/xxm_fans_home/repo/
```

## 四、问题诊断流程

### 步骤 1：确认目录结构

```bash
ls -la /home/yifeianyi/Desktop/xxm_fans_home/repo/
```

**预期输出**：
```
TempSongListFrontend/  ← 正确的目录名
xxm_fans_backend/
xxm_fans_frontend/
```

### 步骤 2：检查启动脚本

```bash
grep "Temp" /home/yifeianyi/Desktop/xxm_fans_home/scripts/dev_start_services.sh
```

**问题输出**：
```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/Temp_frontend  # ← 路径错误
```

### 步骤 3：检查端口冲突

```bash
lsof -i :5174
ps aux | grep 5174
```

**问题现象**：端口 5174 被主前端占用，而不是歌单前端

### 步骤 4：检查 Nginx 配置

```bash
grep -A 10 "location /songlist/" /home/yifeianyi/Desktop/xxm_fans_home/infra/nginx/xxm_nginx.conf
```

**预期配置**：
```nginx
location /songlist/ {
    proxy_pass http://127.0.0.1:5174/;
    ...
}
```

### 步骤 5：验证访问结果

```bash
curl -s http://localhost:8080/songlist/ | grep "<title>"
```

**问题输出**：
```html
<title>小满虫之家 - 咻咻满粉丝站</title>  ← 主前端页面
```

**预期输出**：
```html
<title>悠悠歌单</title>  ← 歌单前端页面
```

## 五、解决方案

### 方案 A：修复启动脚本（推荐）

**步骤 1：停止所有服务**
```bash
cd /home/yifeianyi/Desktop/xxm_fans_home
./scripts/dev_stop_services.sh
```

**步骤 2：清理所有 Vite 进程**
```bash
pkill -f "vite"
pkill -f "node.*vite"
```

**步骤 3：修复启动脚本路径**

编辑 `/home/yifeianyi/Desktop/xxm_fans_home/scripts/dev_start_services.sh`：

```bash
# 修改前
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/Temp_frontend

# 修改后
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend
```

**步骤 4：重新启动服务**
```bash
./scripts/dev_start_services.sh
```

**步骤 5：验证访问**
```bash
curl -I http://localhost:8080/songlist/
```

**预期输出**：
```
HTTP/1.1 200 OK
```

**步骤 6：在浏览器中测试**
- 访问：http://localhost:8080/songlist/
- 应该显示悠悠歌单页面
- 访问：http://localhost:8080/songlist/?artist=youyou
- 应该显示乐游的歌单

### 方案 B：手动启动（临时方案）

如果不想修改脚本，可以手动启动歌单前端：

```bash
# 1. 进入正确的目录
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/TempSongListFrontend

# 2. 启动服务（指定端口 5174）
npm run dev -- --port 5174

# 3. 验证访问
curl -I http://localhost:8080/songlist/
```

### 方案 C：修改 Nginx 配置指向 5179（不推荐）

如果不想清理进程，可以临时修改 Nginx 配置：

**步骤 1：修改 Nginx 配置**

编辑 `/home/yifeianyi/Desktop/xxm_fans_home/infra/nginx/xxm_nginx.conf`：

```nginx
# 修改前
location /songlist/ {
    proxy_pass http://127.0.0.1:5174/;
    proxy_set_header Host 127.0.0.1:5174;
    ...
}

# 修改后
location /songlist/ {
    proxy_pass http://127.0.0.1:5179/;
    proxy_set_header Host 127.0.0.1:5179;
    ...
}
```

**步骤 2：重载 Nginx**
```bash
nginx -c /home/yifeianyi/Desktop/xxm_fans_home/infra/nginx/xxm_nginx.conf -p /tmp/nginx -s reload
```

**步骤 3：验证访问**
```bash
curl -I http://localhost:8080/songlist/
```

**注意**：这只是临时方案，建议使用方案 A 修复根本问题。

## 六、预防措施

### 1. 统一目录命名

确保启动脚本中的路径与实际目录名一致：
- 启动脚本：`repo/TempSongListFrontend`
- 实际目录：`repo/TempSongListFrontend`

### 2. 清理重复进程

避免启动多个相同服务的实例：
```bash
# 启动前检查
ps aux | grep "vite.*5174"

# 如果已存在，先清理
pkill -f "vite.*5174"
```

### 3. 端口管理

为每个服务分配固定的端口，避免冲突：

| 服务 | 端口 | 说明 |
|------|------|------|
| Django 后端 | 8000 | Python 后端服务 |
| 主前端 | 5173 | xxm_fans_frontend |
| 歌单前端 | 5174 | TempSongListFrontend |
| Nginx 代理 | 8080 | 入口端口 |

### 4. 日志监控

定期检查日志文件，及时发现异常：
```bash
# 查看歌单前端日志
tail -f /tmp/songlist_frontend.log

# 查看 Nginx 错误日志
tail -f /tmp/nginx/error.log
```

### 5. 健康检查

定期执行健康检查命令：
```bash
# 检查所有服务状态
./scripts/test_integration.sh

# 手动检查
curl -I http://localhost:8080/
curl -I http://localhost:8080/songlist/
curl -I http://localhost:8080/api/
```

## 七、常见问题排查

### Q1: 访问返回 404 Not Found

**原因**：
- Nginx 配置的代理端口不正确
- 目标服务未启动
- 目标服务端口配置错误

**排查步骤**：
```bash
# 1. 检查 Nginx 配置
grep -A 5 "location /songlist/" infra/nginx/xxm_nginx.conf

# 2. 检查目标服务是否运行
ps aux | grep "vite.*5174"

# 3. 检查端口监听
netstat -tlnp | grep 5174

# 4. 查看错误日志
tail -20 /tmp/nginx/error.log
```

### Q2: 访问返回 502 Bad Gateway

**原因**：
- 后端服务未启动
- 后端服务崩溃
- 端口配置错误

**排查步骤**：
```bash
# 1. 检查后端服务
ps aux | grep "manage.py runserver"

# 2. 检查后端日志
tail -20 /tmp/backend.log

# 3. 测试后端直接访问
curl -I http://localhost:8000/
```

### Q3: 前端页面显示错误或白屏

**原因**：
- JavaScript 错误
- 资源加载失败
- API 请求失败

**排查步骤**：
```bash
# 1. 打开浏览器开发者工具（F12）
# 2. 查看 Console 标签页的错误信息
# 3. 查看 Network 标签页的资源加载状态
# 4. 检查 API 请求是否成功

# 5. 查看前端日志
tail -20 /tmp/frontend.log
tail -20 /tmp/songlist_frontend.log
```

### Q4: API 请求失败（CORS 错误）

**原因**：
- 后端 CORS 配置问题
- 代理配置错误

**排查步骤**：
```bash
# 1. 检查后端 CORS 配置
grep -A 5 "CORS" repo/xxm_fans_backend/xxm_fans_home/settings.py

# 2. 检查 Nginx 代理配置
grep -A 10 "location /api/" infra/nginx/xxm_nginx.conf

# 3. 测试 API 直接访问
curl http://localhost:8000/api/songs/

# 4. 测试通过 Nginx 访问
curl http://localhost:8080/api/songs/
```

### Q5: 图片资源加载失败

**原因**：
- 图片文件不存在
- 路径配置错误
- Nginx 静态文件配置错误

**排查步骤**：
```bash
# 1. 检查图片文件是否存在
ls -la media/songlist/youyou/

# 2. 检查 Nginx 静态文件配置
grep -A 5 "location /media/" infra/nginx/xxm_nginx.conf

# 3. 测试图片直接访问
curl -I http://localhost:8080/media/songlist/youyou/avatar.jpg

# 4. 查看浏览器 Network 面板
# 确认图片请求路径和状态码
```

### Q6: 端口被占用

**原因**：
- 重复启动服务
- 其他进程占用端口

**排查步骤**：
```bash
# 1. 查找占用端口的进程
lsof -i :5174
netstat -tlnp | grep 5174

# 2. 查看进程详情
ps aux | grep <PID>

# 3. 杀死进程
kill <PID>
# 或
kill -9 <PID>

# 4. 重新启动服务
./scripts/dev_start_services.sh
```

## 八、相关文件清单

| 文件路径 | 作用 | 需要修改 |
|---------|------|---------|
| `scripts/dev_start_services.sh` | 开发环境启动脚本 | ✅ 是（路径错误）|
| `scripts/dev_stop_services.sh` | 开发环境停止脚本 | ❌ 否 |
| `infra/nginx/xxm_nginx.conf` | Nginx 配置 | ⚠️ 可选（临时方案）|
| `repo/TempSongListFrontend/` | 歌单前端目录 | ❌ 否 |
| `repo/xxm_fans_frontend/` | 主前端目录 | ❌ 否 |
| `repo/xxm_fans_backend/` | 后端目录 | ❌ 否 |
| `/tmp/songlist_frontend.log` | 歌单前端日志 | ❌ 否 |
| `/tmp/frontend.log` | 主前端日志 | ❌ 否 |
| `/tmp/backend.log` | 后端日志 | ❌ 否 |
| `/tmp/nginx/error.log` | Nginx 错误日志 | ❌ 否 |
| `/tmp/nginx/access.log` | Nginx 访问日志 | ❌ 否 |

## 九、验证清单

修复完成后，使用以下清单验证系统是否正常：

### 1. 服务运行检查

- [ ] Django 后端运行在端口 8000
- [ ] 主前端运行在端口 5173
- [ ] 歌单前端运行在端口 5174
- [ ] Nginx 运行在端口 8080

### 2. 端口检查

```bash
netstat -tlnp | grep -E "8000|5173|5174|8080"
```

### 3. 页面访问检查

- [ ] http://localhost:8080/ - 主前端正常
- [ ] http://localhost:8080/songlist/ - 歌单前端正常
- [ ] http://localhost:8080/songlist/?artist=youyou - 乐游歌单正常
- [ ] http://localhost:8080/admin/ - Django Admin 正常

### 4. API 检查

- [ ] http://localhost:8080/api/songs/ - 歌曲列表 API 正常
- [ ] http://localhost:8080/api/songlist/songs/?artist=youyou - 歌单 API 正常
- [ ] http://localhost:8080/api/site-settings/settings/ - 网站设置 API 正常

### 5. 静态资源检查

- [ ] http://localhost:8080/media/songlist/youyou/ - 歌单图片可访问
- [ ] http://localhost:8080/covers/ - 封面图片可访问
- [ ] http://localhost:8080/static/ - 静态文件可访问

### 6. 日志检查

- [ ] `/tmp/backend.log` 无严重错误
- [ ] `/tmp/frontend.log` 无严重错误
- [ ] `/tmp/songlist_frontend.log` 无严重错误
- [ ] `/tmp/nginx/error.log` 无严重错误

## 十、总结

### 核心问题

**启动脚本路径错误**：
- 错误路径：`repo/Temp_frontend`
- 正确路径：`repo/TempSongListFrontend`

### 推荐解决方案

**使用方案 A：修复启动脚本**

1. 停止所有服务
2. 清理残留进程
3. 修复启动脚本路径
4. 重新启动服务
5. 验证访问

### 预期结果

修复后：
- ✅ 访问 `http://localhost:8080/songlist/` 正常显示悠悠歌单
- ✅ 访问 `http://localhost:8080/songlist/?artist=youyou` 正常显示乐游歌单
- ✅ 所有 API 请求正常
- ✅ 图片资源正常加载
- ✅ 无日志错误

### 注意事项

1. **避免重复启动**：启动前先检查服务是否已运行
2. **定期清理进程**：避免多个相同服务实例同时运行
3. **统一路径管理**：确保脚本中的路径与实际目录一致
4. **定期检查日志**：及时发现和处理异常
5. **使用健康检查**：定期验证服务状态

---

**文档版本**: 1.0
**创建日期**: 2026-01-27
**维护者**: XXM Fans Home Team
**相关文档**:
- `doc/songlist/youyou-songlist-cloud-deployment-guide.md` - 云端部署指南
- `doc/songlist/前端无法访问问题分析与解决方案.md` - 问题分析文档
- `infra/nginx/xxm_nginx.conf` - Nginx 配置文件
- `scripts/README.md` - 脚本说明文档