# 直播日历功能实现方案

## 1. 功能概述

直播日历页面是一个展示直播记录的日历视图，用户可以按日期浏览直播信息，包括：
- 日历网格视图展示有直播记录的日期
- 每场直播的详细信息（标题、时长、观看人数等）
- 完整回放录像（支持多分段）
- 当日歌切列表（复用演唱记录）
- 直播截图（复用 `media/gallery/LiveMoment` 图集数据）
- 弹幕热语分析

## 2. 现有数据资源分析

### 2.1 演唱记录数据 (SongRecord)
**模型路径**: `repo/xxm_fans_backend/song_management/models/song.py`

```python
class SongRecord(models.Model):
    song = models.ForeignKey(Song, on_delete=models.CASCADE, related_name='records')
    performed_at = models.DateField(verbose_name='演唱时间')
    url = models.URLField(blank=True, null=True, verbose_name='视频链接')
    notes = models.TextField(blank=True, null=True, verbose_name='备注')
    cover_url = models.CharField(max_length=300, blank=True, null=True, verbose_name='封面URL')
```

**复用方式**:
- 将同一日期的所有 `SongRecord` 聚合为该日直播的歌切列表
- 通过 `performed_at` 字段与直播日期关联
- `url` 字段作为歌切的视频链接
- `song.song_name` 作为歌切名称

### 2.2 直播截图数据 (Gallery)
**模型路径**: `repo/xxm_fans_backend/gallery/models.py`

```python
class Gallery(models.Model):
    id = models.CharField(primary_key=True, max_length=50)
    title = models.CharField(max_length=200, verbose_name='标题')
    folder_path = models.CharField(max_length=500, verbose_name='文件夹路径')
    cover_url = models.CharField(max_length=500, verbose_name='封面图片URL')
    image_count = models.IntegerField(default=0, verbose_name='图片数量')
    parent = models.ForeignKey('self', null=True, blank=True, on_delete=models.CASCADE)
    level = models.IntegerField(default=0, verbose_name='层级')
```

**复用方式**:
- 使用 `media/gallery/LiveMoment` 下的图集
- 通过图集标题或文件夹路径中的日期信息与直播日期关联
- 图集下的图片作为该日直播的截图
- 图集的 `cover_url` 作为该日直播的封面

## 3. 数据映射方案

### 3.1 直播数据模型设计

由于项目未定义独立的直播模型，我们需要在现有数据基础上构建虚拟的直播记录：

```python
# 虚拟直播记录结构（运行时构建）
Livestream {
  id: str,                          # 日期字符串 (YYYY-MM-DD)
  date: str,                        # 日期 (YYYY-MM-DD)
  title: str,                       # 直播标题（从图集标题或生成）
  summary: str,                     # 直播简介（从图集描述或生成）
  coverUrl: str,                    # 封面图（从图集 cover_url）
  viewCount: str,                   # 观看人数（预留字段）
  danmakuCount: str,                # 弹幕数（预留字段）
  startTime: str,                   # 开播时间（预留字段）
  endTime: str,                     # 下播时间（预留字段）
  duration: str,                    # 直播时长（预留字段）
  recordings: LivestreamRecording[], # 完整回放录像（预留字段）
  songCuts: SongCut[],              # 歌切列表（从 SongRecord 聚合）
  screenshots: string[],            # 直播截图（从 Gallery 聚合）
  danmakuCloudUrl: string,          # 弹幕云图（预留字段）
}
```

### 3.2 数据关联策略

**方案 A：通过日期字符串关联（推荐）**

1. **歌切数据关联**
   - 筛选 `performed_at` = 直播日期的所有 `SongRecord`
   - 转换为 `SongCut` 对象

2. **截图数据关联**
   - 在 `Gallery` 中查找与直播日期匹配的图集
   - 匹配规则：
     - 图集标题包含日期字符串（如 "2025-01-15 直播"）
     - 或文件夹路径包含日期（如 "gallery/LiveMoment/2025-01-15/"）
   - 获取图集下的所有图片作为截图

**方案 B：扩展 Gallery 模型**

在 `Gallery` 模型中添加日期字段，明确关联直播日期：

```python
class Gallery(models.Model):
    # ... 现有字段 ...
    live_date = models.DateField(blank=True, null=True, verbose_name='直播日期')
```

**推荐方案 A**，原因：
- 无需修改现有模型结构
- 保持数据库向后兼容
- 灵活性高，支持多种命名格式

## 4. 后端实现方案

### 4.1 创建 livestream 应用

```bash
cd repo/xxm_fans_backend
python manage.py startapp livestream
```

### 4.2 应用结构

```
livestream/
├── __init__.py
├── admin.py
├── apps.py
├── models.py           # 暂不需要新模型
├── services/
│   └── livestream_service.py  # 核心业务逻辑
├── api/
│   ├── serializers.py  # 序列化器
│   ├── views.py        # API 视图
│   └── urls.py         # 路由配置
└── tests/
    └── test_livestream.py
```

### 4.3 核心服务实现

**文件**: `livestream/services/livestream_service.py`

```python
from django.db.models import Q
from django.utils import timezone
from datetime import datetime
from song_management.models import SongRecord
from gallery.models import Gallery
import re


class LivestreamService:
    """直播数据服务 - 聚合现有数据构建虚拟直播记录"""
    
    @staticmethod
    def get_livestreams_by_month(year: int, month: int):
        """
        获取指定月份的所有直播记录
        
        Args:
            year: 年份
            month: 月份 (1-12)
            
        Returns:
            List[dict]: 直播记录列表
        """
        livestreams = []
        
        # 获取当月所有有数据的日期
        date_set = set()
        
        # 1. 获取有演唱记录的日期
        song_record_dates = SongRecord.objects.filter(
            performed_at__year=year,
            performed_at__month=month
        ).values_list('performed_at', flat=True).distinct()
        date_set.update(song_record_dates)
        
        # 2. 获取有图集记录的日期
        # 查找 LiveMoment 下的所有图集
        live_moment_gallery = Gallery.objects.filter(
            folder_path__startswith='/gallery/LiveMoment/',
            is_active=True
        )
        
        for gallery in live_moment_gallery:
            extracted_date = LivestreamService._extract_date_from_gallery(gallery)
            if extracted_date and extracted_date.year == year and extracted_date.month == month:
                date_set.add(extracted_date)
        
        # 3. 为每个日期构建直播记录
        for date in sorted(date_set, reverse=True):
            livestream = LivestreamService._build_livestream_record(date)
            if livestream:
                livestreams.append(livestream)
        
        return livestreams
    
    @staticmethod
    def get_livestream_by_date(date_str: str):
        """
        获取指定日期的直播记录
        
        Args:
            date_str: 日期字符串 (YYYY-MM-DD)
            
        Returns:
            dict: 直播记录详情，如果不存在返回 None
        """
        try:
            date = datetime.strptime(date_str, '%Y-%m-%d').date()
        except ValueError:
            return None
        
        return LivestreamService._build_livestream_record(date)
    
    @staticmethod
    def _extract_date_from_gallery(gallery: Gallery) -> datetime.date or None:
        """
        从图集中提取日期信息
        
        Args:
            gallery: 图集对象
            
        Returns:
            datetime.date or None: 提取的日期，失败返回 None
        """
        # 尝试从标题中提取日期
        title_patterns = [
            r'(\d{4}-\d{2}-\d{2})',  # YYYY-MM-DD
            r'(\d{4}/\d{2}/\d{2})',   # YYYY/MM/DD
            r'(\d{4}年\d{1,2}月\d{1,2}日)',  # 中文日期
            r'(\d{4})年(\d{1,2})月(\d{1,2})日',  # 分组捕获
        ]
        
        for pattern in title_patterns:
            match = re.search(pattern, gallery.title)
            if match:
                # 统一日期格式
                date_str = match.group(1).replace('/', '-').replace('年', '-').replace('月', '-').replace('日', '')
                try:
                    return datetime.strptime(date_str, '%Y-%m-%d').date()
                except ValueError:
                    pass
        
        # 尝试从文件夹路径中提取日期
        path_patterns = [
            r'(\d{4}-\d{2}-\d{2})',
            r'(\d{4}/\d{2}/\d{2})',
        ]
        
        for pattern in path_patterns:
            match = re.search(pattern, gallery.folder_path)
            if match:
                date_str = match.group(1).replace('/', '-')
                try:
                    return datetime.strptime(date_str, '%Y-%m-%d').date()
                except ValueError:
                    pass
        
        return None
    
    @staticmethod
    def _build_livestream_record(date: datetime.date) -> dict or None:
        """
        为指定日期构建完整的直播记录
        
        Args:
            date: 日期对象
            
        Returns:
            dict: 直播记录，如果没有相关数据返回 None
        """
        date_str = date.strftime('%Y-%m-%d')
        
        # 1. 获取当日歌切（演唱记录）
        song_cuts = LivestreamService._get_song_cuts_by_date(date)
        
        # 2. 获取当日截图（图集）
        screenshots, cover_url, title = LivestreamService._get_screenshots_by_date(date)
        
        # 如果既没有歌切也没有截图，返回 None
        if not song_cuts and not screenshots:
            return None
        
        # 3. 构建直播记录
        livestream = {
            'id': date_str,
            'date': date_str,
            'title': title or f'{date_str} 直播记录',
            'summary': f'{date_str} 的精彩直播时刻',
            'coverUrl': cover_url or '',
            'viewCount': 'N/A',
            'danmakuCount': 'N/A',
            'startTime': 'N/A',
            'endTime': 'N/A',
            'duration': 'N/A',
            'recordings': [],
            'songCuts': song_cuts,
            'screenshots': screenshots,
            'danmakuCloudUrl': '',
        }
        
        return livestream
    
    @staticmethod
    def _get_song_cuts_by_date(date: datetime.date) -> list:
        """
        获取指定日期的歌切列表
        
        Args:
            date: 日期对象
            
        Returns:
            list: 歌切列表
        """
        song_records = SongRecord.objects.filter(
            performed_at=date
        ).select_related('song').order_by('song__song_name')
        
        song_cuts = []
        for record in song_records:
            song_cuts.append({
                'name': record.song.song_name,
                'videoUrl': record.url or '',
            })
        
        return song_cuts
    
    @staticmethod
    def _get_screenshots_by_date(date: datetime.date) -> tuple:
        """
        获取指定日期的截图列表、封面和标题
        
        Args:
            date: 日期对象
            
        Returns:
            tuple: (screenshots, cover_url, title)
        """
        date_str = date.strftime('%Y-%m-%d')
        year_month = date.strftime('%Y-%m')
        
        # 查找匹配的图集
        galleries = Gallery.objects.filter(
            Q(folder_path__startswith='/gallery/LiveMoment/') &
            (
                Q(title__icontains=date_str) |
                Q(title__icontains=date.strftime('%Y年%m月%d日')) |
                Q(folder_path__icontains=date_str)
            ),
            is_active=True
        )
        
        if not galleries.exists():
            return [], '', ''
        
        # 使用第一个匹配的图集
        gallery = galleries.first()
        
        # 获取图片列表
        images = gallery.get_images()
        screenshots = [img['url'] for img in images]
        
        # 获取封面
        cover_url = gallery.cover_url or ''
        
        # 获取标题
        title = gallery.title
        
        return screenshots, cover_url, title
```

### 4.4 API 视图实现

**文件**: `livestream/api/views.py`

```python
from rest_framework import generics
from rest_framework.response import Response
from core.responses import success_response
from ..services.livestream_service import LivestreamService


class LivestreamListView(generics.ListAPIView):
    """获取指定月份的直播记录列表"""
    
    def get(self, request, *args, **kwargs):
        year = int(request.query_params.get('year', 2025))
        month = int(request.query_params.get('month', 1))
        
        livestreams = LivestreamService.get_livestreams_by_month(year, month)
        
        return success_response(
            data=livestreams,
            message='获取成功'
        )


class LivestreamDetailView(generics.GenericAPIView):
    """获取指定日期的直播记录详情"""
    
    def get(self, request, date_str, *args, **kwargs):
        livestream = LivestreamService.get_livestream_by_date(date_str)
        
        if not livestream:
            return success_response(
                data=None,
                message='该日期无直播记录'
            )
        
        return success_response(
            data=livestream,
            message='获取成功'
        )
```

**文件**: `livestream/api/urls.py`

```python
from django.urls import path
from .views import LivestreamListView, LivestreamDetailView

urlpatterns = [
    path('livestreams/', LivestreamListView.as_view(), name='livestream-list'),
    path('livestreams/<str:date_str>/', LivestreamDetailView.as_view(), name='livestream-detail'),
]
```

### 4.5 路由注册

在 `repo/xxm_fans_backend/xxm_fans_home/urls.py` 中添加：

```python
urlpatterns = [
    # ... 现有路由 ...
    path('api/', include('livestream.api.urls')),
]
```

### 4.6 应用注册

在 `repo/xxm_fans_backend/xxm_fans_home/settings.py` 中添加：

```python
INSTALLED_APPS = [
    # ... 现有应用 ...
    'livestream',
]
```

## 5. 前端实现方案

### 5.1 类型定义

**文件**: `repo/xxm_fans_frontend/domain/types.ts`

类型定义已存在，无需修改。

### 5.2 API 服务实现

**文件**: `repo/xxm_fans_frontend/infrastructure/api/RealSongService.ts`

添加直播相关方法：

```typescript
// 在现有 RealSongService 类中添加

/**
 * 获取指定月份的直播记录列表
 */
async getLivestreams(year: number, month: number): Promise<Livestream[]> {
  try {
    const response = await fetch(`${this.apiBase}/livestreams/?year=${year}&month=${month}`);
    const result = await response.json();
    
    if (result.code === 200) {
      return result.data;
    }
    return [];
  } catch (error) {
    console.error('获取直播记录失败:', error);
    return [];
  }
}

/**
 * 获取指定日期的直播记录详情
 */
async getLivestreamByDate(dateStr: string): Promise<Livestream | null> {
  try {
    const response = await fetch(`${this.apiBase}/livestreams/${dateStr}/`);
    const result = await response.json();
    
    if (result.code === 200 && result.data) {
      return result.data;
    }
    return null;
  } catch (error) {
    console.error('获取直播详情失败:', error);
    return null;
  }
}
```

### 5.3 页面组件更新

**文件**: `repo/xxm_fans_frontend/presentation/pages/LivestreamPage.tsx`

将 Mock API 替换为真实 API：

```typescript
import { RealSongService } from '../../infrastructure/api/RealSongService';

const LivestreamPage: React.FC = () => {
  const realApi = new RealSongService();
  
  useEffect(() => {
    const fetchLives = async () => {
      setLoading(true);
      const data = await realApi.getLivestreams(currentDate.getFullYear(), currentDate.getMonth() + 1);
      setLives(data);
      // ... 其余逻辑不变
    };
    fetchLives();
  }, [currentDate]);
  
  // ... 其余代码不变
};
```

## 6. 图集命名规范

为了确保直播日历能够正确关联图集数据，建议遵循以下命名规范：

### 6.1 图集标题格式

```
{日期} 直播记录
```

示例：
- `2025-01-15 直播记录`
- `2025年01月15日 直播记录`

### 6.2 文件夹路径格式

```
media/gallery/LiveMoment/{YYYY}/{MM}/{DD}/
```

示例：
- `media/gallery/LiveMoment/2025/01/15/`

### 6.3 图集结构

```
media/gallery/LiveMoment/
├── 2025/
│   ├── 01/
│   │   ├── 15/
│   │   │   ├── 001.jpg
│   │   │   ├── 002.jpg
│   │   │   ├── ...
│   │   │   └── cover.jpg
│   │   └── 16/
│   └── 02/
└── 2026/
```

## 7. 扩展功能（可选）

### 7.1 Admin 后台管理

在 `livestream/admin.py` 中添加自定义管理界面，方便手动配置直播数据：

```python
from django.contrib import admin
from gallery.models import Gallery


@admin.register(Gallery)
class LiveGalleryAdmin(admin.ModelAdmin):
    """直播图集管理"""
    
    list_display = ['id', 'title', 'folder_path', 'image_count', 'is_active']
    list_filter = ['is_active', 'created_at']
    search_fields = ['title', 'folder_path']
    
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        # 只显示 LiveMoment 下的图集
        return qs.filter(folder_path__startswith='/gallery/LiveMoment/')
```

### 7.2 数据同步脚本

创建定时任务或手动脚本，自动同步演唱记录和图集数据到直播日历。

### 7.3 数据统计

添加直播统计功能，如：
- 每月直播次数
- 歌曲演唱频率统计
- 热门歌切排行

## 8. 实施步骤

1. **创建 livestream 应用**
   ```bash
   cd repo/xxm_fans_backend
   python manage.py startapp livestream
   ```

2. **实现后端服务**
   - 创建 `livestream/services/livestream_service.py`
   - 创建 `livestream/api/views.py`
   - 创建 `livestream/api/urls.py`

3. **注册应用和路由**
   - 在 `settings.py` 中注册 `livestream` 应用
   - 在 `urls.py` 中添加路由

4. **实现前端 API**
   - 更新 `RealSongService.ts` 添加直播相关方法

5. **更新前端页面**
   - 将 `LivestreamPage.tsx` 中的 Mock API 替换为真实 API

6. **测试验证**
   - 准备测试数据（演唱记录和图集）
   - 测试日历视图、详情展示、歌切列表、截图展示

7. **部署上线**

## 9. 注意事项

1. **性能优化**
   - 日历数据查询使用 `select_related` 减少数据库查询次数
   - 考虑添加缓存机制（Redis）
   - 图片使用缩略图提升加载速度

2. **数据一致性**
   - 确保演唱记录的 `performed_at` 字段格式正确
   - 确保图集命名遵循规范

3. **错误处理**
   - 日期格式异常处理
   - 图集匹配失败时的降级方案

4. **SEO 优化**
   - 添加页面标题和描述
   - 使用语义化 HTML 标签
   - 添加结构化数据

## 10. 后续优化方向

1. **独立直播模型**
   - 如果直播数据变得复杂，考虑创建独立的 `Livestream` 模型
   - 支持手动编辑直播信息（标题、简介、观看人数等）

2. **高级筛选**
   - 按歌曲筛选直播记录
   - 按时间范围筛选

3. **数据可视化**
   - 直播时长统计图表
   - 歌曲演唱频率分析

4. **用户交互**
   - 直播评论功能
   - 直播收藏功能
   - 分享功能