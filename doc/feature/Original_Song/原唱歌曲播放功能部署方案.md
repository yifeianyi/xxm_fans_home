# 原唱歌曲播放功能部署方案

## 一、部署概述

本文档详细说明原唱歌曲播放功能从开发到生产环境的部署流程，包括前端、后端和数据库的部署步骤。

## 二、环境要求

### 2.1 服务器要求

- **操作系统**: Linux (推荐 Ubuntu 20.04+)
- **Python**: 3.8+
- **Node.js**: 18+
- **Nginx**: 1.18+
- **Gunicorn**: 21.0+
- **数据库**: SQLite 3 或 MySQL 5.7+

### 2.2 软件依赖

#### 后端依赖
```
Django==5.2.3
djangorestframework==3.15.2
django-cors-headers==4.9.0
python-dotenv==1.0.1
Pillow==10.2.0
mysqlclient==2.1.1 (如果使用 MySQL)
```

#### 前端依赖
```
react==19.2.3
typescript==5.8.2
vite==6.2.0
react-router-dom==7.12.0
lucide-react==0.562.0
sharp==0.34.5
```

## 三、部署步骤

### 3.1 代码部署

#### 3.1.1 拉取最新代码

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home
git pull origin main
```

#### 3.1.2 同步子模块（如果有）

```bash
git submodule update --init --recursive
```

### 3.2 数据库迁移

#### 3.2.1 进入后端目录

```bash
cd repo/xxm_fans_backend
```

#### 3.2.2 创建并激活虚拟环境（首次）

```bash
python3 -m venv venv
source venv/bin/activate
```

#### 3.2.3 安装依赖

```bash
pip install -r requirements.txt
```

#### 3.2.4 应用数据库迁移

```bash
python manage.py migrate
```

**注意**：如果使用 MySQL，需要先配置数据库连接：

```bash
# 编辑 env/backend.env
DB_ENGINE=django.db.backends.mysql
DB_NAME=xxm_fans_home
DB_USER=your_username
DB_PASSWORD=your_password
DB_HOST=localhost
DB_PORT=3306
```

#### 3.2.5 收集静态文件

```bash
python manage.py collectstatic --noinput
```

#### 3.2.6 添加测试数据（可选）

```bash
python manage.py shell << 'EOF'
from song_management.models import OriginalWork
from datetime import date

works = [
    {
        'title': '满天星',
        'release_date': date(2024, 1, 15),
        'description': '第一首个人原创单曲，星光点缀梦境。',
        'netease_id': '1330348068',
        'bilibili_bvid': '',
        'featured': True,
    },
    {
        'title': '溯光者',
        'release_date': date(2023, 11, 20),
        'description': '在音符中寻找光亮，致敬不曾放弃的灵魂。',
        'netease_id': '',
        'bilibili_bvid': 'BV1xx411c7mD',
        'featured': True,
    },
    {
        'title': '森林来信',
        'release_date': date(2023, 5, 10),
        'description': '写给所有小满虫的音乐家书，温暖坚定。',
        'netease_id': '1901371647',
        'bilibili_bvid': '',
        'featured': True,
    },
    {
        'title': '月光小夜曲',
        'release_date': date(2023, 2, 28),
        'description': '温柔的夜晚，用音乐诉说心事。',
        'netease_id': '1496089319',
        'bilibili_bvid': '',
        'featured': False,
    },
]

for work_data in works:
    if not OriginalWork.objects.filter(title=work_data['title']).exists():
        OriginalWork.objects.create(**work_data)
        print(f"✓ 已添加原唱作品: {work_data['title']}")

print(f"\n当前共有 {OriginalWork.objects.count()} 首原唱作品")
EOF
```

### 3.3 前端构建

#### 3.3.1 进入前端目录

```bash
cd ../xxm_fans_frontend
```

#### 3.3.2 安装依赖（首次）

```bash
npm install
```

#### 3.3.3 生产构建

```bash
npm run build
```

构建完成后，`dist/` 目录包含所有静态文件。

### 3.4 Nginx 配置

#### 3.4.1 更新 Nginx 配置文件

配置文件位置：`infra/nginx/xxm_nginx.conf`

关键配置：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_frontend/dist;
    index index.html;

    # 前端路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 代理
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件服务
    location /media {
        alias /home/yifeianyi/Desktop/xxm_fans_home/media;
    }

    location /static {
        alias /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/staticfiles;
    }

    # 封面图片服务
    location /covers {
        alias /home/yifeianyi/Desktop/xxm_fans_home/media/covers;
    }
}
```

#### 3.4.2 测试 Nginx 配置

```bash
nginx -t -c /home/yifeianyi/Desktop/xxm_fans_home/infra/nginx/xxm_nginx.conf -p /tmp/nginx
```

#### 3.4.3 重启 Nginx

```bash
# 停止旧的 Nginx 进程
nginx -s stop 2>/dev/null || true

# 启动新的 Nginx
nginx -c /home/yifeianyi/Desktop/xxm_fans_home/infra/nginx/xxm_nginx.conf -p /tmp/nginx
```

### 3.5 启动后端服务

#### 3.5.1 使用 Gunicorn 启动

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend

# 激活虚拟环境
source venv/bin/activate

# 启动 Gunicorn
gunicorn xxm_fans_home.wsgi:application \
    -c /home/yifeianyi/Desktop/xxm_fans_home/infra/gunicorn/gunicorn_config.py \
    --bind 127.0.0.1:8000 \
    --daemon
```

#### 3.5.2 使用 systemd 管理（推荐）

创建 systemd 服务文件：`infra/systemd/xxm-fans-home.service`

```ini
[Unit]
Description=XXM Fans Home Django Application
After=network.target

[Service]
Type=notify
User=yifeianyi
Group=yifeianyi
WorkingDirectory=/home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
Environment="PATH=/home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/venv/bin"
ExecStart=/home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/venv/bin/gunicorn xxm_fans_home.wsgi:application -c /home/yifeianyi/Desktop/xxm_fans_home/infra/gunicorn/gunicorn_config.py
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=mixed
TimeoutStopSec=5
PrivateTmp=true
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

安装并启动服务：

```bash
# 复制服务文件（需要 root 权限）
sudo cp /home/yifeianyi/Desktop/xxm_fans_home/infra/systemd/xxm-fans-home.service /etc/systemd/system/

# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start xxm-fans-home

# 设置开机自启
sudo systemctl enable xxm-fans-home

# 查看服务状态
sudo systemctl status xxm-fans-home
```

### 3.6 使用部署脚本（推荐）

#### 3.6.1 创建软链接（首次）

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/scripts

# 应用级软链接
./create_symlinks.sh

# 基础设施软链接（需要 root 权限）
sudo ./create_infra_symlinks.sh
```

#### 3.6.2 使用构建脚本

```bash
# 停止现有服务
./build_stop_services.sh

# 启动生产环境服务
./build_start_services.sh
```

## 四、部署验证

### 4.1 前端验证

访问以下 URL，检查页面是否正常：

- **首页**: `http://your-domain.com/`
- **歌曲页面**: `http://your-domain.com/songs`
- **原唱作品标签**: 点击歌曲页面的"原唱作品"标签

### 4.2 后端 API 验证

测试原唱作品 API：

```bash
curl http://your-domain.com/api/original-works/
```

预期响应：
```json
{
  "code": 200,
  "message": "获取原唱作品列表成功",
  "data": [...]
}
```

### 4.3 Admin 后台验证

访问 Admin 后台：`http://your-domain.com/admin/`

检查是否能看到「原唱作品」管理界面。

### 4.4 功能测试

1. **精选作品显示**
   - 检查唱片机风格是否正常
   - 检查封面图片是否显示
   - 检查作品描述是否显示

2. **播放功能**
   - 点击网易云音乐歌曲 → 检查播放器是否显示
   - 点击 B站视频歌曲 → 检查视频是否播放
   - 点击正在播放的作品 → 检查是否停止播放

3. **旋转动画**
   - 播放时检查唱片是否旋转
   - 停止时检查唱片是否停止

4. **随机播放**
   - 点击"随机听一首原唱"按钮
   - 检查是否随机选择作品并播放

## 五、常见问题排查

### 5.1 前端问题

**问题：页面显示 404**
- 检查 Nginx 配置中的 `root` 路径是否正确
- 检查前端构建是否成功

**问题：API 调用失败**
- 检查 Nginx 代理配置
- 检查后端服务是否运行

**问题：静态资源加载失败**
- 检查 `staticfiles` 和 `media` 目录权限
- 检查 Nginx 静态文件配置

### 5.2 后端问题

**问题：数据库迁移失败**
- 检查数据库连接配置
- 检查数据库用户权限

**问题：静态文件收集失败**
- 检查 `STATIC_ROOT` 权限
- 检查磁盘空间

**问题：Gunicorn 启动失败**
- 检查端口 8000 是否被占用
- 检查虚拟环境是否激活
- 检查依赖是否安装完整

### 5.3 播放器问题

**问题：网易云音乐无法播放**
- 检查歌曲 ID 是否正确
- 检查是否有网络限制
- 某些歌曲可能因版权无法播放

**问题：B站视频无法播放**
- 检查 BV 号是否正确
- 检查是否有地区限制
- 检查视频是否被删除

## 六、日志查看

### 6.1 后端日志

**Gunicorn 日志**:
```bash
tail -f /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/logs/gunicorn.log
```

**Django 日志**:
```bash
tail -f /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/logs/django.log
```

### 6.2 Nginx 日志

```bash
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### 6.3 systemd 日志

```bash
sudo journalctl -u xxm-fans-home -f
```

## 七、性能优化建议

### 7.1 后端优化

1. **启用 Redis 缓存**
   - 原唱作品列表已实现缓存
   - 其他高频接口也可添加缓存

2. **数据库优化**
   - 为常用查询添加索引
   - 考虑使用 MySQL 替代 SQLite

3. **静态文件优化**
   - 使用 CDN 加速静态资源
   - 启用 Gzip 压缩

### 7.2 前端优化

1. **图片优化**
   - 使用 WebP 格式
   - 实现图片懒加载
   - 添加缩略图

2. **代码分割**
   - 已实现路由级代码分割
   - 可考虑组件级分割

3. **缓存策略**
   - 配置合适的缓存头
   - 使用 Service Worker

## 八、备份策略

### 8.1 数据库备份

**自动备份脚本**（需要定期执行）：

```bash
# 备份 SQLite 数据库
cp /home/yifeianyi/Desktop/xxm_fans_home/data/db.sqlite3 /home/yifeianyi/Desktop/xxm_fans_home/data/backups/db_$(date +%Y%m%d_%H%M%S).sqlite3

# 备份 MySQL 数据库（如果使用）
mysqldump -u username -p xxm_fans_home > /home/yifeianyi/Desktop/xxm_fans_home/data/backups/db_$(date +%Y%m%d_%H%M%S).sql
```

### 8.2 媒体文件备份

```bash
# 备份媒体文件
rsync -av /home/yifeianyi/Desktop/xxm_fans_home/media/ /home/yifeianyi/Desktop/xxm_fans_home/backup/media_$(date +%Y%m%d_%H%M%S)/
```

### 8.3 代码备份

```bash
# Git 备份
cd /home/yifeianyi/Desktop/xxm_fans_home
git add .
git commit -m "Backup before deployment"
git push origin main
```

## 九、回滚方案

如果部署后出现问题，可以按以下步骤回滚：

### 9.1 代码回滚

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home
git log --oneline -10
git checkout <previous-commit-hash>
```

### 9.2 数据库回滚

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
python manage.py migrate song_management 0002  # 回滚到上一个迁移
```

### 9.3 快速回滚脚本

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/scripts
./build_stop_services.sh
git checkout <previous-commit-hash>
./build_start_services.sh
```

## 十、监控和告警

### 10.1 健康检查

创建健康检查端点：

```python
# xxm_fans_home/urls.py
from django.http import JsonResponse

def health_check(request):
    return JsonResponse({
        'status': 'healthy',
        'timestamp': timezone.now().isoformat()
    })
```

配置 Nginx 健康检查：

```nginx
location /health {
    proxy_pass http://127.0.0.1:8000/health;
    access_log off;
}
```

### 10.2 监控指标

关键指标：
- API 响应时间
- 错误率
- 并发用户数
- 数据库连接数

### 10.3 告警配置

可以使用 UptimeRobot 或类似工具监控服务可用性。

## 十一、安全建议

1. **环境变量**
   - 不要将敏感信息提交到 Git
   - 使用 `.env` 文件管理环境变量
   - 确保 `.env` 在 `.gitignore` 中

2. **权限管理**
   - 限制 Admin 后台访问
   - 使用强密码
   - 定期更新密码

3. **HTTPS**
   - 配置 SSL 证书
   - 强制 HTTPS 重定向

4. **防火墙**
   - 只开放必要的端口（80, 443, SSH）
   - 限制数据库访问

## 十二、部署检查清单

部署前检查：

- [ ] 代码已推送到 Git
- [ ] 所有依赖已安装
- [ ] 数据库迁移已应用
- [ ] 静态文件已收集
- [ ] Nginx 配置已更新
- [ ] Gunicorn 配置已更新
- [ ] 测试数据已添加
- [ ] 前端构建成功
- [ ] 本地测试通过
- [ ] 备份已完成

部署后验证：

- [ ] 网站可以正常访问
- [ ] API 接口正常工作
- [ ] Admin 后台可以访问
- [ ] 原唱作品功能正常
- [ ] 播放功能正常
- [ ] 旋转动画正常
- [ ] 没有控制台错误
- [ ] 日志中没有错误

## 十三、联系信息

如有问题，请联系开发团队或查看项目文档：
- 项目文档：`/doc/`
- API 文档：`repo/xxm_fans_backend/doc/API文档.md`
- 管理文档：`AGENTS.md`