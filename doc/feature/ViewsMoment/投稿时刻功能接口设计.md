# 投稿时刻功能 - API 接口设计方案

## 一、功能概述

### 1.1 功能定位
"投稿时刻"是 XXM Fans Home 核心功能之一，用于展示咻咻满在各个平台的投稿历史和重要时刻，通过时间线的形式直观展示每年的投稿活动和月度统计数据。

### 1.2 核心功能
- **年度时间线**：展示 2021-2024 年的投稿活动
- **月度统计**：显示每月的投稿总数、有效投稿、无效投稿
- **投稿记录**：点击月份查看该月的所有投稿记录
- **视频播放**：支持直接播放投稿视频

### 1.3 技术栈
- **后端**：Django 5.2.3 + Django REST Framework 3.15.2
- **前端**：React 19.2.3 + TypeScript 5.8.2
- **数据库**：SQLite（view_data_db）

---

## 二、现有数据结构分析

### 2.1 WorkStatic 模型
```python
# data_analytics/models/work_static.py
class WorkStatic(models.Model):
    platform = models.CharField(max_length=50, verbose_name="平台")
    work_id = models.CharField(max_length=100, verbose_name="作品ID")
    title = models.CharField(max_length=500, verbose_name="标题")
    author = models.CharField(max_length=200, verbose_name="作者")
    publish_time = models.DateTimeField(verbose_name="发布时间")  # ⭐ 核心字段
    cover_url = models.URLField(max_length=500, blank=True, null=True, verbose_name="封面URL")
    is_valid = models.BooleanField(default=True, verbose_name="投稿是否有效")

    class Meta:
        ordering = ['-publish_time']
        indexes = [
            models.Index(fields=['publish_time']),
        ]
```

### 2.2 关键字段说明
| 字段 | 类型 | 说明 | 用途 |
|------|------|------|------|
| `publish_time` | DateTimeField | 发布时间/投稿时间 | 时间线展示、月度聚合 |
| `is_valid` | BooleanField | 投稿是否有效 | 区分有效/无效投稿 |
| `cover_url` | URLField | 封面URL | 时间线卡片展示 |
| `work_id` | CharField | 作品ID | 生成视频播放链接 |

---

## 三、API 接口设计

### 3.1 接口概览

| 接口名称 | HTTP 方法 | 路径 | 说明 |
|---------|----------|------|------|
| 月度投稿统计 | GET | `/api/data-analytics/submissions/monthly/` | 获取指定年份的月度统计 |
| 月度投稿记录 | GET | `/api/data-analytics/submissions/monthly/{year}/{month}/` | 获取指定年月的投稿记录 |
| 年度投稿概览 | GET | `/api/data-analytics/submissions/years/` | 获取所有年份的投稿概览 |

### 3.2 接口详细设计

#### 3.2.1 月度投稿统计接口

**接口路径**：`GET /api/data-analytics/submissions/monthly/`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `year` | integer | 否 | 年份，默认为当前年份 | `2024` |
| `platform` | string | 否 | 平台筛选，可选值：`bilibili`、`youtube` | `bilibili` |

**请求示例**：
```bash
curl -X GET "http://localhost:8000/api/data-analytics/submissions/monthly/?year=2024&platform=bilibili"
```

**响应格式**：
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "year": 2024,
    "platform": "bilibili",
    "monthly_stats": [
      {
        "month": 1,
        "total": 15,
        "valid": 14,
        "invalid": 1,
        "first_submission": "2024-01-05T10:30:00+08:00",
        "last_submission": "2024-01-28T18:45:00+08:00"
      },
      {
        "month": 2,
        "total": 12,
        "valid": 12,
        "invalid": 0,
        "first_submission": "2024-02-03T14:20:00+08:00",
        "last_submission": "2024-02-25T16:10:00+08:00"
      }
    ],
    "year_summary": {
      "total_submissions": 27,
      "valid_submissions": 26,
      "invalid_submissions": 1,
      "active_months": 2
    }
  }
}
```

**响应字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| `year` | integer | 年份 |
| `platform` | string | 平台名称 |
| `monthly_stats` | array | 月度统计数据数组 |
| `monthly_stats[].month` | integer | 月份（1-12） |
| `monthly_stats[].total` | integer | 该月投稿总数 |
| `monthly_stats[].valid` | integer | 该月有效投稿数 |
| `monthly_stats[].invalid` | integer | 该月无效投稿数 |
| `monthly_stats[].first_submission` | string | 该月最早投稿时间 |
| `monthly_stats[].last_submission` | string | 该月最晚投稿时间 |
| `year_summary` | object | 年度汇总统计 |
| `year_summary.total_submissions` | integer | 年度投稿总数 |
| `year_summary.valid_submissions` | integer | 年度有效投稿数 |
| `year_summary.invalid_submissions` | integer | 年度无效投稿数 |
| `year_summary.active_months` | integer | 有投稿的月份数 |

---

#### 3.2.2 月度投稿记录接口

**接口路径**：`GET /api/data-analytics/submissions/monthly/{year}/{month}/`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `year` | integer | 是 | 年份（路径参数） | `2024` |
| `month` | integer | 是 | 月份（路径参数） | `1` |
| `platform` | string | 否 | 平台筛选 | `bilibili` |
| `is_valid` | boolean | 否 | 是否有效投稿 | `true` |
| `page` | integer | 否 | 页码，默认 1 | `1` |
| `page_size` | integer | 否 | 每页数量，默认 20，最大 100 | `20` |

**请求示例**：
```bash
curl -X GET "http://localhost:8000/api/data-analytics/submissions/monthly/2024/1/?platform=bilibili&page=1&page_size=20"
```

**响应格式**：
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "year": 2024,
    "month": 1,
    "platform": "bilibili",
    "records": [
      {
        "id": 1,
        "platform": "bilibili",
        "work_id": "BV1234567890",
        "title": "歌曲名称-2024年1月5日",
        "author": "咻咻满",
        "publish_time": "2024-01-05T10:30:00+08:00",
        "cover_url": "/media/data_analytics/covers/BV1234567890.jpg",
        "cover_thumbnail_url": "/media/data_analytics/covers/thumbnails/BV1234567890_thumb.jpg",
        "is_valid": true,
        "video_url": "https://www.bilibili.com/video/BV1234567890",
        "video_embed_url": "https://player.bilibili.com/player.html?bvid=BV1234567890"
      },
      {
        "id": 2,
        "platform": "bilibili",
        "work_id": "BV0987654321",
        "title": "歌曲名称-2024年1月10日",
        "author": "咻咻满",
        "publish_time": "2024-01-10T14:20:00+08:00",
        "cover_url": "/media/data_analytics/covers/BV0987654321.jpg",
        "cover_thumbnail_url": "/media/data_analytics/covers/thumbnails/BV0987654321_thumb.jpg",
        "is_valid": true,
        "video_url": "https://www.bilibili.com/video/BV0987654321",
        "video_embed_url": "https://player.bilibili.com/player.html?bvid=BV0987654321"
      }
    ],
    "pagination": {
      "total": 15,
      "page": 1,
      "page_size": 20,
      "total_pages": 1
    }
  }
}
```

**响应字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| `year` | integer | 年份 |
| `month` | integer | 月份 |
| `platform` | string | 平台名称 |
| `records` | array | 投稿记录数组 |
| `records[].id` | integer | 记录ID |
| `records[].platform` | string | 平台名称 |
| `records[].work_id` | string | 作品ID |
| `records[].title` | string | 作品标题 |
| `records[].author` | string | 作者名称 |
| `records[].publish_time` | string | 发布时间（ISO 8601） |
| `records[].cover_url` | string | 封面图片URL |
| `records[].cover_thumbnail_url` | string | 封面缩略图URL |
| `records[].is_valid` | boolean | 是否有效投稿 |
| `records[].video_url` | string | 视频播放URL |
| `records[].video_embed_url` | string | 视频嵌入URL |
| `pagination` | object | 分页信息 |
| `pagination.total` | integer | 总记录数 |
| `pagination.page` | integer | 当前页码 |
| `pagination.page_size` | integer | 每页数量 |
| `pagination.total_pages` | integer | 总页数 |

---

#### 3.2.3 年度投稿概览接口

**接口路径**：`GET /api/data-analytics/submissions/years/`

**请求参数**：
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `platform` | string | 否 | 平台筛选 | `bilibili` |
| `start_year` | integer | 否 | 起始年份（不传则自动从最早投稿年份开始） | `2021` |
| `end_year` | integer | 否 | 结束年份（不传则自动到当前年份） | `2024` |

**说明**：
- 该接口主要用于获取所有有投稿的年份列表，前端据此渲染年份选择器或时间线
- 如果不传 `start_year` 和 `end_year`，则自动返回从最早投稿年份到当前年份的所有数据
- 前端通过 `years[].year` 字段动态渲染年份选项

**请求示例**：

1. **获取所有年份（推荐）**：
```bash
curl -X GET "http://localhost:8000/api/data-analytics/submissions/years/"
```
此请求会自动返回从最早投稿年份到当前年份的所有数据。

2. **指定年份范围**：
```bash
curl -X GET "http://localhost:8000/api/data-analytics/submissions/years/?platform=bilibili&start_year=2022&end_year=2024"
```
此请求只返回指定年份范围内的数据。

**响应格式**：
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "platform": "bilibili",
    "years": [
      {
        "year": 2022,
        "total_submissions": 68,
        "valid_submissions": 65,
        "invalid_submissions": 3,
        "active_months": 12,
        "first_submission": "2022-01-05T09:00:00+08:00",
        "last_submission": "2022-12-30T20:00:00+08:00"
      },
      {
        "year": 2023,
        "total_submissions": 72,
        "valid_submissions": 70,
        "invalid_submissions": 2,
        "active_months": 11,
        "first_submission": "2023-01-08T11:00:00+08:00",
        "last_submission": "2023-12-25T17:45:00+08:00"
      },
      {
        "year": 2024,
        "total_submissions": 27,
        "valid_submissions": 26,
        "invalid_submissions": 1,
        "active_months": 2,
        "first_submission": "2024-01-05T10:30:00+08:00",
        "last_submission": "2024-02-25T16:10:00+08:00"
      }
    ],
    "summary": {
      "total_years": 3,
      "total_submissions": 167,
      "valid_submissions": 161,
      "invalid_submissions": 6
    }
  }
}
```

**注意**：以上示例中的年份（2022-2024）是根据数据库实际数据动态生成的，如果数据库中只有这些年份的数据，则只返回这些年份。

**响应字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| `platform` | string | 平台名称 |
| `years` | array | 年度统计数组（根据数据库实际数据动态生成） |
| `years[].year` | integer | 年份（从数据库中动态提取） |
| `years[].total_submissions` | integer | 该年投稿总数 |
| `years[].valid_submissions` | integer | 该年有效投稿数 |
| `years[].invalid_submissions` | integer | 该年无效投稿数 |
| `years[].active_months` | integer | 有投稿的月份数 |
| `years[].first_submission` | string | 该年最早投稿时间 |
| `years[].last_submission` | string | 该年最晚投稿时间 |
| `summary` | object | 总体统计 |
| `summary.total_years` | integer | 总年份数（动态统计） |
| `summary.total_submissions` | integer | 总投稿数 |
| `summary.valid_submissions` | integer | 总有效投稿数 |
| `summary.invalid_submissions` | integer | 总无效投稿数 |

**重要说明**：
- `years` 数组中的年份完全由数据库中的实际投稿数据决定
- 前端应通过调用此接口获取所有可用年份，而不是硬编码年份列表
- 如果数据库只有 2022-2024 年的数据，则只返回这三个年份

---

## 四、接口设计原则

### 4.1 RESTful 设计
- 使用标准 HTTP 方法（GET）
- 资源命名清晰（`submissions` 表示投稿资源）
- 支持查询参数过滤和分页

### 4.2 数据完整性
- 返回完整的时间信息（ISO 8601 格式）
- 提供缩略图 URL 优化加载性能
- 区分有效/无效投稿

### 4.3 性能优化
- 使用数据库索引（`publish_time` 字段）
- 支持分页查询，避免大数据量返回
- 缓存策略（建议使用 Redis 缓存统计数据）

### 4.4 可扩展性
- 支持多平台（`platform` 参数）
- 支持时间范围筛选（`start_year`、`end_year`）
- 预留扩展字段（如 `tags`、`category`）

### 4.5 错误处理
- 统一的错误响应格式
- 详细的错误信息
- 合适的 HTTP 状态码

**错误响应格式**：
```json
{
  "code": 400,
  "message": "参数错误：年份必须为整数",
  "data": null
}
```

---

## 五、接口优先级

### 5.1 核心接口（P0 - 必须实现）
1. **月度投稿统计接口** - 前端时间线展示的基础
2. **月度投稿记录接口** - 点击月份查看详情

### 5.2 重要接口（P1 - 建议实现）
3. **年度投稿概览接口** - 提供年度总览数据

### 5.3 扩展接口（P2 - 可选实现）
- 投稿趋势分析接口
- 投稿热力图接口
- 投稿时间分布接口

---

## 六、后续优化建议

### 6.1 缓存优化
- 使用 Redis 缓存月度统计数据（TTL: 1小时）
- 使用 Redis 缓存月度记录数据（TTL: 30分钟）

### 6.2 性能优化
- 添加数据库查询优化（`select_related`、`prefetch_related`）
- 使用数据库连接池
- 异步处理大数据量查询

### 6.3 功能扩展
- 支持自定义时间范围查询
- 支持数据导出（CSV、Excel）
- 支持投稿数据对比分析

---

## 七、接口版本管理

### 7.1 版本策略
- 当前版本：`v1`
- 版本前缀：`/api/v1/`
- 向后兼容：保证 v1 接口稳定性

### 7.2 升级路径
- 新功能在 `v2` 中添加
- 废弃接口提前通知（至少 3 个月）
- 提供迁移文档和工具

---

## 八、安全考虑

### 8.1 访问控制
- 公开接口，无需认证
- 限制访问频率（Rate Limiting）

### 8.2 数据安全
- 避免返回敏感信息
- 使用 HTTPS 传输
- 输入参数验证和过滤

---

## 九、监控和日志

### 9.1 接口监控
- 响应时间监控
- 错误率监控
- 流量监控

### 9.2 日志记录
- 访问日志
- 错误日志
- 性能日志

---

## 十、总结

本接口设计方案基于现有的 `WorkStatic` 模型，提供了完整的投稿时刻功能 API 支持：

1. **月度投稿统计接口**：支持按年份、平台查询月度统计数据
2. **月度投稿记录接口**：支持按年月查询投稿记录，支持分页
3. **年度投稿概览接口**：提供年度总览数据

接口设计遵循 RESTful 原则，注重性能优化和可扩展性，为前端 TimelineChart 组件提供完整的数据支持。