# 直播云图批量入库脚本

## 功能说明

将 `media/cloud_picture` 目录下的直播云图批量导入到直播日历数据库（Livestream 表）的 `danmaku_cloud_url` 字段，使直播日历页面可以显示弹幕云图。

## 目录结构

```
media/cloud_picture/
├── 2019/
│   ├── 20190425.jpg
│   ├── 20190426.jpg
│   └── ...
├── 2020/
│   ├── 20200101.jpg
│   └── ...
├── 2021/
│   ├── 20210101.jpg
│   └── ...
├── 2022/
│   └── ...
├── 2023/
│   └── ...
├── 2024/
│   └── ...
└── 2025/
    └── ...
```

## 文件命名规则

云图文件命名必须符合日期格式（用于自动匹配直播记录）：
- `YYYYMMDD.jpg` (如: 20190425.jpg)
- `YYYY-MM-DD.jpg` (如: 2019-04-25.jpg)
- `YYYY_MM_DD.jpg` (如: 2019_04_25.jpg)

## 使用方法

### 运行脚本

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home
python3 scripts/import_cloud_picture_to_livestream.py
```

### 脚本功能

1. **扫描云图目录**：遍历所有年份目录下的图片文件
2. **解析日期**：从文件名中提取日期信息
3. **匹配直播记录**：根据日期查找对应的 Livestream 记录
4. **更新云图URL**：将云图路径写入 `danmaku_cloud_url` 字段
5. **跳过已有记录**：如果直播记录已有云图，则跳过

### 运行结果示例

```
============================================================
直播云图导入到直播日历
============================================================

扫描目录: /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/media/cloud_picture

发现 7 个年份目录

处理 2019 年:
  发现 214 张云图文件
    ✓ 已导入: 2019-04-25 - 20190425.jpg
    ✓ 已导入: 2019-04-26 - 20190426.jpg
    ...

处理 2020 年:
  发现 304 张云图文件
    ✓ 已导入: 2020-01-01 - 20200101.jpg
    ...

============================================================
导入完成！
============================================================
扫描文件: 1828
成功导入: 1828
跳过已有: 0
未匹配: 0

数据库统计:
  总直播记录数: 1828
  已有云图记录: 1828
```

## 注意事项

1. **文件命名必须包含日期**：脚本通过文件名中的日期匹配直播记录
2. **直播记录必须存在**：如果某日期没有对应的直播记录，该云图将被标记为"未匹配"
3. **重复运行安全**：脚本会跳过已有云图的记录，可安全重复运行
4. **支持增量更新**：添加新云图后，只需再次运行脚本即可

## 数据库字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `danmaku_cloud_url` | CharField(500) | 弹幕云图URL，存储格式: `/media/cloud_picture/YYYY/YYYYMMDD.jpg` |

## 相关文件

- 脚本位置: `scripts/import_cloud_picture_to_livestream.py`
- 数据模型: `repo/xxm_fans_backend/livestream/models.py`
- 云图目录: `media/cloud_picture/`