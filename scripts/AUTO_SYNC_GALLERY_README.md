# 自动同步图集脚本

## 功能说明

`auto_sync_gallery.py` 脚本用于将新图集放到 `gallery` 目录后，自动更新后台数据库。

## 主要特性

### 1. 唯一ID生成
- **根图集**：直接使用文件夹名（如 `weibo_images`）
- **子图集**：使用 `父图集ID-子文件夹名` 格式
  - 第一层：`weibo_images-2020`
  - 第二层：`weibo_images-2020-05`
  - 第三层：`weibo_images-2020-05-01`
- 这样即使不同图集下存在相同的年份/日期子文件夹，也不会冲突：
  - `weibo_images/2020/05` → `weibo_images-2020-05`
  - `其他图集/2020/05` → `其他图集-2020-05`

### 2. 完整的同步功能
- 扫描目录：递归扫描 `media/gallery/` 目录下的所有子文件夹
- 创建图集：为新文件夹创建图集记录
- 更新图集：更新已存在图集的信息（标题、描述、图片数量等）
- 删除图集：删除数据库中已不存在的图集记录
- 刷新统计：自动刷新所有父图集的图片数量

## 使用方法

### 1. 添加新图集

将新的图集文件夹放到 `media/gallery/` 目录下，例如：

```
media/gallery/
├── weibo_images/
│   ├── 2020/
│   │   ├── 05/
│   │   └── 12/
│   └── 2025/
│       └── 新图集/          # 新添加的图集
│           ├── image1.jpg
│           ├── image2.jpg
│           └── cover.jpg    # 可选：封面图片
└── 其他图集/
```

### 2. 运行同步脚本

```bash
cd /home/yifeianyi/Desktop/xxm_fans_home
python3 tools/auto_sync_gallery.py
```

## 脚本功能

### 自动处理

- **扫描目录**：递归扫描 `media/gallery/` 目录下的所有子文件夹
- **创建图集**：为新文件夹创建图集记录
- **更新图集**：更新已存在图集的信息（标题、描述、图片数量等）
- **删除图集**：删除数据库中已不存在的图集记录
- **刷新统计**：自动刷新所有父图集的图片数量

### 智能识别

- **封面图片**：自动识别 `cover.jpg` 作为封面
- **图片格式**：支持 `.jpg`, `.jpeg`, `.png`, `.webp`, `.gif`, `.mp4`
- **层级结构**：自动识别文件夹层级，建立父子关系

### 统计信息

脚本会显示详细的统计信息：
- 扫描的目录数量
- 创建的图集数量
- 更新的图集数量
- 删除的图集数量
- 错误信息（如果有）
- 总图集数和总图片数

## 输出示例

```
============================================================
自动同步图集数据
============================================================

扫描目录: /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend/media/gallery
  ✓ 更新: weibo_images (0 张图片)
  ✓ 更新: 2020 (0 张图片)
  + 创建: 新图集 (15 张图片)
  ✓ 更新: 2025 (0 张图片)

刷新父图集图片数量...

============================================================
同步完成！
============================================================
扫描目录: 39
创建图集: 1
更新图集: 38
删除图集: 0

没有错误！

图集统计:
  总图集数: 39
  总图片数: 945
```

## 注意事项

1. **文件夹命名**：文件夹名称将作为图集标题，建议使用有意义的名称
2. **封面图片**：可选，建议使用 `cover.jpg` 作为封面，提升视觉效果
3. **图片格式**：确保图片格式在支持的列表中
4. **权限问题**：确保脚本有权限访问所有目录
5. **数据库备份**：建议在运行前备份数据库

## 自动设置封面

脚本会自动为没有封面的图集设置封面：

1. **有图片的图集**：使用第一张图片作为封面
2. **没有图片的父图集**：递归查找第一个有封面的子图集，使用其封面

### 示例
- `weibo_images/2020/05/image1.jpg` → `05` 图集使用 `image1.jpg` 作为封面
- `weibo_images/2020` (无图片) → 使用子图集 `05` 的封面
- `weibo_images` (无图片) → 递归使用子图集 `05` 的封面

这样确保所有图集（包括父图集）都有封面，提升视觉效果。

## ID冲突问题解决

### 问题描述
不同图集下可能存在相同的年份/日期子文件夹，如：
- `weibo_images/2020/05`
- `其他图集/2020/05`

### 解决方案
使用 `父图集ID-子文件夹名` 格式生成唯一ID：
- `weibo_images/2020/05` → `weibo_images-2020-05`
- `其他图集/2020/05` → `其他图集-2020-05`

这样确保了不同图集下的同名子文件夹不会冲突。

## 与 Django 命令的区别

### Django 原生命令
```bash
python manage.py sync_gallery_from_folder
```

### 本脚本
```bash
python3 tools/auto_sync_gallery.py
```

**主要区别**：
- 本脚本会删除不存在的图集记录
- 本脚本提供更详细的统计信息
- 本脚本可以独立运行，无需进入 Django 项目目录

## 故障排除

### 权限错误
```
错误: 无法访问目录 xxx: Permission denied
```
**解决方案**：检查文件夹权限，确保脚本有读取权限

### 路径错误
```
错误: 图集目录不存在: xxx
```
**解决方案**：检查 `MEDIA_ROOT` 配置是否正确

### 数据库错误
```
OperationalError: no such table: gallery
```
**解决方案**：运行数据库迁移
```bash
cd /home/yifeianyi/Desktop/xxm_fans_home/repo/xxm_fans_backend
python manage.py migrate gallery
```

## 最佳实践

1. **定期同步**：每次添加新图集后都运行此脚本
2. **批量添加**：可以一次性添加多个图集，然后统一同步
3. **验证结果**：同步后检查统计信息，确保数据正确
4. **备份数据**：定期备份数据库，防止数据丢失

## 扩展功能

脚本可以根据需要进行扩展，例如：
- 添加图片压缩功能
- 自动生成封面缩略图
- 支持更多图片格式
- 添加图片水印
- 批量重命名文件